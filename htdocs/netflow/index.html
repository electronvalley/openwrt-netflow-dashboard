<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Netflow by Ealison</title>
<style>
:root{--bg:#0a0e17;--surface:#111827;--surface2:#1a2236;--border:#1e293b;--text-bright:#e2e8f0;--text-muted:#64748b;--accent1:#06b6d4;--accent2:#8b5cf6;--accent3:#f59e0b;--warn:#f59e0b;--danger:#ef4444;--success:#10b981;}
[data-theme="light"]{--bg:#f0f4f8;--surface:#ffffff;--surface2:#e8edf2;--border:#cbd5e1;--text-bright:#1e293b;--text-muted:#64748b;--accent1:#0891b2;--accent2:#7c3aed;--accent3:#d97706;--warn:#d97706;--danger:#dc2626;--success:#059669;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text-bright);font-family:'Segoe UI',system-ui,-apple-system,sans-serif;overflow:hidden;height:100vh;}
#loginOverlay{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:16px;}
#loginOverlay h1{font-size:28px;background:linear-gradient(135deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px;}
#loginOverlay .ver{font-size:11px;color:var(--text-muted);margin-top:-8px;}
#loginOverlay input{padding:10px 16px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text-bright);width:260px;font-size:14px;}
#loginOverlay button{padding:10px 32px;border-radius:8px;border:none;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;cursor:pointer;font-size:14px;font-weight:600;}
#loginOverlay .err{color:var(--danger);font-size:12px;min-height:18px;}
header{display:flex;align-items:center;padding:6px 16px;background:var(--surface);border-bottom:1px solid var(--border);gap:12px;height:44px;z-index:100;position:relative;}
header .logo{font-weight:700;font-size:16px;background:linear-gradient(135deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap;}
.wan-badge{display:flex;align-items:center;gap:8px;padding:3px 12px;background:var(--surface2);border-radius:6px;font-size:11px;border:1px solid var(--border);}
.wan-badge .dot{width:7px;height:7px;border-radius:50%;background:var(--success);flex-shrink:0;}
.wan-badge .dot.down{background:var(--danger);}
.stat-group{display:flex;gap:14px;align-items:center;margin-left:auto;}
.stat-item{text-align:center;}
.stat-item .val{font-size:13px;font-weight:700;color:var(--accent1);}
.stat-item .lbl{font-size:9px;color:var(--text-muted);text-transform:uppercase;}
.hdr-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text-bright);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;display:flex;align-items:center;gap:4px;white-space:nowrap;}
.hdr-btn:hover{border-color:var(--accent1);}
#clock{font-size:11px;color:var(--text-muted);font-variant-numeric:tabular-nums;white-space:nowrap;}
.main-area{display:flex;flex-direction:column;height:calc(100vh - 44px);}
#topoWrap{flex:1;position:relative;overflow:hidden;background:var(--bg);}
#topoCanvas{width:100%;height:100%;display:block;}
.alert-panel{position:absolute;top:8px;right:8px;width:280px;max-height:50%;overflow-y:auto;display:flex;flex-direction:column;gap:6px;z-index:10;pointer-events:none;}
.alert-card{pointer-events:auto;padding:8px 10px;border-radius:8px;background:var(--surface);border-left:3px solid var(--warn);font-size:11px;line-height:1.4;box-shadow:0 2px 8px rgba(0,0,0,0.3);animation:fadeIn 0.3s;}
.alert-card.critical{border-left-color:var(--danger);}
.alert-card .alert-title{font-weight:700;color:var(--warn);margin-bottom:2px;}
.alert-card.critical .alert-title{color:var(--danger);}
.alert-card .alert-msg{color:var(--text-muted);}
.alert-card .alert-time{color:var(--text-muted);font-size:9px;margin-top:3px;}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.bottom-panel{background:var(--surface);border-top:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;min-height:180px;height:260px;}
.drag-handle{height:5px;background:var(--border);cursor:ns-resize;flex-shrink:0;}
.drag-handle:hover{background:var(--accent1);}
.panel-header{display:flex;align-items:center;padding:6px 12px;gap:10px;border-bottom:1px solid var(--border);flex-shrink:0;}
.panel-tabs{display:flex;gap:2px;}
.panel-tab{padding:4px 12px;border-radius:6px;cursor:pointer;font-size:11px;color:var(--text-muted);background:transparent;border:none;}
.panel-tab.active{background:var(--surface2);color:var(--text-bright);font-weight:600;}
.search-box{margin-left:auto;padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text-bright);font-size:11px;width:180px;}
.device-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:8px;padding:10px 12px;overflow-y:auto;flex:1;}
.dev-card{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;transition:border-color 0.2s,transform 0.15s;position:relative;}
.dev-card:hover{border-color:var(--accent1);transform:translateY(-1px);}
.dev-card .card-top{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.dev-card .dev-icon{font-size:20px;width:28px;text-align:center;flex-shrink:0;}
.dev-card .dev-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.dev-card .dev-ip{font-size:10px;color:var(--text-muted);}
.dev-card .card-stats{display:flex;gap:10px;font-size:10px;color:var(--text-muted);margin-bottom:6px;}
.dev-card .card-stats span{display:flex;align-items:center;gap:3px;}
.dev-card .card-stats .up{color:var(--accent3);}
.dev-card .card-stats .dn{color:var(--accent1);}
.dev-card .spark-row{height:24px;position:relative;}
.dev-card .spark-row canvas{width:100%;height:100%;}
.dev-card .port-badges{display:flex;flex-wrap:wrap;gap:3px;margin-top:4px;}
.dev-card .port-badge{padding:1px 5px;border-radius:3px;font-size:9px;background:rgba(6,182,212,0.15);color:var(--accent1);border:1px solid rgba(6,182,212,0.25);}
.dev-card .type-badge{position:absolute;top:6px;right:8px;font-size:9px;padding:1px 6px;border-radius:4px;background:rgba(139,92,246,0.15);color:var(--accent2);border:1px solid rgba(139,92,246,0.2);}
.dev-card .iface-badge{font-size:9px;padding:1px 6px;border-radius:4px;background:rgba(245,158,11,0.12);color:var(--accent3);border:1px solid rgba(245,158,11,0.2);}
.dev-card.offline{opacity:0.5;}
.iface-section{grid-column:1/-1;font-size:11px;font-weight:700;color:var(--accent3);padding:4px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px;}
.iface-section .iface-icon{font-size:14px;}
.dns-panel{display:none;flex:1;overflow-y:auto;padding:10px 12px;}
.dns-panel.active{display:block;}
.dns-entry{display:flex;align-items:center;gap:10px;padding:5px 8px;border-bottom:1px solid var(--border);font-size:11px;}
.dns-entry .dns-time{color:var(--text-muted);min-width:60px;font-variant-numeric:tabular-nums;}
.dns-entry .dns-ip{color:var(--accent2);min-width:110px;}
.dns-entry .dns-domain{color:var(--text-bright);word-break:break-all;}
.dns-entry .dns-type{color:var(--accent3);min-width:35px;font-size:10px;}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:5000;align-items:center;justify-content:center;}
.modal-overlay.active{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:520px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;}
.modal-head{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);gap:10px;}
.modal-head .m-icon{font-size:24px;}
.modal-head .m-title{font-size:15px;font-weight:700;flex:1;}
.modal-head .m-close{background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer;padding:2px 6px;}
.modal-tabs{display:flex;border-bottom:1px solid var(--border);}
.modal-tab{flex:1;padding:8px;text-align:center;font-size:11px;cursor:pointer;color:var(--text-muted);border:none;background:none;}
.modal-tab.active{color:var(--accent1);border-bottom:2px solid var(--accent1);font-weight:600;}
.modal-body{overflow-y:auto;flex:1;}
.modal-section{padding:12px 16px;}
.modal-section h3{font-size:12px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;}
.m-row{display:flex;justify-content:space-between;padding:4px 0;font-size:12px;border-bottom:1px solid var(--border);}
.m-row .m-label{color:var(--text-muted);}
.m-row .m-val{font-weight:600;}
.m-input{width:100%;padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text-bright);font-size:12px;margin-top:4px;}
.m-select{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text-bright);font-size:12px;margin-top:4px;}
.m-btn{padding:6px 14px;border-radius:6px;border:none;font-size:11px;cursor:pointer;font-weight:600;}
.m-btn.danger{background:rgba(239,68,68,0.15);color:var(--danger);}
.m-btn.danger:hover{background:rgba(239,68,68,0.3);}
.m-btn.primary{background:rgba(6,182,212,0.15);color:var(--accent1);}
.m-dns-list{max-height:200px;overflow-y:auto;}
.dropdown{position:relative;display:inline-block;}
.dropdown-content{display:none;position:absolute;top:100%;right:0;background:var(--surface);border:1px solid var(--border);border-radius:8px;min-width:200px;z-index:200;box-shadow:0 8px 24px rgba(0,0,0,0.4);padding:4px;margin-top:4px;}
.dropdown-content.show{display:block;}
.dropdown-content a{display:flex;align-items:center;gap:8px;padding:6px 10px;color:var(--text-bright);text-decoration:none;font-size:11px;border-radius:4px;}
.dropdown-content a:hover{background:var(--surface2);}
.dropdown-content .sep{height:1px;background:var(--border);margin:4px 0;}
.theme-bar{display:flex;gap:4px;padding:6px 10px;}
.theme-dot{width:18px;height:18px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:border-color 0.2s;}
.theme-dot:hover,.theme-dot.active{border-color:var(--text-bright);}
</style>
</head>
<body>
<div id="loginOverlay">
<h1>Netflow by Ealison</h1>
<div class="ver">v5.3.1</div>
<input type="password" id="loginPass" placeholder="Router password" autofocus>
<button onclick="doLogin()">Connect</button>
<div class="err" id="loginErr"></div>
</div>
<div id="dashboard" style="display:none">
<header>
<div class="logo">Netflow by Ealison</div>
<div class="wan-badge" id="wanBadge"><div class="dot" id="wanDot"></div><span id="wanLabel">WAN</span></div>
<div class="stat-group">
<div class="stat-item"><div class="val" id="statDown">0 B/s</div><div class="lbl">Down</div></div>
<div class="stat-item"><div class="val" id="statUp">0 B/s</div><div class="lbl">Up</div></div>
<div class="stat-item"><div class="val" id="statDevices">0</div><div class="lbl">Devices</div></div>
<div class="stat-item"><div class="val" id="statConns">0</div><div class="lbl">Conns</div></div>
</div>
<div class="dropdown">
<button class="hdr-btn" onclick="togglePanel('security')">&#x1F6E1; Security</button>
<div class="dropdown-content" id="securityMenu">
<a href="javascript:void(0)" onclick="location.href='/cgi-bin/luci/admin/network/firewall'">&#x1F525; Firewall</a>
<a href="javascript:void(0)" onclick="location.href='/cgi-bin/luci/admin/network/firewall/rules'">&#x1F4CB; FW Rules</a>
<a href="javascript:void(0)" onclick="location.href='/cgi-bin/luci/admin/services/adblock'">&#x1F6AB; AdBlock</a>
<a href="javascript:void(0)" onclick="location.href='/cgi-bin/luci/admin/network/dhcp'">&#x1F310; DHCP/DNS</a>
<a href="javascript:void(0)" onclick="location.href='/cgi-bin/luci/admin/system/admin'">&#x1F512; Admin</a>
<a href="javascript:void(0)" onclick="location.href='/cgi-bin/luci/admin/status/routes'">&#x1F5FA; Routes</a>
<div class="sep"></div>
<a href="javascript:void(0)" onclick="location.href='/cgi-bin/luci/admin/network/wireless'">&#x1F4F6; Wireless</a>
<a href="javascript:void(0)" onclick="location.href='/cgi-bin/luci/admin/status/overview'">&#x1F4CA; Overview</a>
</div>
</div>
<div class="dropdown">
<button class="hdr-btn" onclick="togglePanel('theme')">&#x1F3A8; Theme</button>
<div class="dropdown-content" id="themeMenu">
<div class="theme-bar" id="themeBar"></div>
</div>
</div>
<button class="hdr-btn" onclick="toggleDns()">&#x1F4D6; DNS</button>
<button class="hdr-btn" onclick="document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()">&#x26F6;</button>
<div id="clock"></div>
</header>
<div class="main-area">
<div id="topoWrap"><canvas id="topoCanvas"></canvas>
<div class="alert-panel" id="alertPanel"></div>
</div>
<div class="bottom-panel" id="bottomPanel">
<div class="drag-handle" id="dragHandle"></div>
<div class="panel-header">
<div class="panel-tabs">
<button class="panel-tab active" onclick="switchTab('devices')">Devices</button>
<button class="panel-tab" onclick="switchTab('dns')">DNS History</button>
</div>
<input class="search-box" id="searchBox" placeholder="Search devices..." oninput="renderDevices()">
</div>
<div class="device-grid" id="deviceGrid"></div>
<div class="dns-panel" id="dnsPanel"></div>
</div>
</div>
</div>
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)this.classList.remove('active')">
<div class="modal">
<div class="modal-head">
<span class="m-icon" id="mIcon"></span>
<span class="m-title" id="mTitle"></span>
<button class="m-close" onclick="document.getElementById('modalOverlay').classList.remove('active')">&times;</button>
</div>
<div class="modal-tabs">
<button class="modal-tab active" onclick="showModalTab('info')">Info</button>
<button class="modal-tab" onclick="showModalTab('traffic')">Traffic</button>
<button class="modal-tab" onclick="showModalTab('dns')">DNS</button>
<button class="modal-tab" onclick="showModalTab('actions')">Actions</button>
</div>
<div class="modal-body">
<div class="modal-section" id="mInfo"></div>
<div class="modal-section" id="mTraffic" style="display:none"></div>
<div class="modal-section" id="mDns" style="display:none"></div>
<div class="modal-section" id="mActions" style="display:none"></div>
</div>
</div>
</div>
<script>
'use strict';
const BASE='/cgi-bin/luci';
let sid='',devices=[],alerts=[],wanInfo={up:false,ip:'',rx:0,tx:0,speed_down:0,speed_up:0},dnsLog=[];
let particles=[],customNames={},customTypes={},prevDevData={},wanPrev=null,sparkHistory={};
let sortBy='interface',activeTab='devices',modalDev=null;
const PORT_NAMES={21:'FTP',22:'SSH',23:'Telnet',25:'SMTP',53:'DNS',67:'DHCP',80:'HTTP',110:'POP3',143:'IMAP',443:'HTTPS',445:'SMB',993:'IMAPS',995:'POP3S',
  1080:'SOCKS',1194:'OpenVPN',1883:'MQTT',3306:'MySQL',3389:'RDP',5060:'SIP',5353:'mDNS',5900:'VNC',6881:'BitTorrent',8080:'HTTP-Alt',8443:'HTTPS-Alt',8883:'MQTTS',
  9100:'Print',51820:'WireGuard',1900:'UPnP',548:'AFP'};
const SUSPICIOUS_PORTS=[23,445,3389,5900,1080,6881,4444,5555,6666,6667,31337,12345];
const OUI_HINTS={
  'apple':['00:1C:B3','3C:E0:72','A4:83:E7','F0:18:98','AC:DE:48','14:7D:DA','DC:A9:04','78:7E:61','F8:FF:C2','BC:D0:74','70:EC:E4','38:F9:D3','E0:B5:5F'],
  'samsung':['00:1A:8A','34:23:BA','50:01:D9','8C:F5:A3','C0:BD:D1','E4:7C:F9','84:25:DB','B0:72:BF','CC:3A:61','F8:D0:BD'],
  'amazon':['FC:65:DE','44:65:0D','68:54:FD','A0:02:DC','AC:63:BE','40:A2:DB','74:C2:46','B4:7C:9C'],
  'google':['30:FD:38','54:60:09','F4:F5:D8','A4:77:33','48:D6:D5','20:DF:B9'],
  'huawei':['00:E0:FC','48:46:FB','70:8C:B6','88:28:B3','CC:A2:23','04:F9:38'],
  'xiaomi':['28:6C:07','50:64:2B','78:11:DC','64:CC:2E','7C:1C:68','AC:C1:EE'],
  'tp-link':['50:C7:BF','60:A4:4C','B0:4E:26','C0:06:C3','1C:3B:F3'],
  'intel':['00:1B:21','3C:97:0E','68:17:29','8C:8D:28','A4:34:D9','B4:D5:BD'],
  'realtek':['00:E0:4C','52:54:00'],
  'roku':['DC:3A:5E','B0:A7:37','AC:3A:7A'],
  'sonos':['00:0E:58','54:2A:1B','B8:E9:37','78:28:CA'],
  'lg':['00:1C:62','20:3D:BD','34:4D:F7','58:A2:B5','CC:2D:8C'],
  'sony':['00:13:A9','00:1A:80','AC:9B:0A','FC:F1:52'],
  'microsoft':['00:15:5D','00:50:F2','28:18:78','7C:1E:52','DC:B4:C4'],
  'hp':['00:1E:0B','3C:D9:2B','64:51:06','94:57:A5'],
  'raspberry':['B8:27:EB','DC:A6:32','E4:5F:01','28:CD:C1','D8:3A:DD'],
  'espressif':['24:0A:C4','30:AE:A4','84:CC:A8','A4:CF:12','AC:67:B2','08:3A:F2','EC:94:CB','48:E7:29','C8:2B:96'],
  'tuya':['D8:1F:12','10:D5:61'],
  'ring':['34:3E:A4','50:85:69'],
  'nest':['18:B4:30','64:16:66'],
  'synology':['00:11:32']
};
const DEV_ICONS={phone:'\u{1F4F1}',tablet:'\u{1F4F1}',laptop:'\u{1F4BB}',desktop:'\u{1F5A5}',tv:'\u{1F4FA}',speaker:'\u{1F50A}',printer:'\u{1F5A8}',camera:'\u{1F4F7}',iot:'\u{1F4A1}',gaming:'\u{1F3AE}',server:'\u{1F5A5}',nas:'\u{1F4BE}',router:'\u{1F310}',watch:'\u{231A}',unknown:'\u{1F4BB}'};
function guessDeviceType(d){
  if(customTypes[d.mac])return customTypes[d.mac];
  const mac=d.mac.toUpperCase();const hn=(d.hostname||'').toLowerCase();const ports=d.ports||[];
  for(const[brand,prefixes]of Object.entries(OUI_HINTS)){
    if(prefixes.some(p=>mac.startsWith(p))){
      if(brand==='apple'){if(hn.includes('iphone'))return'phone';if(hn.includes('ipad'))return'tablet';if(hn.includes('macbook'))return'laptop';if(hn.includes('imac'))return'desktop';if(hn.includes('appletv'))return'tv';if(hn.includes('homepod'))return'speaker';return'phone';}
      if(brand==='samsung'){if(hn.includes('tv'))return'tv';if(hn.includes('galaxy')||hn.includes('sm-'))return'phone';return'phone';}
      if(brand==='amazon'){if(hn.includes('echo'))return'speaker';if(hn.includes('fire'))return'tablet';return'iot';}
      if(brand==='google'){if(hn.includes('home')||hn.includes('nest'))return'speaker';if(hn.includes('chromecast'))return'tv';return'iot';}
      if(brand==='roku')return'tv';if(brand==='sonos')return'speaker';
      if(brand==='lg'||brand==='sony')return hn.includes('tv')?'tv':'unknown';
      if(brand==='microsoft'||brand==='intel')return hn.includes('xbox')?'gaming':'desktop';
      if(brand==='hp')return ports.includes(9100)?'printer':'desktop';
      if(brand==='raspberry'||brand==='synology')return'server';
      if(brand==='espressif'||brand==='tuya')return'iot';
      if(brand==='ring')return'camera';if(brand==='nest')return'iot';
      if(brand==='xiaomi')return hn.includes('redmi')||hn.includes('poco')?'phone':'iot';
      if(brand==='huawei')return'phone';
      if(brand==='tp-link')return'iot';if(brand==='realtek')return'desktop';
    }
  }
  if(hn.includes('iphone')||hn.includes('android')||hn.includes('galaxy')||hn.includes('pixel')||hn.includes('huawei'))return'phone';
  if(hn.includes('ipad')||hn.includes('tab'))return'tablet';
  if(hn.includes('laptop')||hn.includes('macbook'))return'laptop';
  if(hn.includes('desktop')||hn.includes('pc'))return'desktop';
  if(hn.includes('tv')||hn.includes('roku')||hn.includes('chromecast'))return'tv';
  if(hn.includes('printer')||hn.includes('print')||ports.includes(9100))return'printer';
  if(hn.includes('camera')||hn.includes('cam'))return'camera';
  if(hn.includes('echo')||hn.includes('homepod')||hn.includes('sonos'))return'speaker';
  if(hn.includes('esp')||hn.includes('tasmota')||hn.includes('shelly')||hn.includes('tuya'))return'iot';
  if(hn.includes('xbox')||hn.includes('playstation')||hn.includes('ps5'))return'gaming';
  if(hn.includes('nas')||hn.includes('synology'))return'nas';
  if(hn.includes('pi')||hn.includes('rasp')||hn.includes('server'))return'server';
  return'unknown';
}
function getColor(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
function fmtB(b){if(b>=1e9)return(b/1e9).toFixed(1)+'G';if(b>=1e6)return(b/1e6).toFixed(1)+'M';if(b>=1e3)return(b/1e3).toFixed(1)+'K';return Math.round(b)+'B';}
function fmtSpeed(b){return fmtB(b)+'/s';}
async function doLogin(){
  const pw=document.getElementById('loginPass').value;
  const errEl=document.getElementById('loginErr');
  try{
    const r=await fetch(BASE+'/admin/ubus',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({jsonrpc:'2.0',id:1,method:'call',params:['00000000000000000000000000000000','session','login',{username:'root',password:pw}]})});
    const j=await r.json();
    if(j.result&&j.result[0]===0){
      sid=j.result[1].ubus_rpc_session;
      document.getElementById('loginOverlay').style.display='none';
      document.getElementById('dashboard').style.display='';
      startDashboard();
    }else{errEl.textContent='Invalid password';}
  }catch(e){errEl.textContent='Connection error: '+e.message;}
}
document.getElementById('loginPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
async function ubus(obj,method,params={}){
  try{
    const r=await fetch(BASE+'/admin/ubus',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({jsonrpc:'2.0',id:Date.now(),method:'call',params:[sid,obj,method,params]})});
    const j=await r.json();return(j.result&&j.result[0]===0)?j.result[1]:{};
  }catch(e){return{};}
}
function togglePanel(name){
  const el=document.getElementById(name+'Menu');
  document.querySelectorAll('.dropdown-content.show').forEach(d=>{if(d!==el)d.classList.remove('show');});
  el.classList.toggle('show');
}
function toggleDns(){
  const dp=document.getElementById('dnsPanel');
  if(dp.classList.contains('active')){dp.classList.remove('active');document.getElementById('deviceGrid').style.display='';}
  else{dp.classList.add('active');document.getElementById('deviceGrid').style.display='none';fetchDnsLog();}
}
function switchTab(tab){
  activeTab=tab;
  document.querySelectorAll('.panel-tab').forEach(t=>t.classList.remove('active'));
  if(event&&event.target)event.target.classList.add('active');
  if(tab==='devices'){document.getElementById('deviceGrid').style.display='';document.getElementById('dnsPanel').classList.remove('active');}
  else{document.getElementById('deviceGrid').style.display='none';document.getElementById('dnsPanel').classList.add('active');fetchDnsLog();}
}
document.addEventListener('click',e=>{if(!e.target.closest('.dropdown'))document.querySelectorAll('.dropdown-content.show').forEach(d=>d.classList.remove('show'));});
async function fetchData(){
  const [net,dhcpR,ctR,wifiDevs]=await Promise.all([
    ubus('network.interface','dump'),
    ubus('luci-rpc','getDHCPLeases'),
    ubus('luci','getConntrackList'),
    ubus('luci-rpc','getWirelessDevices')
  ]);
  // WAN info
  const wIf=(net.interface||[]).find(i=>i.interface==='wan')||{};
  const wUp=wIf.up||false;
  const wIP=(wIf['ipv4-address']&&wIf['ipv4-address'][0])?wIf['ipv4-address'][0].address:'';
  const wDev=wIf.l3_device||wIf.device||'wan';
  let wRx=0,wTx=0;
  try{
    const devStat=await ubus('network.device','status',{name:wDev});
    if(devStat&&devStat.statistics){wRx=devStat.statistics.rx_bytes||0;wTx=devStat.statistics.tx_bytes||0;}
  }catch(e){}
  const now=Date.now();
  let wSpDown=0,wSpUp=0;
  if(wanPrev&&wanPrev.t){
    const dt=(now-wanPrev.t)/1000;
    if(dt>0&&dt<30){wSpDown=Math.max(0,(wRx-wanPrev.rx)/dt);wSpUp=Math.max(0,(wTx-wanPrev.tx)/dt);if(wRx<wanPrev.rx)wSpDown=0;if(wTx<wanPrev.tx)wSpUp=0;}
  }
  wanPrev={rx:wRx,tx:wTx,t:now};
  wanInfo={up:wUp,ip:wIP,rx:wRx,tx:wTx,speed_down:wSpDown,speed_up:wSpUp};
  document.getElementById('wanDot').className='dot'+(wUp?'':' down');
  document.getElementById('wanLabel').textContent='WAN '+(wIP||'--');
  document.getElementById('statDown').textContent=fmtSpeed(wSpDown);
  document.getElementById('statUp').textContent=fmtSpeed(wSpUp);
  // DHCP leases - from luci-rpc getDHCPLeases
  const leaseMap={};
  const leases=dhcpR.dhcp_leases||[];
  leases.forEach(l=>{leaseMap[l.ipaddr]={mac:(l.macaddr||'').toUpperCase(),hostname:l.hostname||''};});
  // Conntrack - result is nested in .result property
  const connMap={};const portMap={};
  const ctList=(ctR&&ctR.result)?ctR.result:(Array.isArray(ctR)?ctR:[]);
  ctList.forEach(c=>{
    const src=c.src;const dst=c.dst;const dp=c.dport?parseInt(c.dport):0;const sp=c.sport?parseInt(c.sport):0;
    [src,dst].forEach(ip=>{
      if(ip&&ip.startsWith('192.168.')){
        if(!connMap[ip])connMap[ip]=[];connMap[ip].push(c);
        if(!portMap[ip])portMap[ip]=new Set();
        if(dp>0)portMap[ip].add(dp);
      }
    });
  });
  // WiFi associations - get from luci-rpc getWirelessDevices + iwinfo assoclist
  const wifiClients={};
  if(wifiDevs){
    for(const[radioName,radioInfo]of Object.entries(wifiDevs)){
      if(radioInfo&&radioInfo.interfaces){
        for(const iface of radioInfo.interfaces){
          const ifname=iface.ifname;
          if(!ifname)continue;
          const ssid=iface.config?.ssid||iface.iwinfo?.ssid||ifname;
          const freq=iface.iwinfo?.frequency||iface.config?.channel||0;
          const band=freq>4900?'5GHz':'2.4GHz';
          const label=ssid+' ('+band+')';
          try{
            const assocData=await ubus('iwinfo','assoclist',{device:ifname});
            const clients=assocData.results||[];
            clients.forEach(c=>{
              const mac=(c.mac||'').toUpperCase();
              wifiClients[mac]={iface:label,isWifi:true,signal:c.signal||0,noise:c.noise||0,
                rx_bytes:(c.rx&&c.rx.bytes)||0,tx_bytes:(c.tx&&c.tx.bytes)||0};
            });
          }catch(e){}
        }
      }
    }
  }
  // Build devices
  const newDevices=[];
  const allIPs=new Set([...Object.keys(leaseMap),...Object.keys(connMap)]);
  allIPs.forEach(ip=>{
    const lease=leaseMap[ip]||{};
    const mac=(lease.mac||'').toUpperCase();
    const hostname=lease.hostname||'';
    const conns=connMap[ip]||[];
    const ports=portMap[ip]?Array.from(portMap[ip]):[];
    const wc=wifiClients[mac];
    const iface=wc?wc.iface:'Ethernet (br-lan)';
    const isWifi=wc?true:false;
    let rxB=0,txB=0;
    if(wc){rxB=wc.rx_bytes;txB=wc.tx_bytes;}
    else{conns.forEach(c=>{rxB+=(parseInt(c.bytes)||0);txB+=(parseInt(c.reply_bytes)||0);});}
    let bwDown=0,bwUp=0;
    const prev=prevDevData[ip];
    if(prev&&prev.t){const dt=(now-prev.t)/1000;if(dt>0&&dt<30){bwDown=Math.max(0,(rxB-prev.rx)/dt);bwUp=Math.max(0,(txB-prev.tx)/dt);if(rxB<prev.rx)bwDown=0;if(txB<prev.tx)bwUp=0;}}
    prevDevData[ip]={rx:rxB,tx:txB,t:now};
    if(!sparkHistory[ip])sparkHistory[ip]=[];
    sparkHistory[ip].push({d:bwDown,u:bwUp});
    if(sparkHistory[ip].length>30)sparkHistory[ip].shift();
    const online=conns.length>0||isWifi;
    const d={ip,mac,hostname,iface,isWifi,online,conns,ports,rx:rxB,tx:txB,bw_down:bwDown,bw_up:bwUp,signal:wc?wc.signal:null};
    d.type=guessDeviceType(d);
    newDevices.push(d);
  });
  devices=newDevices;
  document.getElementById('statDevices').textContent=devices.filter(d=>d.online).length||devices.length;
  document.getElementById('statConns').textContent=ctList.length;
  checkAlerts();renderDevices();drawTopology();
}
function checkAlerts(){
  devices.forEach(d=>{
    if(d.conns.length>100)addAlert('warn','High Connections',(customNames[d.mac]||d.hostname||d.ip)+': '+d.conns.length+' conns');
    if(d.bw_down>5e6)addAlert('warn','High Bandwidth',(customNames[d.mac]||d.hostname||d.ip)+' DL '+fmtSpeed(d.bw_down));
    if(d.bw_up>2e6)addAlert('warn','High Upload',(customNames[d.mac]||d.hostname||d.ip)+' UL '+fmtSpeed(d.bw_up));
    d.ports.forEach(p=>{if(SUSPICIOUS_PORTS.includes(p))addAlert('critical','Suspicious Port','Port '+p+' ('+(PORT_NAMES[p]||'?')+') on '+(customNames[d.mac]||d.hostname||d.ip));});
  });
}
function addAlert(level,title,msg){
  const key=title+msg;if(alerts.find(a=>a.key===key&&(Date.now()-a.time<120000)))return;
  alerts.unshift({level,title,msg,time:Date.now(),key});if(alerts.length>20)alerts.pop();renderAlerts();
}
function renderAlerts(){
  document.getElementById('alertPanel').innerHTML=alerts.slice(0,8).map(a=>{
    const cls=a.level==='critical'?'alert-card critical':'alert-card';
    return '<div class="'+cls+'"><div class="alert-title">'+(a.level==='critical'?'\u26A0 ':'')+a.title+'</div><div class="alert-msg">'+a.msg+'</div><div class="alert-time">'+Math.round((Date.now()-a.time)/1000)+'s ago</div></div>';
  }).join('');
}
function renderDevices(){
  const grid=document.getElementById('deviceGrid');
  const search=(document.getElementById('searchBox').value||'').toLowerCase();
  let devs=[...devices];
  if(search)devs=devs.filter(d=>(d.hostname+d.ip+d.mac+(customNames[d.mac]||'')).toLowerCase().includes(search));
  const groups={};
  devs.forEach(d=>{const g=d.iface||'Unknown';if(!groups[g])groups[g]=[];groups[g].push(d);});
  const ifNames=Object.keys(groups).sort((a,b)=>{
    const aw=a.includes('GHz')||a.includes('WiFi');const bw=b.includes('GHz')||b.includes('WiFi');
    if(aw&&!bw)return-1;if(!aw&&bw)return 1;return a.localeCompare(b);
  });
  let html='';
  ifNames.forEach(ifName=>{
    const icon=ifName.includes('GHz')||ifName.includes('WiFi')?'\u{1F4F6}':'\u{1F50C}';
    html+='<div class="iface-section"><span class="iface-icon">'+icon+'</span>'+ifName+' ('+groups[ifName].length+')</div>';
    groups[ifName].sort((a,b)=>(b.online?1:0)-(a.online?1:0)||(b.bw_down-a.bw_down));
    groups[ifName].forEach(d=>{
      const name=customNames[d.mac]||d.hostname||d.ip;
      const dtype=d.type||'unknown';
      const dicon=DEV_ICONS[dtype]||DEV_ICONS.unknown;
      const topPorts=d.ports.slice(0,6).map(p=>'<span class="port-badge">'+(PORT_NAMES[p]||p)+'</span>').join('');
      html+='<div class="dev-card'+(d.online?'':' offline')+'" onclick="showModal(\''+d.ip+'\')">';
      html+='<span class="type-badge">'+dtype+'</span>';
      html+='<div class="card-top"><span class="dev-icon">'+dicon+'</span><div><div class="dev-name">'+name+'</div><div class="dev-ip">'+d.ip+' &middot; '+d.mac+'</div></div></div>';
      html+='<div class="card-stats"><span class="dn">\u2B07 '+fmtSpeed(d.bw_down)+'</span><span class="up">\u2B06 '+fmtSpeed(d.bw_up)+'</span><span>\u{1F517} '+d.conns.length+'</span>';
      if(d.signal)html+='<span>\u{1F4F6} '+d.signal+'dBm</span>';
      html+='</div>';
      html+='<div class="spark-row"><canvas id="spark_'+d.ip.replace(/\./g,'_')+'" height="24"></canvas></div>';
      if(topPorts)html+='<div class="port-badges">'+topPorts+'</div>';
      html+='</div>';
    });
  });
  grid.innerHTML=html;
  devs.forEach(d=>{const cvs=document.getElementById('spark_'+d.ip.replace(/\./g,'_'));if(cvs)drawMiniSpark(cvs,sparkHistory[d.ip]||[]);});
}
function drawMiniSpark(canvas,data){
  const dpr=window.devicePixelRatio||1;const rect=canvas.getBoundingClientRect();if(rect.width===0)return;
  canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;
  const ctx=canvas.getContext('2d');ctx.setTransform(dpr,0,0,dpr,0,0);
  const W=rect.width,H=rect.height;ctx.clearRect(0,0,W,H);
  if(data.length<2)return;
  const maxVal=Math.max(1,...data.map(p=>Math.max(p.d,p.u)));
  ctx.beginPath();ctx.strokeStyle=getColor('--accent1');ctx.lineWidth=1.5;
  data.forEach((p,i)=>{const x=i/(data.length-1)*W;const y=H-p.d/maxVal*(H-2)-1;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.stroke();
  ctx.beginPath();ctx.strokeStyle=getColor('--accent3');ctx.lineWidth=1;
  data.forEach((p,i)=>{const x=i/(data.length-1)*W;const y=H-p.u/maxVal*(H-2)-1;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.stroke();
}
function drawTopology(){
  const canvas=document.getElementById('topoCanvas');const wrap=document.getElementById('topoWrap');
  const dpr=window.devicePixelRatio||1;const W=wrap.clientWidth;const H=wrap.clientHeight;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.setTransform(dpr,0,0,dpr,0,0);ctx.clearRect(0,0,W,H);
  const wanX=W*0.08,wanY=H*0.5,rtrX=W*0.25,rtrY=H*0.5;
  // WAN
  ctx.fillStyle=wanInfo.up?getColor('--success'):getColor('--danger');
  ctx.beginPath();ctx.arc(wanX,wanY,12,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=getColor('--text-bright');ctx.font='bold 11px system-ui';ctx.textAlign='center';
  ctx.fillText('WAN',wanX,wanY+28);
  ctx.font='9px system-ui';ctx.fillStyle=getColor('--text-muted');
  ctx.fillText(wanInfo.ip||'--',wanX,wanY+40);
  ctx.fillText('\u2B07'+fmtSpeed(wanInfo.speed_down),wanX,wanY+52);
  ctx.fillText('\u2B06'+fmtSpeed(wanInfo.speed_up),wanX,wanY+62);
  // Router
  ctx.fillStyle=getColor('--accent2');ctx.beginPath();ctx.arc(rtrX,rtrY,14,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=getColor('--text-bright');ctx.font='bold 11px system-ui';ctx.textAlign='center';
  ctx.fillText('\u{1F310} Router',rtrX,rtrY+32);
  drawLink(wanX,wanY,rtrX,rtrY,getColor('--accent1'),wanInfo.up?2:0.5);
  // Interfaces
  const ifaceGroups={};
  devices.forEach(d=>{const g=d.iface||'Ethernet';if(!ifaceGroups[g])ifaceGroups[g]=[];ifaceGroups[g].push(d);});
  const ifNames=Object.keys(ifaceGroups);
  if(ifNames.length===0)return;
  const ifaceX=W*0.45;
  ifNames.forEach((ifName,i)=>{
    const y=ifNames.length===1?H/2:H*0.15+i*(H*0.7/(ifNames.length-1||1));
    const isWifi=ifName.includes('GHz')||ifName.includes('WiFi')||!ifName.includes('Ethernet');
    ctx.fillStyle=isWifi?getColor('--accent3'):getColor('--accent2');
    ctx.beginPath();ctx.arc(ifaceX,y,7,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=getColor('--text-bright');ctx.font='10px system-ui';ctx.textAlign='center';
    ctx.fillText((isWifi?'\u{1F4F6} ':'\u{1F50C} ')+ifName.replace('Ethernet (br-lan)','Ethernet'),ifaceX,y-12);
    drawLink(rtrX,rtrY,ifaceX,y,isWifi?getColor('--accent3'):getColor('--accent2'),1.5);
    const devs=ifaceGroups[ifName];const devX=W*0.75;
    const spacing=Math.min(22,H*0.85/Math.max(devs.length,1));
    const startY=y-devs.length*spacing/2;
    devs.forEach((d,j)=>{
      const dy=Math.max(10,Math.min(H-10,startY+j*spacing));
      const isOn=d.online||d.conns.length>0;
      const col=isOn?getColor('--accent1'):'#444';
      ctx.fillStyle=col;ctx.beginPath();ctx.arc(devX,dy,3,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=isOn?getColor('--text-bright'):getColor('--text-muted');ctx.font='9px system-ui';ctx.textAlign='left';
      const dtype=guessDeviceType(d);const icon=DEV_ICONS[dtype]||DEV_ICONS.unknown;
      ctx.fillText(icon+' '+(customNames[d.mac]||d.hostname||d.ip).substring(0,20),devX+8,dy+3);
      const bw=d.bw_down+d.bw_up;const lw=Math.max(0.5,Math.min(3,bw/50000));
      drawLink(ifaceX,y,devX,dy,col,lw);
      if(isOn&&Math.random()<0.08){
        if(d.bw_down>0||d.conns.length>0)particles.push({x1:ifaceX,y1:y,x2:devX,y2:dy,t:0,s:0.006+Math.random()*0.01,c:getColor('--accent1')});
        if(d.bw_up>0)particles.push({x1:devX,y1:dy,x2:ifaceX,y2:y,t:0,s:0.005+Math.random()*0.008,c:getColor('--accent3')});
      }
    });
  });
  if(wanInfo.up&&Math.random()<0.12){
    particles.push({x1:wanX,y1:wanY,x2:rtrX,y2:rtrY,t:0,s:0.008+Math.random()*0.01,c:getColor('--accent1')});
    particles.push({x1:rtrX,y1:rtrY,x2:wanX,y2:wanY,t:0,s:0.006+Math.random()*0.008,c:getColor('--accent3')});
  }
  particles.forEach(p=>{p.t+=p.s;const px=p.x1+(p.x2-p.x1)*p.t,py=p.y1+(p.y2-p.y1)*p.t;ctx.fillStyle=p.c;ctx.globalAlpha=Math.max(0,1-p.t);ctx.beginPath();ctx.arc(px,py,2.5,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;});
  particles=particles.filter(p=>p.t<1);if(particles.length>300)particles=particles.slice(-200);
}
function drawLink(x1,y1,x2,y2,color,w){const ctx=document.getElementById('topoCanvas').getContext('2d');ctx.strokeStyle=color;ctx.lineWidth=w;ctx.globalAlpha=0.25;ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();ctx.globalAlpha=1;}
function showModal(ip){
  const d=devices.find(x=>x.ip===ip);if(!d)return;modalDev=d;
  const name=customNames[d.mac]||d.hostname||d.ip;const dtype=d.type||'unknown';const icon=DEV_ICONS[dtype]||DEV_ICONS.unknown;
  document.getElementById('mIcon').textContent=icon;
  document.getElementById('mTitle').textContent=name;
  let info='<h3>Device Information</h3>';
  info+='<div class="m-row"><span class="m-label">IP</span><span class="m-val">'+d.ip+'</span></div>';
  info+='<div class="m-row"><span class="m-label">MAC</span><span class="m-val">'+d.mac+'</span></div>';
  info+='<div class="m-row"><span class="m-label">Hostname</span><span class="m-val">'+(d.hostname||'--')+'</span></div>';
  info+='<div class="m-row"><span class="m-label">Interface</span><span class="m-val">'+d.iface+'</span></div>';
  info+='<div class="m-row"><span class="m-label">Type</span><span class="m-val">'+dtype+'</span></div>';
  info+='<div class="m-row"><span class="m-label">Status</span><span class="m-val">'+(d.online?'\u{1F7E2} Online':'\u{1F534} Offline')+'</span></div>';
  info+='<div class="m-row"><span class="m-label">Connections</span><span class="m-val">'+d.conns.length+'</span></div>';
  info+='<div class="m-row"><span class="m-label">Download</span><span class="m-val">'+fmtSpeed(d.bw_down)+'</span></div>';
  info+='<div class="m-row"><span class="m-label">Upload</span><span class="m-val">'+fmtSpeed(d.bw_up)+'</span></div>';
  info+='<div class="m-row"><span class="m-label">Total RX</span><span class="m-val">'+fmtB(d.rx)+'</span></div>';
  info+='<div class="m-row"><span class="m-label">Total TX</span><span class="m-val">'+fmtB(d.tx)+'</span></div>';
  if(d.signal)info+='<div class="m-row"><span class="m-label">WiFi Signal</span><span class="m-val">'+d.signal+' dBm</span></div>';
  if(d.ports.length)info+='<div class="m-row"><span class="m-label">Ports</span><span class="m-val">'+d.ports.slice(0,15).map(p=>(PORT_NAMES[p]||p)).join(', ')+'</span></div>';
  document.getElementById('mInfo').innerHTML=info;
  showModalTab('info');
  document.getElementById('modalOverlay').classList.add('active');
}
function showModalTab(tab){
  document.querySelectorAll('.modal-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.modal-section').forEach(s=>s.style.display='none');
  if(event&&event.target)event.target.classList.add('active');
  const d=modalDev;if(!d)return;
  if(tab==='info'){document.getElementById('mInfo').style.display='';document.querySelector('.modal-tab:nth-child(1)').classList.add('active');}
  else if(tab==='traffic'){
    document.getElementById('mTraffic').style.display='';document.querySelector('.modal-tab:nth-child(2)').classList.add('active');
    let h='<h3>Active Connections</h3>';const conns=d.conns.slice(0,30);
    if(!conns.length)h+='<p style="color:var(--text-muted);font-size:12px">No active connections</p>';
    else{h+='<div style="max-height:250px;overflow-y:auto">';conns.forEach(c=>{h+='<div class="m-row"><span class="m-label">'+c.dst+':'+c.dport+' ('+(PORT_NAMES[parseInt(c.dport)]||'?')+')</span><span class="m-val">'+(c.layer4||c.proto||'')+'</span></div>';});h+='</div>';}
    document.getElementById('mTraffic').innerHTML=h;
  }else if(tab==='dns'){
    document.getElementById('mDns').style.display='';document.querySelector('.modal-tab:nth-child(3)').classList.add('active');
    const devDns=dnsLog.filter(e=>e.ip===d.ip).slice(0,50);
    let h='<h3>DNS Queries</h3>';
    if(!devDns.length)h+='<p style="color:var(--text-muted);font-size:12px">No DNS queries</p>';
    else{h+='<div class="m-dns-list">';devDns.forEach(e=>{h+='<div class="m-row"><span class="m-label">'+e.domain+'</span><span class="m-val" style="font-size:10px;color:var(--text-muted)">'+e.time+'</span></div>';});h+='</div>';}
    document.getElementById('mDns').innerHTML=h;
  }else if(tab==='actions'){
    document.getElementById('mActions').style.display='';document.querySelector('.modal-tab:nth-child(4)').classList.add('active');
    let h='<h3>Customize</h3>';
    h+='<div style="margin-bottom:12px"><label style="font-size:11px;color:var(--text-muted)">Display Name</label>';
    h+='<input class="m-input" id="mNameInput" value="'+(customNames[d.mac]||d.hostname||'')+'" placeholder="Custom name"></div>';
    h+='<div style="margin-bottom:12px"><label style="font-size:11px;color:var(--text-muted)">Device Type</label>';
    h+='<select class="m-select" id="mTypeSelect">';
    Object.keys(DEV_ICONS).forEach(t=>{h+='<option value="'+t+'"'+(t===(customTypes[d.mac]||d.type)?' selected':'')+'>'+DEV_ICONS[t]+' '+t+'</option>';});
    h+='</select></div>';
    h+='<button class="m-btn primary" onclick="saveCustom()">Save</button>';
    h+='<h3 style="margin-top:16px">Actions</h3>';
    h+='<button class="m-btn danger" onclick="toggleBlock(\''+d.mac+'\',\''+d.ip+'\')">\u{1F6AB} Block</button>';
    document.getElementById('mActions').innerHTML=h;
  }
}
function saveCustom(){
  if(!modalDev)return;
  const n=document.getElementById('mNameInput').value.trim();const t=document.getElementById('mTypeSelect').value;
  if(n)customNames[modalDev.mac]=n;else delete customNames[modalDev.mac];
  if(t&&t!=='unknown')customTypes[modalDev.mac]=t;else delete customTypes[modalDev.mac];
  try{localStorage.setItem('nf_names',JSON.stringify(customNames));localStorage.setItem('nf_types',JSON.stringify(customTypes));}catch(e){}
  renderDevices();document.getElementById('modalOverlay').classList.remove('active');
}
async function toggleBlock(mac,ip){
  if(!confirm('Block '+ip+'?'))return;
  await ubus('uci','add',{config:'firewall',type:'rule',values:{name:'Block_'+mac.replace(/:/g,''),src:'lan',src_mac:mac,dest:'wan',target:'REJECT'}});
  await ubus('uci','commit',{config:'firewall'});
  await ubus('luci','setInitAction',{name:'firewall',action:'restart'});
  addAlert('warn','Blocked',ip+' ('+mac+')');
}
async function fetchDnsLog(){
  try{const r=await fetch('/cgi-bin/dnslog');if(!r.ok)return;const text=await r.text();
    const lines=text.trim().split('\n').filter(l=>l.includes('query['));
    dnsLog=lines.map(line=>{const m=line.match(/(\S+\s+\S+\s+\S+).*?query\[(\w+)\]\s+(\S+)\s+from\s+(\S+)/);return m?{time:m[1],type:m[2],domain:m[3],ip:m[4]}:null;}).filter(Boolean).reverse();
    renderDnsPanel();
  }catch(e){}
}
function renderDnsPanel(){
  const p=document.getElementById('dnsPanel');
  if(!dnsLog.length){p.innerHTML='<p style="padding:20px;color:var(--text-muted);text-align:center">No DNS queries found.</p>';return;}
  p.innerHTML=dnsLog.slice(0,200).map(e=>'<div class="dns-entry"><span class="dns-time">'+e.time.split(' ').pop()+'</span><span class="dns-type">'+e.type+'</span><span class="dns-ip">'+e.ip+'</span><span class="dns-domain">'+e.domain+'</span></div>').join('');
                                                                }
const THEMES=[
  {name:'Cyber Dark',bg:'#0a0e17',surface:'#111827',surface2:'#1a2236',border:'#1e293b',textBright:'#e2e8f0',textMuted:'#64748b',accent1:'#06b6d4',accent2:'#8b5cf6',accent3:'#f59e0b',dot:'#06b6d4'},
  {name:'Ocean',bg:'#0b1120',surface:'#0f1729',surface2:'#162033',border:'#1e3048',textBright:'#c8e0f4',textMuted:'#5b7ea1',accent1:'#38bdf8',accent2:'#818cf8',accent3:'#fb923c',dot:'#38bdf8'},
  {name:'Matrix',bg:'#0a0f0a',surface:'#0d150d',surface2:'#112211',border:'#1a331a',textBright:'#b0f0b0',textMuted:'#4a7a4a',accent1:'#22c55e',accent2:'#86efac',accent3:'#fbbf24',dot:'#22c55e'},
  {name:'Purple Haze',bg:'#110b1e',surface:'#1a1030',surface2:'#221840',border:'#2d1f50',textBright:'#e0d4f5',textMuted:'#7a6a9a',accent1:'#c084fc',accent2:'#f472b6',accent3:'#fbbf24',dot:'#c084fc'},
  {name:'Blood',bg:'#120808',surface:'#1a0e0e',surface2:'#251515',border:'#3a1c1c',textBright:'#f0d0d0',textMuted:'#8a5555',accent1:'#ef4444',accent2:'#f97316',accent3:'#eab308',dot:'#ef4444'},
  {name:'Light',bg:'#f0f4f8',surface:'#ffffff',surface2:'#e8edf2',border:'#cbd5e1',textBright:'#1e293b',textMuted:'#64748b',accent1:'#0891b2',accent2:'#7c3aed',accent3:'#d97706',dot:'#0891b2',light:true}
];
function initThemes(){
  const bar=document.getElementById('themeBar');let saved=0;try{saved=parseInt(localStorage.getItem('nf_theme'))||0;}catch(e){}
  bar.innerHTML=THEMES.map((t,i)=>'<div class="theme-dot'+(i===saved?' active':'')+'" style="background:'+t.dot+'" onclick="applyTheme('+i+')" title="'+t.name+'"></div>').join('');
  applyTheme(saved);
}
function applyTheme(idx){
  const t=THEMES[idx]||THEMES[0];const r=document.documentElement;
  if(t.light)r.setAttribute('data-theme','light');else r.removeAttribute('data-theme');
  r.style.setProperty('--bg',t.bg);r.style.setProperty('--surface',t.surface);r.style.setProperty('--surface2',t.surface2);
  r.style.setProperty('--border',t.border);r.style.setProperty('--text-bright',t.textBright);r.style.setProperty('--text-muted',t.textMuted);
  r.style.setProperty('--accent1',t.accent1);r.style.setProperty('--accent2',t.accent2);r.style.setProperty('--accent3',t.accent3);
  document.querySelectorAll('.theme-dot').forEach((d,i)=>d.classList.toggle('active',i===idx));
  try{localStorage.setItem('nf_theme',idx);}catch(e){}
}
(function(){const h=document.getElementById('dragHandle');const p=document.getElementById('bottomPanel');let dr=false,sy=0,sh=0;
  h.addEventListener('mousedown',e=>{dr=true;sy=e.clientY;sh=p.offsetHeight;document.body.style.cursor='ns-resize';e.preventDefault();});
  document.addEventListener('mousemove',e=>{if(!dr)return;p.style.height=Math.max(100,Math.min(window.innerHeight-100,sh+(sy-e.clientY)))+'px';});
  document.addEventListener('mouseup',()=>{if(dr){dr=false;document.body.style.cursor='';}});
})();
function updateClock(){document.getElementById('clock').textContent=new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit'});}
try{customNames=JSON.parse(localStorage.getItem('nf_names'))||{};}catch(e){customNames={};}
try{customTypes=JSON.parse(localStorage.getItem('nf_types'))||{};}catch(e){customTypes={};}
let animFrame=0;
function animate(){animFrame++;if(animFrame%2===0)drawTopology();requestAnimationFrame(animate);}
function startDashboard(){initThemes();updateClock();setInterval(updateClock,1000);fetchData();setInterval(fetchData,4000);animate();fetchDnsLog();setInterval(fetchDnsLog,30000);}
</script>
</body>
</html>
