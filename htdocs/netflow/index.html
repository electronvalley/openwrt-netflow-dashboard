<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Netflow by Ealison</title>
<style>
:root{--bg:#060a14;--panel:rgba(8,14,28,0.95);--card:rgba(14,22,42,0.7);--card-hover:rgba(18,28,52,0.85);--border:rgba(255,255,255,0.06);--accent1:#00e676;--accent1-dim:rgba(0,230,118,0.1);--accent2:#448aff;--accent2-dim:rgba(68,138,255,0.1);--accent3:#ff9100;--accent3-dim:rgba(255,145,0,0.1);--text-bright:rgba(255,255,255,0.92);--text:rgba(255,255,255,0.7);--muted:rgba(255,255,255,0.35);--red:#ff5252;--purple:#b388ff;--warn-bg:rgba(255,165,0,0.12);--warn-border:rgba(255,165,0,0.5);--alert-bg:rgba(255,82,82,0.1);--alert-border:rgba(255,82,82,0.5)}
.light{--bg:#f0f2f5;--panel:rgba(255,255,255,0.97);--card:rgba(240,242,248,0.9);--card-hover:rgba(230,235,245,0.95);--border:rgba(0,0,0,0.08);--accent1:#00a152;--accent1-dim:rgba(0,161,82,0.1);--accent2:#1565c0;--accent2-dim:rgba(21,101,192,0.1);--accent3:#e65100;--accent3-dim:rgba(230,81,0,0.1);--text-bright:rgba(0,0,0,0.87);--text:rgba(0,0,0,0.65);--muted:rgba(0,0,0,0.38);--red:#d32f2f;--purple:#7b1fa2;--warn-bg:rgba(255,165,0,0.08);--warn-border:rgba(255,152,0,0.6);--alert-bg:rgba(211,47,47,0.08);--alert-border:rgba(211,47,47,0.5)}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;font-size:12px;overflow:hidden;height:100vh;display:flex;flex-direction:column;transition:background .3s,color .3s}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--muted);border-radius:3px}
#login-overlay{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center}
#login-overlay.hidden{display:none}
.login-box{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:32px;width:340px;text-align:center;box-shadow:0 0 8px rgba(68,138,255,0.12)}
.login-box h1{font-size:20px;color:var(--text-bright);margin-bottom:4px}
.login-box .subtitle{color:var(--muted);margin-bottom:20px;font-size:11px}
.login-box input{width:100%;padding:10px 12px;background:var(--card);border:1px solid var(--border);border-radius:7px;color:var(--text-bright);font-size:12px;margin-bottom:12px;outline:none}
.login-box input:focus{border-color:var(--accent2)}
.login-box button{width:100%;padding:10px;background:linear-gradient(135deg,var(--accent2),var(--purple));border:none;border-radius:7px;color:#fff;font-size:13px;font-weight:600;cursor:pointer}
.login-box .error{color:var(--red);font-size:11px;margin-top:6px;display:none}
#app{display:none;flex-direction:column;height:100vh}#app.active{display:flex}
.header{display:flex;justify-content:space-between;padding:6px 14px;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0;align-items:center;height:38px}
.header-left{display:flex;align-items:center;gap:8px}
.header-left h1{font-size:14px;color:var(--text-bright);font-weight:700}
.header-left .brand{color:var(--accent2);font-weight:400;font-size:10px;margin-left:-6px}
.header-right{display:flex;align-items:center;gap:6px;flex-wrap:nowrap}
.stat-pill{display:flex;align-items:center;gap:3px;padding:3px 8px;background:var(--card);border:1px solid var(--border);border-radius:12px;font-size:10px;white-space:nowrap}
.stat-pill .dot{width:5px;height:5px;border-radius:50%}
.stat-pill .dot.green{background:var(--accent1)}.stat-pill .dot.blue{background:var(--accent2)}.stat-pill .dot.orange{background:var(--accent3)}.stat-pill .dot.red{background:var(--red)}
.stat-pill .val{color:var(--text-bright);font-weight:600}
.btn-h{background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);font-size:14px;cursor:pointer;padding:2px 6px;position:relative;line-height:1}
.btn-h:hover{color:var(--text-bright)}
.badge{position:absolute;top:-6px;right:-6px;background:var(--red);color:#fff;font-size:8px;padding:1px 4px;border-radius:8px;font-weight:700}
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
#topo-area{flex:1;position:relative;min-height:180px}
#topoCanvas{position:absolute;inset:0;width:100%;height:100%}
#search-bar{position:absolute;top:8px;left:50%;transform:translateX(-50%);z-index:10;background:var(--card);border:1px solid var(--border);border-radius:20px;padding:5px 14px;color:var(--text-bright);font-size:11px;width:220px;outline:none}
#search-bar:focus{border-color:var(--accent2);width:280px;transition:width .3s}
#search-bar::placeholder{color:var(--muted)}
.sparkline-global{position:absolute;top:6px;right:10px;z-index:10;display:flex;gap:6px;align-items:center}
.sparkline-global canvas{border-radius:4px;background:rgba(0,0,0,0.2)}
.light .sparkline-global canvas{background:rgba(0,0,0,0.05)}
.sparkline-label{font-size:8px;color:var(--muted)}
.bottom-panel{flex-shrink:0;height:280px;background:var(--panel);border-top:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.bottom-bar{display:flex;justify-content:space-between;align-items:center;padding:4px 12px;flex-shrink:0;border-bottom:1px solid var(--border)}
.bottom-bar-left{display:flex;align-items:center;gap:10px}
.bottom-bar-left h3{font-size:11px;color:var(--text-bright);font-weight:600}
.sort-btn{background:none;border:1px solid var(--border);border-radius:4px;color:var(--muted);font-size:9px;padding:2px 8px;cursor:pointer}
.sort-btn.active{border-color:var(--accent2);color:var(--accent2)}
.resize-handle{width:100%;height:4px;cursor:ns-resize;background:transparent;flex-shrink:0}
.resize-handle:hover{background:var(--accent2);opacity:0.3}
#device-list{flex:1;overflow-y:auto;overflow-x:hidden;padding:6px 10px;display:flex;flex-wrap:wrap;gap:6px;align-content:flex-start}
.group-label{width:100%;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;padding:2px 0;border-bottom:1px solid var(--border);margin-bottom:2px}
.dev-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px 10px;width:calc(20% - 6px);min-width:230px;cursor:pointer;transition:all .2s}
.dev-card:hover{background:var(--card-hover);border-color:rgba(255,255,255,0.12)}
.light .dev-card:hover{border-color:rgba(0,0,0,0.15)}
.dev-card.alert-card{border:2px solid var(--warn-border);background:var(--warn-bg);box-shadow:0 0 10px rgba(255,165,0,0.2)}
.dev-card.alert-card-critical{border:2px solid var(--alert-border);background:var(--alert-bg);box-shadow:0 0 10px rgba(255,82,82,0.2)}
.dev-card.blocked-card{opacity:0.5;border-color:rgba(255,82,82,0.4)}
.dev-card.offline{opacity:0.45}
.dev-card-top{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.dev-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.dev-info{flex:1;min-width:0}
.dev-info .name{font-size:11px;color:var(--text-bright);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dev-info .ip{font-size:8px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dev-iface{font-size:7px;font-weight:700;padding:2px 5px;border-radius:3px;flex-shrink:0}
.iface-wifi24{background:rgba(0,230,118,0.15);color:var(--accent1)}
.iface-wifi5{background:rgba(68,138,255,0.15);color:var(--accent2)}
.iface-eth{background:rgba(255,145,0,0.15);color:var(--accent3)}
.dev-card-stats{display:flex;gap:6px;font-size:9px;margin-bottom:3px;align-items:center}
.dev-card-stats .up{color:var(--accent1)}.dev-card-stats .down{color:var(--accent2)}.dev-card-stats .total{color:var(--muted)}
.dev-card-stats canvas{border-radius:2px}
.wifi-bar{display:flex;gap:1px;align-items:flex-end;height:10px;margin-left:auto}
.wifi-bar span{width:3px;background:var(--muted);border-radius:1px;opacity:0.3}
.wifi-bar span.active{opacity:1;background:var(--accent1)}
.wifi-bar.fair span.active{background:var(--accent3)}
.wifi-bar.poor span.active{background:var(--red)}
.online-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.online-dot.on{background:var(--accent1);box-shadow:0 0 4px var(--accent1)}
.online-dot.off{background:var(--red);opacity:0.4}
.traffic-types{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:3px}
.tt-badge{font-size:7px;padding:1px 4px;border-radius:3px;font-weight:600}
.tt-https{background:rgba(0,230,118,0.15);color:#69f0ae}.light .tt-https{color:#00a152}
.tt-dns{background:rgba(68,138,255,0.15);color:#82b1ff}.light .tt-dns{color:#1565c0}
.tt-stream{background:rgba(255,145,0,0.15);color:#ffab40}.light .tt-stream{color:#e65100}
.tt-iot{background:rgba(233,30,99,0.15);color:#f48fb1}.light .tt-iot{color:#c2185b}
.tt-vpn{background:rgba(179,136,255,0.15);color:#b388ff}.light .tt-vpn{color:#7b1fa2}
.tt-other{background:rgba(255,255,255,0.06);color:var(--muted)}.light .tt-other{background:rgba(0,0,0,0.06)}
.tt-warn{background:rgba(255,165,0,0.2);color:#ff8f00;font-weight:700}
.tt-alert{background:rgba(255,82,82,0.2);color:#ff5252;font-weight:700}
.tt-port{background:rgba(100,180,255,0.12);color:var(--accent2);font-size:6px}
.dev-card-actions{display:flex;gap:4px}
.btn-sm{font-size:8px;padding:2px 6px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer}
.btn-sm:hover{color:var(--text-bright);border-color:rgba(255,255,255,0.2)}
.btn-block.active{background:rgba(255,82,82,0.2);color:var(--red);border-color:rgba(255,82,82,0.4)}
.fullscreen-btn{position:absolute;bottom:6px;left:10px;z-index:10;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--muted);font-size:10px;padding:3px 8px;cursor:pointer}
.fullscreen-btn:hover{color:var(--text-bright)}
.clock{font-size:10px;color:var(--muted);margin-left:4px}
/* Detail modal */
#detail-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center}
#detail-modal.active{display:flex}
.detail-content{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:20px;width:650px;max-width:92vw;max-height:82vh;overflow-y:auto}
.detail-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.detail-header h2{font-size:15px;color:var(--text-bright)}
.detail-close{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.detail-stat{background:var(--card);border-radius:8px;padding:10px}
.detail-stat .ds-label{font-size:9px;color:var(--muted);text-transform:uppercase;margin-bottom:2px}
.detail-stat .ds-val{font-size:16px;color:var(--text-bright);font-weight:700}
.detail-stat .ds-sub{font-size:9px;color:var(--muted)}
.detail-spark{background:var(--card);border-radius:8px;padding:8px;margin-bottom:10px}
.detail-spark canvas{width:100%;height:60px;border-radius:4px}
.detail-conns{max-height:180px;overflow-y:auto}
.detail-conns table{width:100%;font-size:9px;border-collapse:collapse}
.detail-conns th{color:var(--muted);text-align:left;padding:3px 6px;border-bottom:1px solid var(--border);font-weight:600;position:sticky;top:0;background:var(--panel)}
.detail-conns td{padding:3px 6px;border-bottom:1px solid rgba(255,255,255,0.03);color:var(--text)}
.light .detail-conns td{border-color:rgba(0,0,0,0.05)}
.detail-conns tr:hover td{background:rgba(255,255,255,0.03)}.light .detail-conns tr:hover td{background:rgba(0,0,0,0.03)}
.detail-alerts{margin-top:8px}
.da-item{display:flex;align-items:center;gap:6px;padding:5px 8px;background:var(--warn-bg);border:1px solid var(--warn-border);border-radius:6px;margin-bottom:4px;font-size:10px;color:var(--text-bright)}
.da-item.critical{background:var(--alert-bg);border-color:var(--alert-border)}
/* Edit modal */
#edit-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1001;align-items:center;justify-content:center}
#edit-modal.active{display:flex}
.edit-content{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:18px;width:300px}
.edit-content h3{font-size:13px;color:var(--text-bright);margin-bottom:12px}
.edit-content label{font-size:9px;color:var(--muted);display:block;margin-bottom:3px}
.edit-content input,.edit-content select{width:100%;padding:7px 10px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text-bright);font-size:11px;margin-bottom:10px;outline:none}
.edit-btns{display:flex;gap:8px;justify-content:flex-end}
.edit-btns button{padding:6px 14px;border-radius:6px;font-size:11px;cursor:pointer;border:1px solid var(--border)}
.edit-btns .btn-ok{background:var(--accent2);border-color:var(--accent2);color:#fff}
.edit-btns .btn-cancel{background:transparent;color:var(--muted)}
/* Alert panel */
#alert-panel{position:fixed;top:38px;right:0;width:340px;max-height:calc(100vh - 50px);background:var(--panel);border-left:1px solid var(--border);border-bottom:1px solid var(--border);border-radius:0 0 0 8px;z-index:500;display:none;flex-direction:column}
#alert-panel.active{display:flex}
.alert-panel-head{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border)}
.alert-panel-head h3{font-size:12px;color:var(--text-bright)}
.alert-panel-head button{background:none;border:none;color:var(--muted);font-size:9px;cursor:pointer}
#alert-log{flex:1;overflow-y:auto;padding:4px}
.alert-log-item{display:flex;align-items:center;gap:6px;padding:5px 8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:10px}
.light .alert-log-item{border-color:rgba(0,0,0,0.05)}
.al-icon{font-size:12px;flex-shrink:0}.al-text{flex:1;color:var(--text)}.al-time{color:var(--muted);font-size:8px;flex-shrink:0}
/* Theme panel */
#theme-panel{position:fixed;top:38px;right:0;width:210px;background:var(--panel);border-left:1px solid var(--border);border-bottom:1px solid var(--border);border-radius:0 0 0 8px;z-index:500;display:none;padding:10px}
#theme-panel.active{display:block}
.theme-btn{display:block;width:100%;padding:5px 8px;margin-bottom:3px;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:10px;cursor:pointer;text-align:left}
.theme-btn:hover{border-color:var(--accent2)}
.theme-color{display:flex;align-items:center;justify-content:space-between;margin-top:4px;font-size:9px;color:var(--muted)}
.theme-color input[type=color]{width:28px;height:20px;border:none;border-radius:3px;cursor:pointer;background:transparent}
/* Security menu */
#sec-menu{position:fixed;top:38px;right:0;width:260px;background:var(--panel);border-left:1px solid var(--border);border-bottom:1px solid var(--border);border-radius:0 0 0 8px;z-index:500;display:none;padding:8px}
#sec-menu.active{display:block}
.sec-link{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:6px;color:var(--text);font-size:11px;cursor:pointer;text-decoration:none;border:1px solid transparent;margin-bottom:2px}
.sec-link:hover{background:var(--card);border-color:var(--border);color:var(--text-bright)}
.sec-link .sec-icon{font-size:16px;width:24px;text-align:center}
.sec-link .sec-desc{font-size:8px;color:var(--muted);display:block}
/* Toast */
#alert-toast{position:fixed;top:42px;right:10px;z-index:900;display:flex;flex-direction:column;gap:4px;max-width:380px}
.alert-item{display:flex;align-items:flex-start;gap:6px;padding:8px 10px;background:var(--panel);border:1px solid var(--warn-border);border-radius:8px;animation:slideIn .3s ease;font-size:10px}
.alert-item.critical{border-color:var(--alert-border)}
.a-icon{font-size:14px;flex-shrink:0}.a-text{flex:1;color:var(--text)}.a-text small{display:block;color:var(--muted);font-size:8px;margin-top:1px}
.a-close{color:var(--muted);cursor:pointer;font-size:12px;flex-shrink:0}
@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}
</style>
</head>
<body>
<div id="login-overlay">
<div class="login-box">
<h1>Netflow by Ealison</h1>
<div class="subtitle">OpenWrt Network Monitor</div>
<input type="password" id="login-pass" placeholder="Mot de passe root">
<button onclick="doLogin()">Connexion</button>
<div class="error" id="login-error">Mot de passe incorrect</div>
</div>
</div>
<div id="app">
<div class="header">
<div class="header-left">
<h1>Netflow<span class="brand">by Ealison</span></h1>
<span class="clock" id="clock"></span>
</div>
<div class="header-right" id="header-stats"></div>
<div style="display:flex;gap:4px;align-items:center">
<button class="btn-h" id="alert-btn" onclick="togglePanel('alert')" title="Alertes">üîî</button>
<button class="btn-h" onclick="togglePanel('sec')" title="S√©curit√©">üõ°Ô∏è</button>
<button class="btn-h" onclick="togglePanel('theme')" title="Th√®me">üé®</button>
<button class="btn-h" onclick="toggleFullscreen()" title="Plein √©cran">‚õ∂</button>
</div>
</div>
<div class="main-area">
<div id="topo-area">
<canvas id="topoCanvas"></canvas>
<input type="text" id="search-bar" placeholder="üîç Rechercher un appareil...">
<div class="sparkline-global">
<span class="sparkline-label">‚Üë</span><canvas id="spark-up" width="80" height="24"></canvas>
<span class="sparkline-label">‚Üì</span><canvas id="spark-down" width="80" height="24"></canvas>
</div>
<button class="fullscreen-btn" onclick="toggleFullscreen()">‚õ∂ Plein √©cran</button>
</div>
<div class="resize-handle" id="resize-handle"></div>
<div class="bottom-panel" id="bottom-panel">
<div class="bottom-bar">
<div class="bottom-bar-left">
<h3>Appareils (<span id="dev-count">0</span>)</h3>
<input type="text" id="filter-bar" placeholder="Filtrer..." style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:3px 10px;color:var(--text-bright);font-size:9px;width:130px;outline:none">
</div>
<div style="display:flex;gap:4px">
<button class="sort-btn active" onclick="setSort('interface',this)">Interface</button>
<button class="sort-btn" onclick="setSort('type',this)">Type</button>
<button class="sort-btn" onclick="setSort('traffic',this)">Trafic</button>
<button class="sort-btn" onclick="setSort('name',this)">Nom</button>
<button class="sort-btn" onclick="setSort('alerts',this)">Alertes</button>
<button class="sort-btn" onclick="setSort('status',this)">√âtat</button>
</div>
</div>
<div id="device-list"></div>
</div>
</div>
</div>
<div id="detail-modal" onclick="if(event.target===this)closeDetail()">
<div class="detail-content" id="detail-body"></div>
</div>
<div id="edit-modal" onclick="if(event.target===this)closeEdit()">
<div class="edit-content">
<h3>Modifier l'appareil</h3>
<input type="hidden" id="edit-mac">
<label>Nom</label><input type="text" id="edit-name" placeholder="Nom personnalis√©">
<label>Type</label>
<select id="edit-type"><option value="auto">Auto</option><option value="pc">PC</option><option value="laptop">Laptop</option><option value="phone">T√©l√©phone</option><option value="tablet">Tablette</option><option value="camera">Cam√©ra</option><option value="iot">IoT</option><option value="tv">TV</option><option value="printer">Imprimante</option><option value="server">Serveur</option><option value="switch">Switch/Plug</option><option value="other">Autre</option></select>
<div class="edit-btns"><button class="btn-cancel" onclick="closeEdit()">Annuler</button><button class="btn-ok" onclick="saveDevice()">OK</button></div>
</div>
</div>
<div id="alert-panel">
<div class="alert-panel-head"><h3>Alertes s√©curit√©</h3><button onclick="clearAlerts()">Tout effacer</button></div>
<div id="alert-log"></div>
</div>
<div id="theme-panel">
<button class="theme-btn" onclick="applyPreset('default')">üåô Sombre (D√©faut)</button>
<button class="theme-btn" onclick="applyPreset('light')">‚òÄÔ∏è Clair</button>
<button class="theme-btn" onclick="applyPreset('ocean')">üåä Oc√©an</button>
<button class="theme-btn" onclick="applyPreset('fire')">üî• Feu</button>
<button class="theme-btn" onclick="applyPreset('matrix')">üíö Matrix</button>
<button class="theme-btn" onclick="applyPreset('purple')">üíú Violet</button>
<div class="theme-color"><span>Accent 1</span><input type="color" id="tc1" value="#00e676" onchange="applyCC()"></div>
<div class="theme-color"><span>Accent 2</span><input type="color" id="tc2" value="#448aff" onchange="applyCC()"></div>
<div class="theme-color"><span>Accent 3</span><input type="color" id="tc3" value="#ff9100" onchange="applyCC()"></div>
<div class="theme-color"><span>Fond</span><input type="color" id="tcbg" value="#060a14" onchange="applyCC()"></div>
</div>
<div id="sec-menu">
<div style="font-size:11px;color:var(--text-bright);font-weight:600;padding:4px 8px;margin-bottom:4px">üõ°Ô∏è S√©curit√© OpenWrt</div>
<a class="sec-link" href="/cgi-bin/luci/admin/network/firewall" target="_blank"><span class="sec-icon">üî•</span><div>Firewall<span class="sec-desc">R√®gles, zones, transfert de ports</span></div></a>
<a class="sec-link" href="/cgi-bin/luci/admin/network/firewall/rules" target="_blank"><span class="sec-icon">üìã</span><div>R√®gles Firewall<span class="sec-desc">Cr√©er/modifier des r√®gles de trafic</span></div></a>
<a class="sec-link" href="/cgi-bin/luci/admin/network/firewall/forwards" target="_blank"><span class="sec-icon">‚ÜîÔ∏è</span><div>Transfert de ports<span class="sec-desc">NAT / Port forwarding</span></div></a>
<a class="sec-link" href="/cgi-bin/luci/admin/network/dhcp" target="_blank"><span class="sec-icon">üåê</span><div>DHCP & DNS<span class="sec-desc">Baux statiques, filtrage DNS</span></div></a>
<a class="sec-link" href="/cgi-bin/luci/admin/network/wireless" target="_blank"><span class="sec-icon">üì°</span><div>WiFi<span class="sec-desc">SSID, chiffrement, acc√®s</span></div></a>
<a class="sec-link" href="/cgi-bin/luci/admin/system/admin" target="_blank"><span class="sec-icon">üîë</span><div>Administration<span class="sec-desc">Mot de passe, SSH, acc√®s</span></div></a>
<a class="sec-link" href="/cgi-bin/luci/admin/status/nftables" target="_blank"><span class="sec-icon">üìä</span><div>Table NFT<span class="sec-desc">R√®gles nftables actives</span></div></a>
<a class="sec-link" href="/cgi-bin/luci/admin/status/routes" target="_blank"><span class="sec-icon">üó∫Ô∏è</span><div>Routes<span class="sec-desc">Table de routage active</span></div></a>
<a class="sec-link" href="/cgi-bin/luci/admin/status/logs" target="_blank"><span class="sec-icon">üìú</span><div>Journal syst√®me<span class="sec-desc">Logs syst√®me et kernel</span></div></a>
</div>
<div id="alert-toast"></div>
<script>
let SID='',DATA={},PB={},DM={},TH={},ALERTS=[],SORT='interface',SEARCH='',canvas,ctx,W,H,parts=[];
let sparkUpH=[],sparkDownH=[],devSparkH={},REFRESH=5000;
const API='/cgi-bin/luci/admin/ubus';
try{DM=JSON.parse(localStorage.getItem('nf_devices')||'{}');}catch(e){}
try{TH=JSON.parse(localStorage.getItem('nf_theme')||'{}');}catch(e){}
try{ALERTS=JSON.parse(localStorage.getItem('nf_alerts')||'[]');}catch(e){}
const PRESETS={
default:{a1:'#00e676',a2:'#448aff',a3:'#ff9100',bg:'#060a14',light:false},
light:{a1:'#00a152',a2:'#1565c0',a3:'#e65100',bg:'#f0f2f5',light:true},
ocean:{a1:'#00bcd4',a2:'#0288d1',a3:'#26c6da',bg:'#051520',light:false},
fire:{a1:'#ff6d00',a2:'#ff1744',a3:'#ffab00',bg:'#140a05',light:false},
matrix:{a1:'#00ff41',a2:'#00e676',a3:'#76ff03',bg:'#050a05',light:false},
purple:{a1:'#e040fb',a2:'#7c4dff',a3:'#ea80fc',bg:'#0a0514',light:false}
};
function setTC(t){const r=document.documentElement.style;r.setProperty('--accent1',t.a1||'#00e676');r.setProperty('--accent2',t.a2||'#448aff');r.setProperty('--accent3',t.a3||'#ff9100');r.setProperty('--bg',t.bg||'#060a14');r.setProperty('--accent1-dim',(t.a1||'#00e676')+'1a');r.setProperty('--accent2-dim',(t.a2||'#448aff')+'1a');r.setProperty('--accent3-dim',(t.a3||'#ff9100')+'1a');document.body.style.background=t.bg||'#060a14';if(t.light){document.body.classList.add('light');}else{document.body.classList.remove('light');}document.getElementById('tc1').value=t.a1||'#00e676';document.getElementById('tc2').value=t.a2||'#448aff';document.getElementById('tc3').value=t.a3||'#ff9100';document.getElementById('tcbg').value=t.bg||'#060a14';}
function applyPreset(n){TH=Object.assign({},PRESETS[n]||PRESETS.default);setTC(TH);localStorage.setItem('nf_theme',JSON.stringify(TH));}
function applyCC(){TH={a1:document.getElementById('tc1').value,a2:document.getElementById('tc2').value,a3:document.getElementById('tc3').value,bg:document.getElementById('tcbg').value,light:TH.light||false};setTC(TH);localStorage.setItem('nf_theme',JSON.stringify(TH));}
function togglePanel(name){const panels=['alert','theme','sec'];panels.forEach(p=>{const el=document.getElementById(p==='alert'?'alert-panel':p==='theme'?'theme-panel':'sec-menu');if(p===name)el.classList.toggle('active');else el.classList.remove('active');});if(name==='alert')renderAlertLog();}
function toggleFullscreen(){if(!document.fullscreenElement)document.documentElement.requestFullscreen();else document.exitFullscreen();}
if(TH.a1)setTC(TH);
async function doLogin(){const pw=document.getElementById('login-pass').value;try{const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:1,method:'call',params:['00000000000000000000000000000000','session','login',{username:'root',password:pw}]})});const d=await r.json();if(d.result?.[0]===0&&d.result?.[1]?.ubus_rpc_session){SID=d.result[1].ubus_rpc_session;document.getElementById('login-overlay').classList.add('hidden');document.getElementById('app').classList.add('active');initDash();}else showErr();}catch(e){showErr();}}
function showErr(){const el=document.getElementById('login-error');el.style.display='block';setTimeout(()=>el.style.display='none',3000);}
document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
async function ubus(o,m,p={}){try{const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:1,method:'call',params:[SID,o,m,p]})});const d=await r.json();if(d.error?.code===-32002){location.reload();return null;}return d.result?.[1]||null;}catch(e){return null;}}
function fmtB(b){if(!b||b<0)return'0 B';if(b<1024)return(b|0)+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';if(b<1073741824)return(b/1048576).toFixed(1)+' MB';return(b/1073741824).toFixed(2)+' GB';}
function fmtS(s){if(!s||s<0)return'0 B/s';if(s<1024)return(s|0)+' B/s';if(s<1048576)return(s/1024).toFixed(1)+' KB/s';return(s/1048576).toFixed(2)+' MB/s';}
function fmtU(s){if(!s)return'--';const d=Math.floor(s/86400),h=Math.floor(s%86400/3600),m=Math.floor(s%3600/60);return(d?d+'j ':'')+(h+'h ')+m+'m';}
function dType(h,mac){const m=DM[mac];if(m?.type&&m.type!=='auto')return m.type;const n=(h||'').toLowerCase();if(/desktop|pc/i.test(n))return'pc';if(/laptop/i.test(n))return'laptop';if(/galaxy|iphone|pixel|motorola|huawei|redmi|samsung|phone|edge|fold/i.test(n))return'phone';if(/ipad|tab/i.test(n))return'tablet';if(/cam|ipc|nomi|blink|tapo/i.test(n))return'camera';if(/meross|switch|plug|sonoff|shelly/i.test(n))return'switch';if(/tv|roku|chromecast/i.test(n))return'tv';if(/print|epson|canon|npi|laser/i.test(n))return'printer';if(/home.?ass|hass|nas|server|rasp/i.test(n))return'server';if(/sensor|capteur|esp|devolo|supercap/i.test(n))return'iot';return'other';}
const IC={pc:'üíª',laptop:'üíª',phone:'üì±',tablet:'üì±',camera:'üì∑',switch:'üîå',tv:'üì∫',printer:'üñ®',server:'üñ•',iot:'üì°',other:'‚ùì'};
function tCol(t){return{pc:'#448aff',laptop:'#448aff',phone:'#00e676',tablet:'#00e676',camera:'#ff9100',switch:'#ff9100',tv:'#b388ff',printer:'#546e7a',server:'#18ffff',iot:'#ff9100',other:'#546e7a'}[t]||'#546e7a';}
/* Enhanced traffic classification */
const PORT_SVC={20:'FTP-D',21:'FTP',22:'SSH',23:'Telnet',25:'SMTP',53:'DNS',67:'DHCP',68:'DHCP',80:'HTTP',110:'POP3',123:'NTP',135:'RPC',139:'NetBIOS',143:'IMAP',443:'HTTPS',445:'SMB',465:'SMTPS',514:'Syslog',554:'RTSP',587:'SMTP',636:'LDAPS',993:'IMAPS',995:'POP3S',1080:'SOCKS',1194:'OpenVPN',1433:'MSSQL',1883:'MQTT',3306:'MySQL',3389:'RDP',4070:'Spotify',5060:'SIP',5222:'XMPP',5353:'mDNS',5432:'PostgreSQL',5900:'VNC',6379:'Redis',6881:'BitTorrent',8080:'HTTP-Alt',8443:'HTTPS-Alt',8554:'RTSP',8883:'MQTTS',8888:'HTTP-Alt',9090:'Cockpit',9093:'MQTT',9200:'Elastic',9993:'ZeroTier',27017:'MongoDB',32400:'Plex',34567:'DVR',51820:'WireGuard'};
const TRAF_CAT={HTTPS:{ports:[443,8443],cls:'tt-https'},HTTP:{ports:[80,8080,8888],cls:'tt-https'},DNS:{ports:[53,5353],cls:'tt-dns'},MQTT:{ports:[1883,8883,9093],cls:'tt-iot'},Stream:{ports:[554,8554,32400,34567],cls:'tt-stream'},VPN:{ports:[1194,51820,9993],cls:'tt-vpn'},Mail:{ports:[25,110,143,465,587,993,995],cls:'tt-other'},DB:{ports:[3306,5432,1433,6379,9200,27017],cls:'tt-alert'},Remote:{ports:[22,23,3389,5900],cls:'tt-warn'},SMB:{ports:[139,445],cls:'tt-warn'}};
function classifyTraffic(entries){
const cats=new Map();const portSet=new Set();
for(const e of entries){
const dp=e.dport,sp=e.sport;
[dp,sp].forEach(p=>{if(p&&p>0)portSet.add(p);});
let found=false;
for(const[name,cat] of Object.entries(TRAF_CAT)){if(cat.ports.includes(dp)||cat.ports.includes(sp)){cats.set(name,(cats.get(name)||0)+1);found=true;break;}}
if(!found)cats.set('Other',(cats.get('Other')||0)+1);
}
const sorted=[...cats.entries()].sort((a,b)=>b[1]-a[1]);
const topPorts=[...portSet].sort((a,b)=>a-b).slice(0,8).map(p=>({port:p,svc:PORT_SVC[p]||'P'+p}));
return{categories:sorted.slice(0,5),ports:topPorts};
}
function wifiQuality(sig){if(!sig)return{level:0,label:'--',cls:''};if(sig>=-50)return{level:4,label:'Excellent',cls:''};if(sig>=-60)return{level:3,label:'Bon',cls:''};if(sig>=-70)return{level:2,label:'Moyen',cls:'fair'};return{level:1,label:'Faible',cls:'poor'};}
function wifiBarsHTML(sig){const q=wifiQuality(sig);const h=[3,5,7,10];let s='<div class="wifi-bar '+q.cls+'" title="'+q.label+' ('+sig+'dBm)">';for(let i=0;i<4;i++)s+='<span style="height:'+h[i]+'px" class="'+(i<q.level?'active':'')+'"></span>';return s+'</div>';}
function isOnline(d){return d.conn>0||d.ts>0||d.rs>0;}
function drawSparkline(cvs,data,color,maxV){const c=cvs.getContext('2d'),w=cvs.width,h=cvs.height;c.clearRect(0,0,w,h);if(data.length<2)return;const mx=maxV||Math.max(...data,1);c.beginPath();data.forEach((v,i)=>{const x=i/(data.length-1)*w,y=h-Math.min(v/mx,1)*h*.85;if(i===0)c.moveTo(x,y);else c.lineTo(x,y);});c.lineTo(w,h);c.lineTo(0,h);c.fillStyle=color+'20';c.fill();c.beginPath();data.forEach((v,i)=>{const x=i/(data.length-1)*w,y=h-Math.min(v/mx,1)*h*.85;if(i===0)c.moveTo(x,y);else c.lineTo(x,y);});c.strokeStyle=color;c.lineWidth=1.2;c.stroke();}
function updateClock(){document.getElementById('clock').textContent=new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});}
setInterval(updateClock,1000);
/* Alert system with smart cooldown */
const SENSITIVE_PORTS=[21,22,23,25,135,139,445,3306,3389,5900,6379,8888,9200,27017];
const PNAMES={21:'FTP',22:'SSH',23:'Telnet',25:'SMTP',135:'RPC',139:'NetBIOS',445:'SMB',3306:'MySQL',3389:'RDP',5900:'VNC',6379:'Redis',8888:'HTTP-Alt',9200:'Elastic',27017:'MongoDB'};
let alertCD={};
function analyzeDevice(dev,ct){
const alerts=[];const now=Date.now();const ck=dev.mac;
if(now-(alertCD[ck]||0)<30000)return alerts;
if(dev.conn>50)alerts.push({level:'warn',msg:dev.hostname+': '+dev.conn+' connexions',detail:'Nombre inhabituellement √©lev√© de connexions actives',dev:dev.mac});
if(dev.ts+dev.rs>5000000)alerts.push({level:'warn',msg:dev.hostname+': d√©bit '+fmtS(dev.ts+dev.rs),detail:'Trafic tr√®s √©lev√© d√©tect√©',dev:dev.mac});
if(dev.tx+dev.rx>100000000)alerts.push({level:'info',msg:dev.hostname+': '+fmtB(dev.tx+dev.rx)+' total',detail:'Volume de donn√©es important',dev:dev.mac});
const devCt=ct.filter(e=>e.src===dev.ip||e.dst===dev.ip);
const sp=new Set();devCt.forEach(e=>{if(SENSITIVE_PORTS.includes(e.dport))sp.add(e.dport);if(SENSITIVE_PORTS.includes(e.sport))sp.add(e.sport);});
if(sp.size>0){const pN=[...sp].map(p=>PNAMES[p]||p).join(', ');alerts.push({level:'alert',msg:dev.hostname+': ports sensibles ('+pN+')',detail:'Connexions sur ports √† risque: '+[...sp].join(', '),dev:dev.mac});}
const dstIPs=new Set(devCt.filter(e=>e.src===dev.ip).map(e=>e.dst));
if(dstIPs.size>30)alerts.push({level:'warn',msg:dev.hostname+': '+dstIPs.size+' destinations',detail:'Possible scan r√©seau ou comportement anormal',dev:dev.mac});
if(['camera','iot','switch'].includes(dev.type)&&dstIPs.size>10)alerts.push({level:'warn',msg:dev.hostname+' (IoT): '+dstIPs.size+' dest.',detail:'Appareil IoT avec trop de connexions sortantes',dev:dev.mac});
if(dev.blocked&&dev.conn>0)alerts.push({level:'alert',msg:dev.hostname+': trafic malgr√© blocage!',detail:dev.conn+' connexions actives malgr√© la r√®gle de blocage',dev:dev.mac});
if(alerts.length>0)alertCD[ck]=now;
return alerts;
}
function addAlert(a){if(ALERTS.find(x=>x.msg===a.msg&&Date.now()-x.ts<60000))return;const item={...a,ts:Date.now(),id:Math.random().toString(36).substr(2,6)};ALERTS.unshift(item);if(ALERTS.length>200)ALERTS.length=200;localStorage.setItem('nf_alerts',JSON.stringify(ALERTS));showToast(item);updateAlertBadge();}
function showToast(item){const c=document.getElementById('alert-toast');const el=document.createElement('div');el.className='alert-item '+(item.level==='alert'?'critical':'');el.innerHTML='<span class="a-icon">'+(item.level==='alert'?'üö®':item.level==='warn'?'‚ö†Ô∏è':'‚ÑπÔ∏è')+'</span><div class="a-text">'+item.msg+'<small>'+item.detail+'</small></div><span class="a-close" onclick="this.parentElement.remove()">‚úï</span>';c.appendChild(el);setTimeout(()=>{if(el.parentElement)el.remove();},8000);}
function updateAlertBadge(){const n=ALERTS.filter(a=>Date.now()-a.ts<600000).length;const btn=document.getElementById('alert-btn');const ex=btn.querySelector('.badge');if(ex)ex.remove();if(n>0){const b=document.createElement('span');b.className='badge';b.textContent=n;btn.appendChild(b);}}
function renderAlertLog(){const c=document.getElementById('alert-log');if(!ALERTS.length){c.innerHTML='<div style="color:var(--muted);font-size:10px;padding:10px">Aucune alerte</div>';return;}c.innerHTML=ALERTS.slice(0,80).map(a=>{const icon=a.level==='alert'?'üö®':a.level==='warn'?'‚ö†Ô∏è':'‚ÑπÔ∏è';const ago=Math.floor((Date.now()-a.ts)/60000);return'<div class="alert-log-item"><span class="al-icon">'+icon+'</span><div class="al-text">'+a.msg+'</div><span class="al-time">'+(ago<1?'maintenant':ago+'min')+'</span></div>';}).join('');}
function clearAlerts(){ALERTS=[];localStorage.setItem('nf_alerts','[]');renderAlertLog();updateAlertBadge();}
async function fetchData(){
const[si,ifd,dh,ctR,w24,w5,iw0]=await Promise.all([ubus('system','info'),ubus('network.interface','dump'),ubus('luci-rpc','getDHCPLeases'),ubus('luci','getConntrackList'),ubus('iwinfo','assoclist',{device:'phy0-ap0'}),ubus('iwinfo','assoclist',{device:'wlan1'}),ubus('iwinfo','info',{device:'phy0-ap0'})]);
const ct=ctR?(Array.isArray(ctR)?ctR:(ctR.result||[])):[];const ls=dh?.dhcp_leases||[];
const w24M=(w24?.results||[]).map(c=>c.mac?.toUpperCase());const w5M=(w5?.results||[]).map(c=>c.mac?.toUpperCase());
const wC={};(w24?.results||[]).forEach(c=>{wC[c.mac?.toUpperCase()]=c;});(w5?.results||[]).forEach(c=>{wC[c.mac?.toUpperCase()]=c;});
const now=Date.now();
const devs=ls.map(l=>{
const mac=l.macaddr?.toUpperCase(),mt=DM[mac]||{};
let iface='eth';if(w24M.includes(mac))iface='wifi24';else if(w5M.includes(mac))iface='wifi5';
const dCt=ct.filter(e=>e.src===l.ipaddr||e.dst===l.ipaddr);
const tx=dCt.filter(e=>e.src===l.ipaddr).reduce((s,e)=>s+(e.bytes||0),0);
const rx=dCt.filter(e=>e.dst===l.ipaddr).reduce((s,e)=>s+(e.bytes||0),0);
const pk=mac+'t',pkr=mac+'r';let ts=0,rs=0;
if(PB[pk]){const dt=(now-PB[pk].t)/1000;if(dt>0&&dt<30){ts=Math.max(0,(tx-PB[pk].v)/dt);rs=Math.max(0,(rx-PB[pkr].v)/dt);}}
PB[pk]={v:tx,t:now};PB[pkr]={v:rx,t:now};
if(!devSparkH[mac])devSparkH[mac]={up:[],down:[]};
devSparkH[mac].up.push(ts);devSparkH[mac].down.push(rs);
if(devSparkH[mac].up.length>30)devSparkH[mac].up.shift();
if(devSparkH[mac].down.length>30)devSparkH[mac].down.shift();
const traf=classifyTraffic(dCt);
const dev={hostname:mt.name||l.hostname||mac,ip:l.ipaddr,mac,iface,type:dType(l.hostname,mac),conn:dCt.length,tx,rx,ts,rs,traf,sig:wC[mac]?.signal||null,blocked:mt.blocked||false,alerts:[],dCt};
dev.alerts=analyzeDevice(dev,ct);
dev.alerts.forEach(a=>addAlert(a));
return dev;});
sparkUpH.push(devs.reduce((s,d)=>s+d.ts,0));sparkDownH.push(devs.reduce((s,d)=>s+d.rs,0));
if(sparkUpH.length>60)sparkUpH.shift();if(sparkDownH.length>60)sparkDownH.shift();
DATA={sys:si,wan:ifd?.interface?.find(i=>i.interface==='wan'),devs,ct,ssid:iw0?.ssid||'WiFi',conns:ct.length,ts:now};
}
function updateHeader(){
const d=DATA,up=d.sys?.uptime||0,cn=d.conns||0,dc=d.devs?.length||0;
const wUp=d.wan?.up,wIP=d.wan?.['ipv4-address']?.[0]?.address||'--';
const tT=d.devs?.reduce((s,v)=>s+v.ts,0)||0,tR=d.devs?.reduce((s,v)=>s+v.rs,0)||0;
const alertCount=d.devs?.reduce((s,v)=>s+v.alerts.length,0)||0;
const onC=d.devs?.filter(v=>isOnline(v)).length||0;
document.getElementById('header-stats').innerHTML=
'<div class="stat-pill"><span class="dot '+(wUp?'green':'red')+'"></span>WAN <span class="val">'+wIP+'</span></div>'+
'<div class="stat-pill"><span class="dot green"></span>‚Üë<span class="val">'+fmtS(tT)+'</span></div>'+
'<div class="stat-pill"><span class="dot blue"></span>‚Üì<span class="val">'+fmtS(tR)+'</span></div>'+
'<div class="stat-pill"><span class="dot orange"></span><span class="val">'+cn+'</span> flux</div>'+
'<div class="stat-pill"><span class="val">'+onC+'/'+dc+'</span> en ligne</div>'+
(alertCount>0?'<div class="stat-pill"><span class="dot red"></span><span class="val">'+alertCount+'</span> alertes</div>':'')+
'<div class="stat-pill">Up '+fmtU(up)+'</div>';
updateAlertBadge();
drawSparkline(document.getElementById('spark-up'),sparkUpH,'#00e676');
drawSparkline(document.getElementById('spark-down'),sparkDownH,'#448aff');
}
function setSort(s,btn){SORT=s;document.querySelectorAll('.sort-btn').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');updateDevs();}
function sortDevs(devs){const l=[...devs];if(SORT==='interface')l.sort((a,b)=>{const o={wifi24:0,wifi5:1,eth:2};return(o[a.iface]||9)-(o[b.iface]||9)||a.hostname.localeCompare(b.hostname);});else if(SORT==='type')l.sort((a,b)=>a.type.localeCompare(b.type)||a.hostname.localeCompare(b.hostname));else if(SORT==='traffic')l.sort((a,b)=>(b.tx+b.rx)-(a.tx+a.rx));else if(SORT==='name')l.sort((a,b)=>a.hostname.localeCompare(b.hostname));else if(SORT==='alerts')l.sort((a,b)=>b.alerts.length-a.alerts.length||(b.tx+b.rx)-(a.tx+a.rx));else if(SORT==='status')l.sort((a,b)=>(isOnline(a)?0:1)-(isOnline(b)?0:1)||(b.tx+b.rx)-(a.tx+a.rx));return l;}
function getGroupKey(d){if(SORT==='interface')return d.iface==='wifi24'?'WiFi 2.4GHz':d.iface==='wifi5'?'WiFi 5GHz':'Ethernet';if(SORT==='type')return(IC[d.type]||'?')+' '+d.type.toUpperCase();if(SORT==='status')return isOnline(d)?'üü¢ En ligne':'‚ö™ Hors ligne';return null;}
document.getElementById('search-bar').addEventListener('input',e=>{SEARCH=e.target.value.toLowerCase();document.getElementById('filter-bar').value=e.target.value;updateDevs();});
document.getElementById('filter-bar').addEventListener('input',e=>{SEARCH=e.target.value.toLowerCase();document.getElementById('search-bar').value=e.target.value;updateDevs();});
function updateDevs(){
const c=document.getElementById('device-list');document.getElementById('dev-count').textContent=DATA.devs?.length||0;
if(!DATA.devs)return;
let filtered=DATA.devs;
if(SEARCH)filtered=filtered.filter(d=>d.hostname.toLowerCase().includes(SEARCH)||d.ip.includes(SEARCH)||d.mac.toLowerCase().includes(SEARCH)||d.type.includes(SEARCH));
const sorted=sortDevs(filtered);let html='',lastG='';
sorted.forEach(d=>{
const gk=getGroupKey(d);if(gk&&gk!==lastG){html+='<div class="group-label">'+gk+'</div>';lastG=gk;}
const ic=IC[d.type]||'?',co=tCol(d.type),on=isOnline(d);
const ifC=d.iface==='wifi24'?'iface-wifi24':d.iface==='wifi5'?'iface-wifi5':'iface-eth';
const ifL=d.iface==='wifi24'?'WiFi 2.4G':d.iface==='wifi5'?'WiFi 5G':'Ethernet';
const catBadges=d.traf.categories.map(([n,c])=>'<span class="tt-badge '+(TRAF_CAT[n]?.cls||'tt-other')+'">'+n+'<small style="opacity:0.6"> '+c+'</small></span>').join('');
const portBadges=d.traf.ports.slice(0,4).map(p=>'<span class="tt-badge tt-port" title="Port '+p.port+'">:'+p.port+' '+p.svc+'</span>').join('');
const hasAlert=d.alerts.length>0;const hasCritical=d.alerts.some(a=>a.level==='alert');
const alertBadges=d.alerts.slice(0,2).map(a=>'<span class="tt-badge '+(a.level==='alert'?'tt-alert':'tt-warn')+'">'+(a.level==='alert'?'üö®':'‚ö†Ô∏è')+' '+a.detail.substring(0,24)+'</span>').join('');
const wB=d.sig?wifiBarsHTML(d.sig):'';
const spkId='spk_'+d.mac.replace(/:/g,'');
const cardCls='dev-card'+(d.blocked?' blocked-card':'')+(hasCritical?' alert-card-critical':hasAlert?' alert-card':'')+(!on?' offline':'');
html+='<div class="'+cardCls+'" onclick="openDetail(\''+d.mac+'\')">';
html+='<div class="dev-card-top"><span class="online-dot '+(on?'on':'off')+'"></span>';
html+='<div class="dev-icon" style="background:'+co+'18;color:'+co+'">'+ic+'</div>';
html+='<div class="dev-info"><div class="name">'+d.hostname+'</div><div class="ip">'+d.ip+' ¬∑ '+d.mac.substring(0,8)+'...'+(d.sig?' ¬∑ '+d.sig+'dBm':'')+'</div></div>';
html+=wB+'<span class="dev-iface '+ifC+'">'+ifL+'</span></div>';
html+='<div class="dev-card-stats"><span class="up">‚Üë'+fmtS(d.ts)+'</span><span class="down">‚Üì'+fmtS(d.rs)+'</span><span class="total">‚àë'+fmtB(d.tx+d.rx)+'</span><span class="total">¬∑'+d.conn+'c</span><canvas id="'+spkId+'" width="50" height="16" style="margin-left:auto"></canvas></div>';
html+='<div class="traffic-types">'+catBadges+portBadges+'</div>';
if(hasAlert)html+='<div class="traffic-types">'+alertBadges+'</div>';
html+='<div class="dev-card-actions"><button class="btn-sm" onclick="event.stopPropagation();openEdit(\''+d.mac+'\')">‚úèÔ∏è</button><button class="btn-sm btn-block '+(d.blocked?'active':'')+'" onclick="event.stopPropagation();toggleBlock(\''+d.mac+'\')">'+(d.blocked?'üîì':'üîí')+'</button></div></div>';
});
c.innerHTML=html;
sorted.forEach(d=>{const cvs=document.getElementById('spk_'+d.mac.replace(/:/g,''));if(cvs&&devSparkH[d.mac])drawSparkline(cvs,devSparkH[d.mac].up,'#00e676');});
}
/* Detail Modal */
function openDetail(mac){
const d=DATA.devs?.find(v=>v.mac===mac);if(!d)return;
const q=wifiQuality(d.sig);const sh=devSparkH[mac]||{up:[],down:[]};
const topDst={};d.dCt?.filter(e=>e.src===d.ip).forEach(e=>{const k=e.dst+':'+e.dport;topDst[k]=(topDst[k]||0)+1;});
const body=document.getElementById('detail-body');
const portsSummary=d.traf.ports.map(p=>'<span class="tt-badge tt-port" style="font-size:9px">:'+p.port+' '+p.svc+'</span>').join(' ');
const catsSummary=d.traf.categories.map(([n,c])=>'<span class="tt-badge '+(TRAF_CAT[n]?.cls||'tt-other')+'" style="font-size:9px">'+n+' ('+c+')</span>').join(' ');
body.innerHTML='<div class="detail-header"><h2>'+IC[d.type]+' '+d.hostname+'</h2><button class="detail-close" onclick="closeDetail()">‚úï</button></div>'+
'<div class="detail-grid">'+
'<div class="detail-stat"><div class="ds-label">Adresse IP</div><div class="ds-val">'+d.ip+'</div><div class="ds-sub">MAC: '+d.mac+'</div></div>'+
'<div class="detail-stat"><div class="ds-label">Interface</div><div class="ds-val">'+(d.iface==='wifi24'?'WiFi 2.4GHz':d.iface==='wifi5'?'WiFi 5GHz':'Ethernet')+'</div><div class="ds-sub">'+(d.sig?'Signal: '+d.sig+'dBm ('+q.label+')':'C√¢ble Ethernet')+'</div></div>'+
'<div class="detail-stat"><div class="ds-label">D√©bit actuel</div><div class="ds-val">‚Üë'+fmtS(d.ts)+' ‚Üì'+fmtS(d.rs)+'</div><div class="ds-sub">Total √©chang√©: '+fmtB(d.tx+d.rx)+'</div></div>'+
'<div class="detail-stat"><div class="ds-label">Connexions</div><div class="ds-val">'+d.conn+'</div><div class="ds-sub">Type: '+d.type+(d.blocked?' ¬∑ üîí BLOQU√â':'')+'</div></div></div>'+
'<div class="detail-spark"><div style="font-size:9px;color:var(--muted);margin-bottom:4px">D√©bit temps r√©el</div><canvas id="dspk" width="600" height="60"></canvas></div>'+
'<div style="margin-bottom:8px"><div style="font-size:10px;color:var(--text-bright);margin-bottom:4px">Protocoles d√©tect√©s</div><div>'+catsSummary+'</div></div>'+
'<div style="margin-bottom:8px"><div style="font-size:10px;color:var(--text-bright);margin-bottom:4px">Ports utilis√©s</div><div>'+portsSummary+'</div></div>'+
(d.alerts.length>0?'<div class="detail-alerts"><div style="font-size:10px;color:var(--accent3);margin-bottom:4px;font-weight:600">‚ö†Ô∏è Alertes actives ('+d.alerts.length+')</div>'+d.alerts.map(a=>'<div class="da-item '+(a.level==='alert'?'critical':'')+'"><span>'+(a.level==='alert'?'üö®':'‚ö†Ô∏è')+'</span><span>'+a.msg+' ‚Äî '+a.detail+'</span></div>').join('')+'</div>':'')+
'<div class="detail-conns"><div style="font-size:10px;color:var(--text-bright);margin:8px 0 4px;font-weight:600">Connexions actives ('+d.dCt?.length+')</div><table><thead><tr><th>Direction</th><th>Adresse</th><th>Port</th><th>Service</th><th>Proto</th><th>Octets</th></tr></thead><tbody>'+
d.dCt?.slice(0,50).map(e=>{const out=e.src===d.ip;const rIP=out?e.dst:e.src;const rP=out?e.dport:e.sport;const svc=PORT_SVC[rP]||'';return'<tr><td>'+(out?'‚Üí OUT':'‚Üê IN')+'</td><td>'+rIP+'</td><td>'+rP+'</td><td style="color:var(--accent2)">'+svc+'</td><td>'+(e.layer4||'?')+'</td><td>'+fmtB(e.bytes)+'</td></tr>';}).join('')+
'</tbody></table></div>'+
'<div style="display:flex;gap:6px;margin-top:12px"><button class="btn-sm" onclick="closeDetail();openEdit(\''+mac+'\')">‚úèÔ∏è Modifier</button><button class="btn-sm btn-block '+(d.blocked?'active':'')+'" onclick="toggleBlock(\''+mac+'\');closeDetail();">'+(d.blocked?'üîì D√©bloquer':'üîí Bloquer')+'</button></div>';
document.getElementById('detail-modal').classList.add('active');
setTimeout(()=>{const sc=document.getElementById('dspk');if(sc){const allD=[...sh.up,...sh.down];const mx=Math.max(...allD,100);drawSparkline(sc,sh.up,'#00e676',mx);const c2=sc.getContext('2d');c2.beginPath();sh.down.forEach((v,i)=>{const x=i/(sh.down.length-1)*600,y=60-Math.min(v/mx,1)*60*.85;if(i===0)c2.moveTo(x,y);else c2.lineTo(x,y);});c2.strokeStyle='#448aff';c2.lineWidth=1.2;c2.stroke();}},50);
}
function closeDetail(){document.getElementById('detail-modal').classList.remove('active');}
/* Canvas */
function initCanvas(){canvas=document.getElementById('topoCanvas');ctx=canvas.getContext('2d');resizeCanvas();window.addEventListener('resize',resizeCanvas);}
function resizeCanvas(){const a=document.getElementById('topo-area');W=a.clientWidth;H=a.clientHeight;const dpr=window.devicePixelRatio||1;canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+'px';canvas.style.height=H+'px';ctx.setTransform(dpr,0,0,dpr,0,0);}
function getN(){
const ds=DATA.devs||[];const n={};
n.wan={x:50,y:H/2,l:'WAN',s:DATA.wan?.['ipv4-address']?.[0]?.address||'',c:'#ff9100',r:20};
n.rtr={x:W*.18,y:H/2,l:'OpenWrt',s:'192.168.10.1',c:'#448aff',r:22};
const aIfs=[{id:'wifi24',l:'WiFi 2.4G',s:(DATA.ssid||'')+' ('+ds.filter(d=>d.iface==='wifi24').length+')',c:'#00e676',d:ds.filter(d=>d.iface==='wifi24')},{id:'wifi5',l:'WiFi 5G',s:ds.filter(d=>d.iface==='wifi5').length+'',c:'#448aff',d:ds.filter(d=>d.iface==='wifi5')},{id:'eth',l:'Ethernet',s:'br-lan ('+ds.filter(d=>d.iface==='eth').length+')',c:'#ff9100',d:ds.filter(d=>d.iface==='eth')}].filter(f=>f.d.length>0);
const sp=Math.min(H/(aIfs.length+1),90),sy=H/2-(aIfs.length-1)*sp/2;
aIfs.forEach((f,i)=>{n['i_'+f.id]={x:W*.38,y:sy+i*sp,l:f.l,s:f.s,c:f.c,r:16,d:f.d};});
const ad=[];
aIfs.forEach(f=>{const ifN=n['i_'+f.id];const dl=f.d;const mPC=Math.max(1,Math.floor((H-20)/28));
dl.forEach((d,i)=>{const col=Math.floor(i/mPC),row=i%mPC;const inC=Math.min(dl.length-col*mPC,mPC);
const x=W*.56+col*110,yS=ifN.y-(inC-1)*14,y=yS+row*28;
const id='d_'+d.mac.replace(/:/g,'');const on=isOnline(d);
n[id]={x,y,l:d.hostname.substring(0,12),s:'',c:d.alerts?.length>0?'#ff5252':on?f.c:'#37474f',r:on?8:5,dv:d};ad.push(id);});});
return{n,ifs:aIfs,ad};}
function drawN(nd){const{x,y,l,s,c,r}=nd;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=c+'12';ctx.fill();ctx.strokeStyle=c+'44';ctx.lineWidth=0.7;ctx.stroke();ctx.beginPath();ctx.arc(x,y,2.5,0,Math.PI*2);ctx.fillStyle=c;ctx.fill();const isLight=document.body.classList.contains('light');ctx.font='bold '+(r>14?'9':'7')+'px sans-serif';ctx.fillStyle=isLight?'#455a64':'#b0bec5';ctx.textAlign='center';ctx.fillText(l,x,y+r+9);if(s){ctx.font='7px sans-serif';ctx.fillStyle=isLight?'#78909c':'#546e7a';ctx.fillText(s,x,y+r+17);}}
function drawL(x1,y1,x2,y2,c,w){ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);const isLight=document.body.classList.contains('light');ctx.strokeStyle=(c||'#fff')+(isLight?'25':'20');ctx.lineWidth=w||0.6;ctx.stroke();}
class Pt{constructor(a,b,c,d,col,sp,sz){this.a=a;this.b=b;this.c=c;this.d=d;this.col=col;this.sp=sp;this.sz=sz;this.t=Math.random();}update(){this.t+=this.sp;if(this.t>=1)this.t=0;}draw(x){const px=this.a+(this.c-this.a)*this.t,py=this.b+(this.d-this.b)*this.t;x.beginPath();x.arc(px,py,this.sz,0,Math.PI*2);x.fillStyle=this.col;x.fill();}}
function updParts(){const{n,ifs}=getN();const nd=[];const wT=DATA.devs?.reduce((s,d)=>s+d.ts+d.rs,0)||0;const wC=Math.max(1,Math.min(6,Math.floor(wT/30000)+1));
for(let i=0;i<wC;i++){nd.push({a:n.wan.x,b:n.wan.y,c:n.rtr.x,d:n.rtr.y,col:'#ff9100',sp:.004+Math.random()*.006,sz:1.2+Math.random()*.8});nd.push({a:n.rtr.x,b:n.rtr.y,c:n.wan.x,d:n.wan.y,col:'#448aff',sp:.004+Math.random()*.006,sz:1.2+Math.random()*.8});}
ifs.forEach(f=>{const ifN=n['i_'+f.id];if(!ifN)return;const iT=f.d.reduce((s,d)=>s+d.ts+d.rs,0);const c=Math.max(1,Math.min(4,Math.floor(iT/20000)+1));
for(let i=0;i<c;i++){nd.push({a:n.rtr.x,b:n.rtr.y,c:ifN.x,d:ifN.y,col:f.c,sp:.003+Math.random()*.005,sz:1});nd.push({a:ifN.x,b:ifN.y,c:n.rtr.x,d:n.rtr.y,col:f.c+'aa',sp:.003+Math.random()*.005,sz:.8});}
f.d.forEach(dv=>{const did='d_'+dv.mac.replace(/:/g,''),dn=n[did];if(!dn)return;if(dv.ts>0||dv.conn>0){const int=Math.max(1,Math.min(3,Math.floor((dv.ts+dv.rs)/10000)+1));for(let i=0;i<int;i++){nd.push({a:dn.x,b:dn.y,c:ifN.x,d:ifN.y,col:'#00e676',sp:.004+Math.random()*.007,sz:.6+Math.random()*.5});nd.push({a:ifN.x,b:ifN.y,c:dn.x,d:dn.y,col:'#448aff',sp:.004+Math.random()*.007,sz:.6+Math.random()*.5});}}});});
while(parts.length<nd.length){const p=nd[parts.length%nd.length];parts.push(new Pt(p.a,p.b,p.c,p.d,p.col,p.sp,p.sz));}while(parts.length>nd.length+10)parts.pop();
parts.forEach((p,i)=>{if(nd[i%nd.length]){const q=nd[i%nd.length];p.a=q.a;p.b=q.b;p.c=q.c;p.d=q.d;p.col=q.col;}});}
let lPU=0;
function render(t){ctx.clearRect(0,0,W,H);const isLight=document.body.classList.contains('light');
ctx.strokeStyle=isLight?'rgba(0,0,0,0.04)':'rgba(255,255,255,0.015)';ctx.lineWidth=0.5;
for(let x=0;x<W;x+=60){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
for(let y=0;y<H;y+=60){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
const{n,ifs,ad}=getN();const wT=DATA.devs?.reduce((s,d)=>s+d.ts+d.rs,0)||0;
drawL(n.wan.x,n.wan.y,n.rtr.x,n.rtr.y,'#ff9100',Math.max(0.8,Math.min(3,wT/200000+0.8)));
ifs.forEach(f=>{const ifN=n['i_'+f.id];if(!ifN)return;const iT=f.d.reduce((s,d)=>s+d.ts+d.rs,0);drawL(n.rtr.x,n.rtr.y,ifN.x,ifN.y,f.c,Math.max(0.5,Math.min(2,iT/100000+0.5)));
f.d.forEach(dv=>{const dn=n['d_'+dv.mac.replace(/:/g,'')];if(dn)drawL(ifN.x,ifN.y,dn.x,dn.y,dn.c,Math.max(0.3,Math.min(1.5,(dv.ts+dv.rs)/50000+0.3)));});});
if(t-lPU>2500){updParts();lPU=t;}parts.forEach(p=>{p.update();p.draw(ctx);});
drawN(n.wan);drawN(n.rtr);ifs.forEach(f=>{const ifN=n['i_'+f.id];if(ifN)drawN(ifN);});ad.forEach(id=>{if(n[id])drawN(n[id]);});
const ang=(t*.0006)%(Math.PI*2);ctx.save();ctx.globalAlpha=0.05;ctx.beginPath();ctx.moveTo(n.rtr.x,n.rtr.y);ctx.arc(n.rtr.x,n.rtr.y,35,ang,ang+.6);ctx.closePath();ctx.fillStyle='#448aff';ctx.fill();ctx.restore();
requestAnimationFrame(render);}
function openEdit(mac){const mt=DM[mac]||{},dv=DATA.devs?.find(d=>d.mac===mac);document.getElementById('edit-mac').value=mac;document.getElementById('edit-name').value=mt.name||dv?.hostname||'';document.getElementById('edit-type').value=mt.type||'auto';document.getElementById('edit-modal').classList.add('active');}
function closeEdit(){document.getElementById('edit-modal').classList.remove('active');}
function saveDevice(){const mac=document.getElementById('edit-mac').value,nm=document.getElementById('edit-name').value.trim(),tp=document.getElementById('edit-type').value;if(!DM[mac])DM[mac]={};if(nm)DM[mac].name=nm;else delete DM[mac].name;DM[mac].type=tp;localStorage.setItem('nf_devices',JSON.stringify(DM));closeEdit();updateDevs();}
async function toggleBlock(mac){const dv=DATA.devs?.find(d=>d.mac===mac);if(!dv)return;if(!DM[mac])DM[mac]={};
if(DM[mac].blocked){DM[mac].blocked=false;await ubus('uci','delete',{config:'firewall',type:'rule',match:{name:'nf_block_'+mac.replace(/:/g,'')}});await ubus('uci','commit',{config:'firewall'});await ubus('luci','setInitAction',{name:'firewall',action:'restart'});}
else{DM[mac].blocked=true;await ubus('uci','add',{config:'firewall',type:'rule',name:'nf_block_'+mac.replace(/:/g,''),values:{name:'nf_block_'+mac.replace(/:/g,''),src:'lan',dest:'wan',src_ip:dv.ip,target:'DROP',enabled:'1'}});await ubus('uci','commit',{config:'firewall'});await ubus('luci','setInitAction',{name:'firewall',action:'restart'});}
localStorage.setItem('nf_devices',JSON.stringify(DM));updateDevs();}
(function(){const h=document.getElementById('resize-handle'),bp=document.getElementById('bottom-panel');let dr=false,sY,sH;
h.addEventListener('mousedown',e=>{dr=true;sY=e.clientY;sH=bp.offsetHeight;document.body.style.cursor='ns-resize';e.preventDefault();});
document.addEventListener('mousemove',e=>{if(!dr)return;bp.style.height=Math.max(100,Math.min(window.innerHeight-150,sH+(sY-e.clientY)))+'px';resizeCanvas();});
document.addEventListener('mouseup',()=>{dr=false;document.body.style.cursor='';});})();
document.getElementById('topoCanvas').addEventListener('click',function(e){const rect=this.getBoundingClientRect();const mx=e.clientX-rect.left,my=e.clientY-rect.top;const{n,ad}=getN();for(const id of ad){const nd=n[id];if(!nd?.dv)continue;if(Math.sqrt((mx-nd.x)**2+(my-nd.y)**2)<15){openDetail(nd.dv.mac);return;}}});
async function initDash(){initCanvas();updateClock();await fetchData();updateHeader();updateDevs();requestAnimationFrame(render);setInterval(async()=>{await fetchData();updateHeader();updateDevs();},REFRESH);}
document.addEventListener('click',function(e){['alert-panel','theme-panel','sec-menu'].forEach(id=>{const el=document.getElementById(id);if(el.classList.contains('active')&&!el.contains(e.target)&&!e.target.closest('.btn-h'))el.classList.remove('active');});});
</script>
</body>
</html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Netflow by Ealison</title>
<style>
:root{--bg:#060a14;--panel:rgba(8,14,28,0.95);--card:rgba(14,22,42,0.7);--card-hover:rgba(18,28,52,0.85);--border:rgba(255,255,255,0.06);--accent1:#00e676;--accent1-dim:rgba(0,230,118,0.1);--accent2:#448aff;--accent2-dim:rgba(68,138,255,0.1);--accent3:#ff9100;--accent3-dim:rgba(255,145,0,0.1);--text-bright:rgba(255,255,255,0.92);--text:rgba(255,255,255,0.7);--muted:rgba(255,255,255,0.35);--red:#ff5252;--purple:#b388ff}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;font-size:12px;overflow:hidden;height:100vh;display:flex;flex-direction:column}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--muted);border-radius:3px}
#login-overlay{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center}
#login-overlay.hidden{display:none}
.login-box{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:32px;width:340px;text-align:center;box-shadow:0 0 8px rgba(68,138,255,0.12)}
.login-box h1{font-size:20px;color:var(--text-bright);margin-bottom:4px}
.login-box .subtitle{color:var(--muted);margin-bottom:20px;font-size:11px}
.login-box input{width:100%;padding:10px 12px;background:var(--card);border:1px solid var(--border);border-radius:7px;color:var(--text-bright);font-size:12px;margin-bottom:12px;outline:none}
.login-box input:focus{border-color:var(--accent2)}
.login-box button{width:100%;padding:10px;background:linear-gradient(135deg,var(--accent2),var(--purple));border:none;border-radius:7px;color:#fff;font-size:13px;font-weight:600;cursor:pointer}
.login-box .error{color:var(--red);font-size:11px;margin-top:6px;display:none}
#app{display:none;flex-direction:column;height:100vh}#app.active{display:flex}
.header{display:flex;justify-content:space-between;padding:6px 14px;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0;align-items:center;height:38px}
.header-left{display:flex;align-items:center;gap:8px}
.header-left h1{font-size:14px;color:var(--text-bright);font-weight:700}
.header-left .brand{color:var(--accent2);font-weight:400;font-size:10px;margin-left:-6px}
.header-right{display:flex;align-items:center;gap:6px;flex-wrap:nowrap}
.stat-pill{display:flex;align-items:center;gap:3px;padding:3px 8px;background:var(--card);border:1px solid var(--border);border-radius:12px;font-size:10px;white-space:nowrap}
.stat-pill .dot{width:5px;height:5px;border-radius:50%}
.stat-pill .dot.green{background:var(--accent1)}.stat-pill .dot.blue{background:var(--accent2)}.stat-pill .dot.orange{background:var(--accent3)}.stat-pill .dot.red{background:var(--red)}
.stat-pill .val{color:var(--text-bright);font-weight:600}
.btn-h{background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);font-size:14px;cursor:pointer;padding:2px 6px;position:relative;line-height:1}
.btn-h:hover{color:var(--text-bright)}
.badge{position:absolute;top:-6px;right:-6px;background:var(--red);color:#fff;font-size:8px;padding:1px 4px;border-radius:8px;font-weight:700}
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
#topo-area{flex:1;position:relative;min-height:200px}
#topoCanvas{position:absolute;inset:0;width:100%;height:100%}
#search-bar{position:absolute;top:8px;left:50%;transform:translateX(-50%);z-index:10;background:var(--card);border:1px solid var(--border);border-radius:20px;padding:5px 14px;color:var(--text-bright);font-size:11px;width:220px;outline:none}
#search-bar:focus{border-color:var(--accent2);width:280px;transition:width .3s}
#search-bar::placeholder{color:var(--muted)}
.sparkline-global{position:absolute;top:6px;right:10px;z-index:10;display:flex;gap:6px;align-items:center}
.sparkline-global canvas{border-radius:4px;background:rgba(0,0,0,0.3)}
.sparkline-label{font-size:8px;color:var(--muted)}
.bottom-panel{flex-shrink:0;height:280px;background:var(--panel);border-top:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.bottom-bar{display:flex;justify-content:space-between;align-items:center;padding:4px 12px;flex-shrink:0;border-bottom:1px solid var(--border)}
.bottom-bar-left{display:flex;align-items:center;gap:10px}
.bottom-bar-left h3{font-size:11px;color:var(--text-bright);font-weight:600}
.sort-btn{background:none;border:1px solid var(--border);border-radius:4px;color:var(--muted);font-size:9px;padding:2px 8px;cursor:pointer}
.sort-btn.active{border-color:var(--accent2);color:var(--accent2)}
.resize-handle{width:100%;height:4px;cursor:ns-resize;background:transparent;flex-shrink:0}
.resize-handle:hover{background:var(--accent2);opacity:0.3}
#device-list{flex:1;overflow-y:auto;overflow-x:hidden;padding:6px 10px;display:flex;flex-wrap:wrap;gap:6px;align-content:flex-start}
.group-label{width:100%;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;padding:2px 0;border-bottom:1px solid var(--border);margin-bottom:2px}
.dev-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px 10px;width:calc(20% - 6px);min-width:230px;cursor:pointer;transition:all .2s}
.dev-card:hover{background:var(--card-hover);border-color:rgba(255,255,255,0.12)}
.dev-card.alert-card{border-color:rgba(255,165,0,0.5);box-shadow:0 0 6px rgba(255,165,0,0.15)}
.dev-card.blocked-card{opacity:0.5;border-color:rgba(255,82,82,0.4)}
.dev-card.offline{opacity:0.45}
.dev-card-top{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.dev-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.dev-info{flex:1;min-width:0}
.dev-info .name{font-size:11px;color:var(--text-bright);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dev-info .ip{font-size:8px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dev-iface{font-size:7px;font-weight:700;padding:2px 5px;border-radius:3px;flex-shrink:0}
.iface-wifi24{background:rgba(0,230,118,0.15);color:var(--accent1)}
.iface-wifi5{background:rgba(68,138,255,0.15);color:var(--accent2)}
.iface-eth{background:rgba(255,145,0,0.15);color:var(--accent3)}
.dev-card-stats{display:flex;gap:6px;font-size:9px;margin-bottom:3px;align-items:center}
.dev-card-stats .up{color:var(--accent1)}.dev-card-stats .down{color:var(--accent2)}.dev-card-stats .total{color:var(--muted)}
.dev-card-stats canvas{border-radius:2px}
.wifi-bar{display:flex;gap:1px;align-items:flex-end;height:10px;margin-left:auto}
.wifi-bar span{width:3px;background:var(--muted);border-radius:1px}
.wifi-bar span.active{background:var(--accent1)}
.wifi-bar.fair span.active{background:var(--accent3)}
.wifi-bar.poor span.active{background:var(--red)}
.online-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.online-dot.on{background:var(--accent1);box-shadow:0 0 4px var(--accent1)}
.online-dot.off{background:var(--red);opacity:0.5}
.traffic-types{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:3px}
.tt-badge{font-size:7px;padding:1px 4px;border-radius:3px;font-weight:600}
.tt-https{background:rgba(0,230,118,0.15);color:#69f0ae}
.tt-dns{background:rgba(68,138,255,0.15);color:#82b1ff}
.tt-stream{background:rgba(255,145,0,0.15);color:#ffab40}
.tt-iot{background:rgba(233,30,99,0.15);color:#f48fb1}
.tt-vpn{background:rgba(179,136,255,0.15);color:#b388ff}
.tt-other{background:rgba(255,255,255,0.06);color:var(--muted)}
.tt-warn{background:rgba(255,165,0,0.2);color:#ffa726}
.tt-alert{background:rgba(255,82,82,0.2);color:#ff5252}
.dev-card-actions{display:flex;gap:4px}
.btn-sm{font-size:8px;padding:2px 6px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer}
.btn-sm:hover{color:var(--text-bright);border-color:rgba(255,255,255,0.2)}
.btn-block.active{background:rgba(255,82,82,0.2);color:var(--red);border-color:rgba(255,82,82,0.4)}
/* Detail modal */
#detail-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center}
#detail-modal.active{display:flex}
.detail-content{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:20px;width:600px;max-width:90vw;max-height:80vh;overflow-y:auto}
.detail-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.detail-header h2{font-size:15px;color:var(--text-bright)}
.detail-close{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.detail-stat{background:var(--card);border-radius:8px;padding:10px}
.detail-stat .ds-label{font-size:9px;color:var(--muted);text-transform:uppercase;margin-bottom:2px}
.detail-stat .ds-val{font-size:16px;color:var(--text-bright);font-weight:700}
.detail-stat .ds-sub{font-size:9px;color:var(--muted)}
.detail-spark{background:var(--card);border-radius:8px;padding:8px;margin-bottom:10px}
.detail-spark canvas{width:100%;height:60px;border-radius:4px}
.detail-conns{max-height:180px;overflow-y:auto}
.detail-conns table{width:100%;font-size:9px;border-collapse:collapse}
.detail-conns th{color:var(--muted);text-align:left;padding:3px 6px;border-bottom:1px solid var(--border);font-weight:600;position:sticky;top:0;background:var(--panel)}
.detail-conns td{padding:3px 6px;border-bottom:1px solid rgba(255,255,255,0.03);color:var(--text)}
.detail-conns tr:hover td{background:rgba(255,255,255,0.03)}
.detail-alerts{margin-top:8px}
.detail-alerts .da-item{display:flex;align-items:center;gap:6px;padding:4px 8px;background:rgba(255,165,0,0.08);border-radius:4px;margin-bottom:3px;font-size:10px}
/* Edit modal */
#edit-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1001;align-items:center;justify-content:center}
#edit-modal.active{display:flex}
.edit-content{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:18px;width:300px}
.edit-content h3{font-size:13px;color:var(--text-bright);margin-bottom:12px}
.edit-content label{font-size:9px;color:var(--muted);display:block;margin-bottom:3px}
.edit-content input,.edit-content select{width:100%;padding:7px 10px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text-bright);font-size:11px;margin-bottom:10px;outline:none}
.edit-btns{display:flex;gap:8px;justify-content:flex-end}
.edit-btns button{padding:6px 14px;border-radius:6px;font-size:11px;cursor:pointer;border:1px solid var(--border)}
.edit-btns .btn-ok{background:var(--accent2);border-color:var(--accent2);color:#fff}
.edit-btns .btn-cancel{background:transparent;color:var(--muted)}
/* Alert panel */
#alert-panel{position:fixed;top:38px;right:0;width:340px;max-height:calc(100vh - 50px);background:var(--panel);border-left:1px solid var(--border);border-bottom:1px solid var(--border);border-radius:0 0 0 8px;z-index:500;display:none;flex-direction:column}
#alert-panel.active{display:flex}
.alert-panel-head{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border)}
.alert-panel-head h3{font-size:12px;color:var(--text-bright)}
.alert-panel-head button{background:none;border:none;color:var(--muted);font-size:9px;cursor:pointer}
#alert-log{flex:1;overflow-y:auto;padding:4px}
.alert-log-item{display:flex;align-items:center;gap:6px;padding:5px 8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:10px}
.al-icon{font-size:12px;flex-shrink:0}
.al-text{flex:1;color:var(--text)}
.al-time{color:var(--muted);font-size:8px;flex-shrink:0}
/* Theme panel */
#theme-panel{position:fixed;top:38px;right:0;width:200px;background:var(--panel);border-left:1px solid var(--border);border-bottom:1px solid var(--border);border-radius:0 0 0 8px;z-index:500;display:none;padding:10px}
#theme-panel.active{display:block}
.theme-btn{display:block;width:100%;padding:5px 8px;margin-bottom:3px;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:10px;cursor:pointer;text-align:left}
.theme-btn:hover{border-color:var(--accent2)}
.theme-color{display:flex;align-items:center;justify-content:space-between;margin-top:4px;font-size:9px;color:var(--muted)}
.theme-color input[type=color]{width:28px;height:20px;border:none;border-radius:3px;cursor:pointer;background:transparent}
/* Toast */
#alert-toast{position:fixed;top:42px;right:10px;z-index:900;display:flex;flex-direction:column;gap:4px;max-width:380px}
.alert-item{display:flex;align-items:flex-start;gap:6px;padding:8px 10px;background:var(--panel);border:1px solid rgba(255,165,0,0.3);border-radius:8px;animation:slideIn .3s ease;font-size:10px}
.alert-item.critical{border-color:rgba(255,82,82,0.5)}
.a-icon{font-size:14px;flex-shrink:0}
.a-text{flex:1;color:var(--text)}.a-text small{display:block;color:var(--muted);font-size:8px;margin-top:1px}
.a-close{color:var(--muted);cursor:pointer;font-size:12px;flex-shrink:0}
@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}
/* Fullscreen */
.fullscreen-btn{position:absolute;bottom:6px;left:10px;z-index:10;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--muted);font-size:10px;padding:3px 8px;cursor:pointer}
.fullscreen-btn:hover{color:var(--text-bright)}
/* Clock */
.clock{font-size:10px;color:var(--muted);margin-left:4px}
</style>
</head>
<body>
<div id="login-overlay">
<div class="login-box">
<h1>Netflow by Ealison</h1>
<div class="subtitle">OpenWrt Network Monitor</div>
<input type="password" id="login-pass" placeholder="Mot de passe root">
<button onclick="doLogin()">Connexion</button>
<div class="error" id="login-error">Mot de passe incorrect</div>
</div>
</div>
<div id="app">
<div class="header">
<div class="header-left">
<h1>Netflow<span class="brand">by Ealison</span></h1>
<span class="clock" id="clock"></span>
</div>
<div class="header-right" id="header-stats"></div>
<div style="display:flex;gap:4px;align-items:center">
<button class="btn-h" id="alert-btn" onclick="toggleAlertPanel()" title="Alertes">üîî</button>
<button class="btn-h" onclick="toggleThemePanel()" title="Th√®me">üé®</button>
<button class="btn-h" onclick="toggleFullscreen()" title="Plein √©cran">‚õ∂</button>
</div>
</div>
<div class="main-area">
<div id="topo-area">
<canvas id="topoCanvas"></canvas>
<input type="text" id="search-bar" placeholder="üîç Rechercher un appareil...">
<div class="sparkline-global">
<span class="sparkline-label">‚Üë</span>
<canvas id="spark-up" width="80" height="24"></canvas>
<span class="sparkline-label">‚Üì</span>
<canvas id="spark-down" width="80" height="24"></canvas>
</div>
<button class="fullscreen-btn" onclick="toggleFullscreen()">‚õ∂ Plein √©cran</button>
</div>
<div class="resize-handle" id="resize-handle"></div>
<div class="bottom-panel" id="bottom-panel">
<div class="bottom-bar">
<div class="bottom-bar-left">
<h3>Appareils (<span id="dev-count">0</span>)</h3>
<input type="text" id="search-bar-bottom" placeholder="Filtrer..." style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:3px 10px;color:var(--text-bright);font-size:9px;width:130px;outline:none">
</div>
<div style="display:flex;gap:4px">
<button class="sort-btn active" onclick="setSort('interface',this)">Interface</button>
<button class="sort-btn" onclick="setSort('type',this)">Type</button>
<button class="sort-btn" onclick="setSort('traffic',this)">Trafic</button>
<button class="sort-btn" onclick="setSort('name',this)">Nom</button>
<button class="sort-btn" onclick="setSort('alerts',this)">Alertes</button>
<button class="sort-btn" onclick="setSort('status',this)">√âtat</button>
</div>
</div>
<div id="device-list"></div>
</div>
</div>
</div>
<div id="detail-modal" onclick="if(event.target===this)closeDetail()">
<div class="detail-content" id="detail-body"></div>
</div>
<div id="edit-modal" onclick="if(event.target===this)closeEdit()">
<div class="edit-content">
<h3>Modifier l'appareil</h3>
<input type="hidden" id="edit-mac">
<label>Nom</label>
<input type="text" id="edit-name" placeholder="Nom personnalis√©">
<label>Type</label>
<select id="edit-type">
<option value="auto">Auto</option><option value="pc">PC</option><option value="laptop">Laptop</option>
<option value="phone">T√©l√©phone</option><option value="tablet">Tablette</option><option value="camera">Cam√©ra</option>
<option value="iot">IoT</option><option value="tv">TV</option><option value="printer">Imprimante</option>
<option value="server">Serveur</option><option value="switch">Switch/Plug</option><option value="other">Autre</option>
</select>
<div class="edit-btns">
<button class="btn-cancel" onclick="closeEdit()">Annuler</button>
<button class="btn-ok" onclick="saveDevice()">OK</button>
</div>
</div>
</div>
<div id="alert-panel">
<div class="alert-panel-head">
<h3>Alertes s√©curit√©</h3>
<button onclick="clearAlerts()">Tout effacer</button>
</div>
<div id="alert-log"></div>
</div>
<div id="theme-panel">
<button class="theme-btn" onclick="applyPreset('default')">D√©faut</button>
<button class="theme-btn" onclick="applyPreset('ocean')">Oc√©an</button>
<button class="theme-btn" onclick="applyPreset('fire')">Feu</button>
<button class="theme-btn" onclick="applyPreset('matrix')">Matrix</button>
<button class="theme-btn" onclick="applyPreset('purple')">Violet</button>
<div class="theme-color"><span>Accent 1</span><input type="color" id="tc1" value="#00e676" onchange="applyCC()"></div>
<div class="theme-color"><span>Accent 2</span><input type="color" id="tc2" value="#448aff" onchange="applyCC()"></div>
<div class="theme-color"><span>Accent 3</span><input type="color" id="tc3" value="#ff9100" onchange="applyCC()"></div>
<div class="theme-color"><span>Fond</span><input type="color" id="tcbg" value="#060a14" onchange="applyCC()"></div>
</div>
<div id="alert-toast"></div>
<script>
let SID='',DATA={},PB={},DM={},TH={},ALERTS=[],SORT='interface',SEARCH='',canvas,ctx,W,H,parts=[];
let sparkUpH=[],sparkDownH=[],devSparkH={},REFRESH=5000;
const API='/cgi-bin/luci/admin/ubus';
try{DM=JSON.parse(localStorage.getItem('nf_devices')||'{}');}catch(e){}
try{TH=JSON.parse(localStorage.getItem('nf_theme')||'{}');}catch(e){}
try{ALERTS=JSON.parse(localStorage.getItem('nf_alerts')||'[]');}catch(e){}
const PRESETS={default:{a1:'#00e676',a2:'#448aff',a3:'#ff9100',bg:'#060a14'},ocean:{a1:'#00bcd4',a2:'#0288d1',a3:'#26c6da',bg:'#051520'},fire:{a1:'#ff6d00',a2:'#ff1744',a3:'#ffab00',bg:'#140a05'},matrix:{a1:'#00ff41',a2:'#00e676',a3:'#76ff03',bg:'#050a05'},purple:{a1:'#e040fb',a2:'#7c4dff',a3:'#ea80fc',bg:'#0a0514'}};
function setTC(t){const r=document.documentElement.style;r.setProperty('--accent1',t.a1||'#00e676');r.setProperty('--accent2',t.a2||'#448aff');r.setProperty('--accent3',t.a3||'#ff9100');r.setProperty('--bg',t.bg||'#060a14');r.setProperty('--accent1-dim',(t.a1||'#00e676')+'1a');r.setProperty('--accent2-dim',(t.a2||'#448aff')+'1a');r.setProperty('--accent3-dim',(t.a3||'#ff9100')+'1a');document.body.style.background=t.bg||'#060a14';document.getElementById('tc1').value=t.a1||'#00e676';document.getElementById('tc2').value=t.a2||'#448aff';document.getElementById('tc3').value=t.a3||'#ff9100';document.getElementById('tcbg').value=t.bg||'#060a14';}
function applyPreset(n){TH=Object.assign({},PRESETS[n]||PRESETS.default);setTC(TH);localStorage.setItem('nf_theme',JSON.stringify(TH));}
function applyCC(){TH={a1:document.getElementById('tc1').value,a2:document.getElementById('tc2').value,a3:document.getElementById('tc3').value,bg:document.getElementById('tcbg').value};setTC(TH);localStorage.setItem('nf_theme',JSON.stringify(TH));}
function toggleThemePanel(){document.getElementById('theme-panel').classList.toggle('active');document.getElementById('alert-panel').classList.remove('active');}
function toggleAlertPanel(){document.getElementById('alert-panel').classList.toggle('active');document.getElementById('theme-panel').classList.remove('active');renderAlertLog();}
function toggleFullscreen(){if(!document.fullscreenElement)document.documentElement.requestFullscreen();else document.exitFullscreen();}
if(TH.a1)setTC(TH);
async function doLogin(){const pw=document.getElementById('login-pass').value;try{const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:1,method:'call',params:['00000000000000000000000000000000','session','login',{username:'root',password:pw}]})});const d=await r.json();if(d.result?.[0]===0&&d.result?.[1]?.ubus_rpc_session){SID=d.result[1].ubus_rpc_session;document.getElementById('login-overlay').classList.add('hidden');document.getElementById('app').classList.add('active');initDash();}else showErr();}catch(e){showErr();}}
function showErr(){const el=document.getElementById('login-error');el.style.display='block';setTimeout(()=>el.style.display='none',3000);}
document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
async function ubus(o,m,p={}){try{const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:1,method:'call',params:[SID,o,m,p]})});const d=await r.json();if(d.error?.code===-32002){location.reload();return null;}return d.result?.[1]||null;}catch(e){return null;}}
function fmtB(b){if(!b||b<0)return'0 B';if(b<1024)return b.toFixed?b.toFixed(0)+' B':b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';if(b<1073741824)return(b/1048576).toFixed(1)+' MB';return(b/1073741824).toFixed(2)+' GB';}
function fmtS(s){if(!s||s<0)return'0 B/s';if(s<1024)return s.toFixed(0)+' B/s';if(s<1048576)return(s/1024).toFixed(1)+' KB/s';return(s/1048576).toFixed(2)+' MB/s';}
function fmtU(s){if(!s)return'--';const d=Math.floor(s/86400),h=Math.floor(s%86400/3600),m=Math.floor(s%3600/60);return(d?d+'j ':'')+(h+'h ')+m+'m';}
function dType(h,mac){const m=DM[mac];if(m?.type&&m.type!=='auto')return m.type;const n=(h||'').toLowerCase();if(/desktop|pc/i.test(n))return'pc';if(/laptop/i.test(n))return'laptop';if(/galaxy|iphone|pixel|motorola|huawei|redmi|samsung|phone|edge|fold/i.test(n))return'phone';if(/ipad|tab/i.test(n))return'tablet';if(/cam|ipc|nomi|blink|tapo/i.test(n))return'camera';if(/meross|switch|plug|sonoff|shelly/i.test(n))return'switch';if(/tv|roku|chromecast/i.test(n))return'tv';if(/print|epson|canon|npi/i.test(n))return'printer';if(/home.?ass|hass|nas|server|rasp/i.test(n))return'server';if(/sensor|capteur|esp|devolo|supercap/i.test(n))return'iot';return'other';}
const IC={pc:'üíª',laptop:'üíª',phone:'üì±',tablet:'üì±',camera:'üì∑',switch:'üîå',tv:'üì∫',printer:'üñ®',server:'üñ•',iot:'üì°',other:'‚ùì'};
function tCol(t){return{pc:'#448aff',laptop:'#448aff',phone:'#00e676',tablet:'#00e676',camera:'#ff9100',switch:'#ff9100',tv:'#b388ff',printer:'#546e7a',server:'#18ffff',iot:'#ff9100',other:'#546e7a'}[t]||'#546e7a';}
function clsTraf(es){const t=new Set();for(const e of es){const d=e.dport,s=e.sport;if(d===443||s===443)t.add('HTTPS');else if(d===80||s===80)t.add('HTTP');else if(d===53||s===53)t.add('DNS');else if(d===9993||s===9993)t.add('ZT');else if(d===1883||d===8883)t.add('MQTT');else if(d===5353)t.add('mDNS');else if([554,8554,8080,8443,34567].includes(d))t.add('Stream');else if([51820,1194].includes(d))t.add('VPN');else t.add('Other');}return[...t].slice(0,5);}
const TTC={HTTPS:'tt-https',HTTP:'tt-https',DNS:'tt-dns',Stream:'tt-stream',MQTT:'tt-iot',mDNS:'tt-dns',ZT:'tt-vpn',VPN:'tt-vpn',Other:'tt-other'};
/* Alert system */
const SENSITIVE_PORTS=[21,22,23,25,135,139,445,3306,3389,5900,6379,8080,8888,9200,27017];
const PORT_NAMES={21:'FTP',22:'SSH',23:'Telnet',25:'SMTP',135:'RPC',139:'NetBIOS',445:'SMB',3306:'MySQL',3389:'RDP',5900:'VNC',6379:'Redis',8080:'HTTP-Alt',8888:'HTTP-Alt',9200:'Elastic',27017:'MongoDB'};
let alertCooldown={};
function analyzeDevice(dev,ct){
const alerts=[];
const now=Date.now();
const cdKey=dev.mac;
const lastAlert=alertCooldown[cdKey]||0;
if(now-lastAlert<30000)return alerts;
if(dev.conn>50){alerts.push({level:'warn',msg:dev.hostname+': '+dev.conn+' connexions actives',detail:'Nombre inhabituellement √©lev√©',dev:dev.mac});}
if(dev.ts+dev.rs>5000000){alerts.push({level:'warn',msg:dev.hostname+': d√©bit '+fmtS(dev.ts+dev.rs),detail:'Trafic tr√®s √©lev√©',dev:dev.mac});}
if(dev.tx+dev.rx>100000000){alerts.push({level:'info',msg:dev.hostname+': '+fmtB(dev.tx+dev.rx)+' √©chang√©s',detail:'Volume important depuis connexion',dev:dev.mac});}
const devCt=ct.filter(e=>e.src===dev.ip||e.dst===dev.ip);
const sensitivePorts=new Set();
devCt.forEach(e=>{if(SENSITIVE_PORTS.includes(e.dport))sensitivePorts.add(e.dport);if(SENSITIVE_PORTS.includes(e.sport))sensitivePorts.add(e.sport);});
if(sensitivePorts.size>0){const pN=[...sensitivePorts].map(p=>PORT_NAMES[p]||p).join(', ');alerts.push({level:'alert',msg:dev.hostname+': ports sensibles ('+pN+')',detail:'Ports: '+[...sensitivePorts].join(', '),dev:dev.mac});}
const dstIPs=new Set(devCt.filter(e=>e.src===dev.ip).map(e=>e.dst));
if(dstIPs.size>30){alerts.push({level:'warn',msg:dev.hostname+': '+dstIPs.size+' destinations',detail:'Possible scan ou comportement anormal',dev:dev.mac});}
if(['camera','iot','switch'].includes(dev.type)&&dstIPs.size>10){alerts.push({level:'warn',msg:dev.hostname+' (IoT): '+dstIPs.size+' dest.',detail:'IoT avec trop de connexions sortantes',dev:dev.mac});}
if(dev.blocked&&dev.conn>0){alerts.push({level:'alert',msg:dev.hostname+': trafic malgr√© blocage!',detail:dev.conn+' connexions alors que bloqu√©',dev:dev.mac});}
if(alerts.length>0)alertCooldown[cdKey]=now;
return alerts;
}
function addAlert(alert){
const key=alert.msg;
if(ALERTS.find(a=>a.msg===key&&Date.now()-a.ts<60000))return;
const item={...alert,ts:Date.now(),id:Math.random().toString(36).substr(2,6)};
ALERTS.unshift(item);
if(ALERTS.length>200)ALERTS.length=200;
localStorage.setItem('nf_alerts',JSON.stringify(ALERTS));
showToast(item);
updateAlertBadge();
}
function showToast(item){const c=document.getElementById('alert-toast');const cls=item.level==='alert'?'critical':'';const icon=item.level==='alert'?'üö®':item.level==='warn'?'‚ö†Ô∏è':'‚ÑπÔ∏è';const el=document.createElement('div');el.className='alert-item '+cls;el.innerHTML='<span class="a-icon">'+icon+'</span><div class="a-text">'+item.msg+'<small>'+item.detail+'</small></div><span class="a-close" onclick="this.parentElement.remove()">‚úï</span>';c.appendChild(el);setTimeout(()=>{if(el.parentElement)el.remove();},8000);}
function updateAlertBadge(){const recent=ALERTS.filter(a=>Date.now()-a.ts<600000).length;const btn=document.getElementById('alert-btn');const ex=btn.querySelector('.badge');if(ex)ex.remove();if(recent>0){const b=document.createElement('span');b.className='badge';b.textContent=recent;btn.appendChild(b);}}
function renderAlertLog(){const c=document.getElementById('alert-log');if(!ALERTS.length){c.innerHTML='<div style="color:var(--muted);font-size:10px;padding:10px">Aucune alerte</div>';return;}c.innerHTML=ALERTS.slice(0,80).map(a=>{const icon=a.level==='alert'?'üö®':a.level==='warn'?'‚ö†Ô∏è':'‚ÑπÔ∏è';const ago=Math.floor((Date.now()-a.ts)/60000);const ts=ago<1?'maintenant':ago+'min';return'<div class="alert-log-item"><span class="al-icon">'+icon+'</span><div class="al-text">'+a.msg+'</div><span class="al-time">'+ts+'</span></div>';}).join('');}
function clearAlerts(){ALERTS=[];localStorage.setItem('nf_alerts','[]');renderAlertLog();updateAlertBadge();}
/* Sparkline helper */
function drawSparkline(cvs,data,color,maxV){const c=cvs.getContext('2d');const w=cvs.width,h=cvs.height;c.clearRect(0,0,w,h);if(data.length<2)return;const mx=maxV||Math.max(...data,1);c.beginPath();c.moveTo(0,h);data.forEach((v,i)=>{const x=i/(data.length-1)*w,y=h-Math.min(v/mx,1)*h*.85;if(i===0)c.moveTo(x,y);else c.lineTo(x,y);});c.lineTo(w,h);c.lineTo(0,h);c.fillStyle=color+'20';c.fill();c.beginPath();data.forEach((v,i)=>{const x=i/(data.length-1)*w,y=h-Math.min(v/mx,1)*h*.85;if(i===0)c.moveTo(x,y);else c.lineTo(x,y);});c.strokeStyle=color;c.lineWidth=1.2;c.stroke();}
function wifiQuality(sig){if(!sig)return{level:0,label:'--',cls:''};const s=sig;if(s>=-50)return{level:4,label:'Excellent',cls:''};if(s>=-60)return{level:3,label:'Bon',cls:''};if(s>=-70)return{level:2,label:'Moyen',cls:'fair'};return{level:1,label:'Faible',cls:'poor'};}
function wifiBarsHTML(sig){const q=wifiQuality(sig);const heights=[3,5,7,10];let html='<div class="wifi-bar '+q.cls+'" title="'+q.label+' ('+sig+'dBm)">';for(let i=0;i<4;i++){html+='<span style="height:'+heights[i]+'px" class="'+(i<q.level?'active':'')+'"></span>';}return html+'</div>';}
function isOnline(dev){return dev.conn>0||dev.ts>0||dev.rs>0;}
/* Clock */
function updateClock(){const now=new Date();document.getElementById('clock').textContent=now.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});}
setInterval(updateClock,1000);
async function fetchData(){
const[si,ifd,dh,ctR,w24,w5,iw0]=await Promise.all([ubus('system','info'),ubus('network.interface','dump'),ubus('luci-rpc','getDHCPLeases'),ubus('luci','getConntrackList'),ubus('iwinfo','assoclist',{device:'phy0-ap0'}),ubus('iwinfo','assoclist',{device:'wlan1'}),ubus('iwinfo','info',{device:'phy0-ap0'})]);
const ct=ctR?(Array.isArray(ctR)?ctR:(ctR.result||[])):[];const ls=dh?.dhcp_leases||[];
const w24M=(w24?.results||[]).map(c=>c.mac?.toUpperCase());const w5M=(w5?.results||[]).map(c=>c.mac?.toUpperCase());
const wC={};(w24?.results||[]).forEach(c=>{wC[c.mac?.toUpperCase()]=c;});(w5?.results||[]).forEach(c=>{wC[c.mac?.toUpperCase()]=c;});
const now=Date.now();
const devs=ls.map(l=>{
const mac=l.macaddr?.toUpperCase(),mt=DM[mac]||{};
let iface='eth';if(w24M.includes(mac))iface='wifi24';else if(w5M.includes(mac))iface='wifi5';
const dCt=ct.filter(e=>e.src===l.ipaddr||e.dst===l.ipaddr);
const tx=dCt.filter(e=>e.src===l.ipaddr).reduce((s,e)=>s+(e.bytes||0),0);
const rx=dCt.filter(e=>e.dst===l.ipaddr).reduce((s,e)=>s+(e.bytes||0),0);
const pk=mac+'t',pkr=mac+'r';let ts=0,rs=0;
if(PB[pk]){const dt=(now-PB[pk].t)/1000;if(dt>0&&dt<30){ts=Math.max(0,(tx-PB[pk].v)/dt);rs=Math.max(0,(rx-PB[pkr].v)/dt);}}
PB[pk]={v:tx,t:now};PB[pkr]={v:rx,t:now};
if(!devSparkH[mac])devSparkH[mac]={up:[],down:[]};
devSparkH[mac].up.push(ts);devSparkH[mac].down.push(rs);
if(devSparkH[mac].up.length>30)devSparkH[mac].up.shift();
if(devSparkH[mac].down.length>30)devSparkH[mac].down.shift();
const dev={hostname:mt.name||l.hostname||mac,ip:l.ipaddr,mac,iface,type:dType(l.hostname,mac),conn:dCt.length,tx,rx,ts,rs,tt:clsTraf(dCt),sig:wC[mac]?.signal||null,blocked:mt.blocked||false,alerts:[],dCt};
dev.alerts=analyzeDevice(dev,ct);
dev.alerts.forEach(a=>addAlert(a));
return dev;
});
const totalUp=devs.reduce((s,d)=>s+d.ts,0);
const totalDown=devs.reduce((s,d)=>s+d.rs,0);
sparkUpH.push(totalUp);sparkDownH.push(totalDown);
if(sparkUpH.length>60)sparkUpH.shift();
if(sparkDownH.length>60)sparkDownH.shift();
DATA={sys:si,wan:ifd?.interface?.find(i=>i.interface==='wan'),devs,ct,ssid:iw0?.ssid||'WiFi',conns:ct.length,ts:now};
}
function updateHeader(){
const d=DATA,up=d.sys?.uptime||0,cn=d.conns||0,dc=d.devs?.length||0;
const wUp=d.wan?.up,wIP=d.wan?.['ipv4-address']?.[0]?.address||'--';
const tT=d.devs?.reduce((s,v)=>s+v.ts,0)||0,tR=d.devs?.reduce((s,v)=>s+v.rs,0)||0;
const alertCount=d.devs?.reduce((s,v)=>s+v.alerts.length,0)||0;
const onCount=d.devs?.filter(v=>isOnline(v)).length||0;
document.getElementById('header-stats').innerHTML=
'<div class="stat-pill"><span class="dot '+(wUp?'green':'red')+'"></span>WAN <span class="val">'+wIP+'</span></div>'+
'<div class="stat-pill"><span class="dot green"></span>‚Üë<span class="val">'+fmtS(tT)+'</span></div>'+
'<div class="stat-pill"><span class="dot blue"></span>‚Üì<span class="val">'+fmtS(tR)+'</span></div>'+
'<div class="stat-pill"><span class="dot orange"></span><span class="val">'+cn+'</span> flux</div>'+
'<div class="stat-pill"><span class="val">'+onCount+'/'+dc+'</span> en ligne</div>'+
(alertCount>0?'<div class="stat-pill"><span class="dot red"></span><span class="val">'+alertCount+'</span> alertes</div>':'')+
'<div class="stat-pill">Up '+fmtU(up)+'</div>';
updateAlertBadge();
drawSparkline(document.getElementById('spark-up'),sparkUpH,'#00e676');
drawSparkline(document.getElementById('spark-down'),sparkDownH,'#448aff');
                                                                                                                                                }
/* Sort & Search */
function setSort(s,btn){SORT=s;document.querySelectorAll('.sort-btn').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');updateDevs();}
function sortDevs(devs){
const list=[...devs];
if(SORT==='interface')list.sort((a,b)=>{const o={wifi24:0,wifi5:1,eth:2};return(o[a.iface]||9)-(o[b.iface]||9)||a.hostname.localeCompare(b.hostname);});
else if(SORT==='type')list.sort((a,b)=>a.type.localeCompare(b.type)||a.hostname.localeCompare(b.hostname));
else if(SORT==='traffic')list.sort((a,b)=>(b.tx+b.rx)-(a.tx+a.rx));
else if(SORT==='name')list.sort((a,b)=>a.hostname.localeCompare(b.hostname));
else if(SORT==='alerts')list.sort((a,b)=>b.alerts.length-a.alerts.length||(b.tx+b.rx)-(a.tx+a.rx));
else if(SORT==='status')list.sort((a,b)=>{const ao=isOnline(a)?0:1,bo=isOnline(b)?0:1;return ao-bo||(b.tx+b.rx)-(a.tx+a.rx);});
return list;
}
function getGroupKey(dev){
if(SORT==='interface')return dev.iface==='wifi24'?'WiFi 2.4GHz':dev.iface==='wifi5'?'WiFi 5GHz':'Ethernet';
if(SORT==='type')return(IC[dev.type]||'?')+' '+dev.type.toUpperCase();
if(SORT==='status')return isOnline(dev)?'üü¢ En ligne':'‚ö™ Hors ligne';
return null;
}
document.getElementById('search-bar').addEventListener('input',e=>{SEARCH=e.target.value.toLowerCase();updateDevs();});
document.getElementById('search-bar-bottom').addEventListener('input',e=>{SEARCH=e.target.value.toLowerCase();updateDevs();});
function updateDevs(){
const c=document.getElementById('device-list');document.getElementById('dev-count').textContent=DATA.devs?.length||0;
if(!DATA.devs)return;
let filtered=DATA.devs;
if(SEARCH){filtered=filtered.filter(d=>d.hostname.toLowerCase().includes(SEARCH)||d.ip.includes(SEARCH)||d.mac.toLowerCase().includes(SEARCH)||d.type.includes(SEARCH));}
const sorted=sortDevs(filtered);let html='',lastGroup='';
sorted.forEach(d=>{
const gk=getGroupKey(d);
if(gk&&gk!==lastGroup){html+='<div class="group-label">'+gk+'</div>';lastGroup=gk;}
const ic=IC[d.type]||'?',co=tCol(d.type);
const ifC=d.iface==='wifi24'?'iface-wifi24':d.iface==='wifi5'?'iface-wifi5':'iface-eth';
const ifL=d.iface==='wifi24'?'WiFi 2.4G':d.iface==='wifi5'?'WiFi 5G':'Ethernet';
const tt=d.tt.map(t=>'<span class="tt-badge '+(TTC[t]||'tt-other')+'">'+t+'</span>').join('');
const on=isOnline(d);
const hasAlert=d.alerts.length>0;
const alertBadges=d.alerts.slice(0,2).map(a=>'<span class="tt-badge '+(a.level==='alert'?'tt-alert':'tt-warn')+'">'+(a.level==='alert'?'üö®':'‚ö†Ô∏è')+' '+a.detail.substring(0,22)+'</span>').join('');
const wBars=d.sig?wifiBarsHTML(d.sig):'';
const sparkId='spk_'+d.mac.replace(/:/g,'');
html+='<div class="dev-card '+(d.blocked?'blocked-card':'')+(hasAlert?' alert-card':'')+(!on?' offline':'')+'" onclick="openDetail(\''+d.mac+'\')">';
html+='<div class="dev-card-top">';
html+='<span class="online-dot '+(on?'on':'off')+'"></span>';
html+='<div class="dev-icon" style="background:'+co+'18;color:'+co+'">'+ic+'</div>';
html+='<div class="dev-info"><div class="name">'+d.hostname+'</div>';
html+='<div class="ip">'+d.ip+' ¬∑ '+d.mac.substring(0,8)+'...'+(d.sig?' ¬∑ '+d.sig+'dBm':'')+'</div></div>';
html+=wBars;
html+='<span class="dev-iface '+ifC+'">'+ifL+'</span></div>';
html+='<div class="dev-card-stats"><span class="up">‚Üë'+fmtS(d.ts)+'</span><span class="down">‚Üì'+fmtS(d.rs)+'</span>';
html+='<span class="total">‚àë'+fmtB(d.tx+d.rx)+'</span><span class="total">¬∑'+d.conn+'c</span>';
html+='<canvas id="'+sparkId+'" width="50" height="16" style="margin-left:auto"></canvas></div>';
html+='<div class="traffic-types">'+tt+alertBadges+'</div>';
html+='<div class="dev-card-actions">';
html+='<button class="btn-sm" onclick="event.stopPropagation();openEdit(\''+d.mac+'\')">‚úèÔ∏è</button>';
html+='<button class="btn-sm btn-block '+(d.blocked?'active':'')+'" onclick="event.stopPropagation();toggleBlock(\''+d.mac+'\')">'+(d.blocked?'üîì':'üîí')+'</button>';
html+='</div></div>';
});
c.innerHTML=html;
sorted.forEach(d=>{
const sparkId='spk_'+d.mac.replace(/:/g,'');
const cvs=document.getElementById(sparkId);
if(cvs&&devSparkH[d.mac]){drawSparkline(cvs,devSparkH[d.mac].up,'#00e676');}
});
}
/* Detail Modal */
function openDetail(mac){
const d=DATA.devs?.find(v=>v.mac===mac);if(!d)return;
const q=wifiQuality(d.sig);
const sh=devSparkH[mac]||{up:[],down:[]};
const topDst={};d.dCt?.filter(e=>e.src===d.ip).forEach(e=>{topDst[e.dst]=(topDst[e.dst]||0)+1;});
const topDstArr=Object.entries(topDst).sort((a,b)=>b[1]-a[1]).slice(0,15);
const body=document.getElementById('detail-body');
body.innerHTML='<div class="detail-header"><h2>'+IC[d.type]+' '+d.hostname+'</h2><button class="detail-close" onclick="closeDetail()">‚úï</button></div>'+
'<div class="detail-grid">'+
'<div class="detail-stat"><div class="ds-label">Adresse IP</div><div class="ds-val">'+d.ip+'</div><div class="ds-sub">MAC: '+d.mac+'</div></div>'+
'<div class="detail-stat"><div class="ds-label">Interface</div><div class="ds-val">'+(d.iface==='wifi24'?'WiFi 2.4GHz':d.iface==='wifi5'?'WiFi 5GHz':'Ethernet')+'</div><div class="ds-sub">'+(d.sig?'Signal: '+d.sig+'dBm ('+q.label+')':'C√¢ble')+'</div></div>'+
'<div class="detail-stat"><div class="ds-label">D√©bit actuel</div><div class="ds-val">‚Üë'+fmtS(d.ts)+' ‚Üì'+fmtS(d.rs)+'</div><div class="ds-sub">Total: '+fmtB(d.tx+d.rx)+'</div></div>'+
'<div class="detail-stat"><div class="ds-label">Connexions</div><div class="ds-val">'+d.conn+'</div><div class="ds-sub">Type: '+d.type+(d.blocked?' ¬∑ üîí BLOQU√â':'')+'</div></div>'+
'</div>'+
'<div class="detail-spark"><div style="font-size:9px;color:var(--muted);margin-bottom:4px">D√©bit temps r√©el (30 derni√®res mesures)</div><canvas id="detail-spark-canvas" width="560" height="60"></canvas></div>'+
(d.alerts.length>0?'<div class="detail-alerts"><div style="font-size:10px;color:var(--accent3);margin-bottom:4px">‚ö†Ô∏è Alertes actives</div>'+d.alerts.map(a=>'<div class="da-item"><span>'+(a.level==='alert'?'üö®':'‚ö†Ô∏è')+'</span><span>'+a.msg+'</span></div>').join('')+'</div>':'')+
'<div style="font-size:10px;color:var(--muted);margin:8px 0 4px">Protocoles: '+d.tt.map(t=>'<span class="tt-badge '+(TTC[t]||'tt-other')+'">'+t+'</span>').join(' ')+'</div>'+
'<div class="detail-conns"><table><thead><tr><th>Destination</th><th>Port</th><th>Proto</th><th>Octets</th></tr></thead><tbody>'+
d.dCt?.slice(0,40).map(e=>{const isOut=e.src===d.ip;return'<tr><td>'+(isOut?e.dst:e.src)+'</td><td>'+(isOut?e.dport:e.sport)+'</td><td>'+(e.layer4||'?')+'</td><td>'+fmtB(e.bytes)+'</td></tr>';}).join('')+
'</tbody></table></div>'+
'<div style="display:flex;gap:6px;margin-top:10px">'+
'<button class="btn-sm" onclick="closeDetail();openEdit(\''+mac+'\')">‚úèÔ∏è Modifier</button>'+
'<button class="btn-sm btn-block '+(d.blocked?'active':'')+'" onclick="toggleBlock(\''+mac+'\');closeDetail();">'+(d.blocked?'üîì D√©bloquer':'üîí Bloquer')+'</button></div>';
document.getElementById('detail-modal').classList.add('active');
setTimeout(()=>{const sc=document.getElementById('detail-spark-canvas');if(sc){const allD=[...sh.up,...sh.down];const mx=Math.max(...allD,100);drawSparkline(sc,sh.up,'#00e676',mx);const c2=sc.getContext('2d');c2.save();c2.globalCompositeOperation='source-over';const w2=sc.width,h2=sc.height;c2.beginPath();sh.down.forEach((v,i)=>{const x=i/(sh.down.length-1)*w2,y=h2-Math.min(v/mx,1)*h2*.85;if(i===0)c2.moveTo(x,y);else c2.lineTo(x,y);});c2.strokeStyle='#448aff';c2.lineWidth=1.2;c2.stroke();c2.restore();}},50);
}
function closeDetail(){document.getElementById('detail-modal').classList.remove('active');}
/* Canvas Topology */
function initCanvas(){canvas=document.getElementById('topoCanvas');ctx=canvas.getContext('2d');resizeCanvas();window.addEventListener('resize',resizeCanvas);}
function resizeCanvas(){const a=document.getElementById('topo-area'),dpr=window.devicePixelRatio||1;W=a.clientWidth;H=a.clientHeight;canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+'px';canvas.style.height=H+'px';ctx.setTransform(dpr,0,0,dpr,0,0);}
function getN(){
const ds=DATA.devs||[];
const cW=50,cR=W*.18,cI=W*.38,cD=W*.56;
const n={};
n.wan={x:cW,y:H/2,l:'WAN',s:DATA.wan?.['ipv4-address']?.[0]?.address||'',c:'#ff9100',r:20};
n.rtr={x:cR,y:H/2,l:'OpenWrt',s:'192.168.10.1',c:'#448aff',r:22};
const activeIfs=[
{id:'wifi24',l:'WiFi 2.4G',s:(DATA.ssid||'')+' ('+ds.filter(d=>d.iface==='wifi24').length+')',c:'#00e676',d:ds.filter(d=>d.iface==='wifi24')},
{id:'wifi5',l:'WiFi 5G',s:ds.filter(d=>d.iface==='wifi5').length+' clients',c:'#448aff',d:ds.filter(d=>d.iface==='wifi5')},
{id:'eth',l:'Ethernet',s:'br-lan ('+ds.filter(d=>d.iface==='eth').length+')',c:'#ff9100',d:ds.filter(d=>d.iface==='eth')}
].filter(f=>f.d.length>0);
const sp=Math.min(H/(activeIfs.length+1),90);
const sy=H/2-(activeIfs.length-1)*sp/2;
activeIfs.forEach((f,i)=>{n['i_'+f.id]={x:cI,y:sy+i*sp,l:f.l,s:f.s,c:f.c,r:16,d:f.d};});
const ad=[];
activeIfs.forEach(f=>{
const ifN=n['i_'+f.id];const dl=f.d;
const maxPerCol=Math.max(1,Math.floor((H-20)/28));
dl.forEach((d,i)=>{
const col=Math.floor(i/maxPerCol),row=i%maxPerCol;
const inThisCol=Math.min(dl.length-col*maxPerCol,maxPerCol);
const x=cD+col*110;
const yStart=ifN.y-(inThisCol-1)*14;
const y=yStart+row*28;
const id='d_'+d.mac.replace(/:/g,'');
const on=isOnline(d);
n[id]={x,y,l:d.hostname.substring(0,12),s:'',c:d.alerts?.length>0?'#ff5252':on?f.c:'#37474f',r:on?8:5,dv:d};
ad.push(id);
});
});
return{n,ifs:activeIfs,ad};
}
function drawN(nd){const{x,y,l,s,c,r}=nd;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=c+'12';ctx.fill();ctx.strokeStyle=c+'44';ctx.lineWidth=0.7;ctx.stroke();ctx.beginPath();ctx.arc(x,y,2.5,0,Math.PI*2);ctx.fillStyle=c;ctx.fill();ctx.font='bold '+(r>14?'9':'7')+'px sans-serif';ctx.fillStyle='#b0bec5';ctx.textAlign='center';ctx.fillText(l,x,y+r+9);if(s){ctx.font='7px sans-serif';ctx.fillStyle='#546e7a';ctx.fillText(s,x,y+r+17);}}
function drawL(x1,y1,x2,y2,c,w){ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.strokeStyle=(c||'#fff')+'20';ctx.lineWidth=w||0.6;ctx.stroke();}
class Pt{constructor(a,b,c,d,col,sp,sz){this.a=a;this.b=b;this.c=c;this.d=d;this.col=col;this.sp=sp||.008;this.sz=sz||1.5;this.t=Math.random();}update(){this.t+=this.sp;if(this.t>=1)this.t=0;}draw(x){const px=this.a+(this.c-this.a)*this.t,py=this.b+(this.d-this.b)*this.t;x.beginPath();x.arc(px,py,this.sz,0,Math.PI*2);x.fillStyle=this.col;x.fill();}}
function updParts(){const{n,ifs}=getN();const nd=[];
const wT=DATA.devs?.reduce((s,d)=>s+d.ts+d.rs,0)||0;
const wC=Math.max(1,Math.min(6,Math.floor(wT/30000)+1));
const wLW=Math.max(0.8,Math.min(3,wT/200000));
for(let i=0;i<wC;i++){nd.push({a:n.wan.x,b:n.wan.y,c:n.rtr.x,d:n.rtr.y,col:'#ff9100',sp:.004+Math.random()*.006,sz:1.2+Math.random()*.8});nd.push({a:n.rtr.x,b:n.rtr.y,c:n.wan.x,d:n.wan.y,col:'#448aff',sp:.004+Math.random()*.006,sz:1.2+Math.random()*.8});}
ifs.forEach(f=>{const ifN=n['i_'+f.id];if(!ifN)return;const iT=f.d.reduce((s,d)=>s+d.ts+d.rs,0);const c=Math.max(1,Math.min(4,Math.floor(iT/20000)+1));
for(let i=0;i<c;i++){nd.push({a:n.rtr.x,b:n.rtr.y,c:ifN.x,d:ifN.y,col:f.c,sp:.003+Math.random()*.005,sz:1+Math.random()*.6});nd.push({a:ifN.x,b:ifN.y,c:n.rtr.x,d:n.rtr.y,col:f.c+'aa',sp:.003+Math.random()*.005,sz:.8+Math.random()*.5});}
f.d.forEach(dv=>{const did='d_'+dv.mac.replace(/:/g,''),dn=n[did];if(!dn)return;if(dv.ts>0||dv.conn>0){const intensity=Math.max(1,Math.min(3,Math.floor((dv.ts+dv.rs)/10000)+1));for(let i=0;i<intensity;i++){nd.push({a:dn.x,b:dn.y,c:ifN.x,d:ifN.y,col:'#00e676',sp:.004+Math.random()*.007,sz:.6+Math.random()*.5});nd.push({a:ifN.x,b:ifN.y,c:dn.x,d:dn.y,col:'#448aff',sp:.004+Math.random()*.007,sz:.6+Math.random()*.5});}}});});
while(parts.length<nd.length){const p=nd[parts.length%nd.length];parts.push(new Pt(p.a,p.b,p.c,p.d,p.col,p.sp,p.sz));}
while(parts.length>nd.length+10)parts.pop();
parts.forEach((p,i)=>{if(nd[i%nd.length]){const q=nd[i%nd.length];p.a=q.a;p.b=q.b;p.c=q.c;p.d=q.d;p.col=q.col;}});}
let lPU=0;
function render(t){
ctx.clearRect(0,0,W,H);
ctx.strokeStyle='rgba(255,255,255,0.015)';ctx.lineWidth=0.5;
for(let x=0;x<W;x+=60){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
for(let y=0;y<H;y+=60){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
const{n,ifs,ad}=getN();
const wT=DATA.devs?.reduce((s,d)=>s+d.ts+d.rs,0)||0;
const wLW=Math.max(0.8,Math.min(3,wT/200000+0.8));
drawL(n.wan.x,n.wan.y,n.rtr.x,n.rtr.y,'#ff9100',wLW);
ifs.forEach(f=>{const ifN=n['i_'+f.id];if(!ifN)return;
const iT=f.d.reduce((s,d)=>s+d.ts+d.rs,0);
const iLW=Math.max(0.5,Math.min(2,iT/100000+0.5));
drawL(n.rtr.x,n.rtr.y,ifN.x,ifN.y,f.c,iLW);
f.d.forEach(dv=>{const did='d_'+dv.mac.replace(/:/g,''),dn=n[did];if(dn){
const dLW=Math.max(0.3,Math.min(1.5,(dv.ts+dv.rs)/50000+0.3));
drawL(ifN.x,ifN.y,dn.x,dn.y,dn.c,dLW);}});});
if(t-lPU>2500){updParts();lPU=t;}
parts.forEach(p=>{p.update();p.draw(ctx);});
drawN(n.wan);drawN(n.rtr);
ifs.forEach(f=>{const ifN=n['i_'+f.id];if(ifN)drawN(ifN);});
ad.forEach(id=>{if(n[id])drawN(n[id]);});
const ang=(t*.0006)%(Math.PI*2);
ctx.save();ctx.globalAlpha=0.05;ctx.beginPath();ctx.moveTo(n.rtr.x,n.rtr.y);ctx.arc(n.rtr.x,n.rtr.y,35,ang,ang+.6);ctx.closePath();ctx.fillStyle='#448aff';ctx.fill();ctx.restore();
requestAnimationFrame(render);
}
/* Edit / Block */
function openEdit(mac){const mt=DM[mac]||{},dv=DATA.devs?.find(d=>d.mac===mac);document.getElementById('edit-mac').value=mac;document.getElementById('edit-name').value=mt.name||dv?.hostname||'';document.getElementById('edit-type').value=mt.type||'auto';document.getElementById('edit-modal').classList.add('active');}
function closeEdit(){document.getElementById('edit-modal').classList.remove('active');}
function saveDevice(){const mac=document.getElementById('edit-mac').value,nm=document.getElementById('edit-name').value.trim(),tp=document.getElementById('edit-type').value;if(!DM[mac])DM[mac]={};if(nm)DM[mac].name=nm;else delete DM[mac].name;DM[mac].type=tp;localStorage.setItem('nf_devices',JSON.stringify(DM));closeEdit();updateDevs();}
async function toggleBlock(mac){const dv=DATA.devs?.find(d=>d.mac===mac);if(!dv)return;if(!DM[mac])DM[mac]={};
if(DM[mac].blocked){DM[mac].blocked=false;await ubus('uci','delete',{config:'firewall',type:'rule',match:{name:'nf_block_'+mac.replace(/:/g,'')}});await ubus('uci','commit',{config:'firewall'});await ubus('luci','setInitAction',{name:'firewall',action:'restart'});}
else{DM[mac].blocked=true;await ubus('uci','add',{config:'firewall',type:'rule',name:'nf_block_'+mac.replace(/:/g,''),values:{name:'nf_block_'+mac.replace(/:/g,''),src:'lan',dest:'wan',src_ip:dv.ip,target:'DROP',enabled:'1'}});await ubus('uci','commit',{config:'firewall'});await ubus('luci','setInitAction',{name:'firewall',action:'restart'});}
localStorage.setItem('nf_devices',JSON.stringify(DM));updateDevs();}
/* Resize handle */
(function(){const h=document.getElementById('resize-handle'),bp=document.getElementById('bottom-panel');let dragging=false,startY,startH;
h.addEventListener('mousedown',e=>{dragging=true;startY=e.clientY;startH=bp.offsetHeight;document.body.style.cursor='ns-resize';e.preventDefault();});
document.addEventListener('mousemove',e=>{if(!dragging)return;const dy=startY-e.clientY;bp.style.height=Math.max(100,Math.min(window.innerHeight-150,startH+dy))+'px';resizeCanvas();});
document.addEventListener('mouseup',()=>{dragging=false;document.body.style.cursor='';});})();
/* Canvas click -> device detail */
canvas?.addEventListener?.('click',function(e){});
document.getElementById('topoCanvas').addEventListener('click',function(e){
const rect=this.getBoundingClientRect();const mx=e.clientX-rect.left,my=e.clientY-rect.top;
const{n,ad}=getN();
for(const id of ad){const nd=n[id];if(!nd||!nd.dv)continue;const dx=mx-nd.x,dy=my-nd.y;if(Math.sqrt(dx*dx+dy*dy)<15){openDetail(nd.dv.mac);return;}}
});
/* Init */
async function initDash(){initCanvas();updateClock();await fetchData();updateHeader();updateDevs();requestAnimationFrame(render);setInterval(async()=>{await fetchData();updateHeader();updateDevs();},REFRESH);}
document.addEventListener('click',function(e){const tp=document.getElementById('theme-panel'),ap=document.getElementById('alert-panel');if(tp.classList.contains('active')&&!tp.contains(e.target)&&!e.target.closest('.btn-h'))tp.classList.remove('active');if(ap.classList.contains('active')&&!ap.contains(e.target)&&!e.target.closest('.btn-h'))ap.classList.remove('active');});
</script>
</body>
</html>
