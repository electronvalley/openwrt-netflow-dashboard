<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Netflow by Ealison</title>
<style>
:root{--bg:#060a14;--panel:rgba(14,28,50,0.95);--card:rgba(14,22,42,0.7);--card-hover:rgba(18,28,52,0.85);--border:rgba(255,255,255,0.06);--accent1:#00e676;--accent-dim:rgba(0,230,118,0.1);--accent2:#448aff;--accent2-dim:rgba(68,138,255,0.15);--accent3:rgb(255,152,0);--purple:rgb(156,39,176);--red:#f44336;--text-bright:rgba(255,255,255,0.95);--text:rgba(255,255,255,0.7);--muted:rgba(255,255,255,0.4)}
.light{--bg:#f0f2f5;--panel:rgba(255,255,255,0.97);--card:rgba(240,242,248,0.9);--card-hover:rgba(230,235,245,0.95);--border:rgba(0,0,0,0.08);--accent1:#00a152;--accent-dim:rgba(0,161,82,0.1);--accent2:#1565c0;--accent2-dim:rgba(21,101,192,0.1);--accent3:rgb(230,130,0);--purple:rgb(140,30,160);--red:#d32f2f;--text-bright:rgba(0,0,0,0.9);--text:rgba(0,0,0,0.7);--muted:rgba(0,0,0,0.4)}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;font-size:12px;overflow:hidden;height:100vh;display:flex;flex-direction:column;transition:background .3s,color .3s}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--muted);border-radius:3px}
#login-overlay{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center}
#login-overlay.hidden{display:none}
.login-box{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:32px;width:340px;text-align:center;box-shadow:0 0 8px rgba(68,138,255,0.12)}
.login-box h1{font-size:20px;color:var(--text-bright);margin-bottom:4px}
.login-box .subtitle{color:var(--muted);margin-bottom:20px;font-size:11px}
.login-box input{width:100%;padding:10px 12px;background:var(--card);border:1px solid var(--border);border-radius:7px;color:var(--text-bright);font-size:12px;margin-bottom:12px;outline:none}
.login-box input:focus{border-color:var(--accent2)}
.login-box button{width:100%;padding:10px;background:linear-gradient(135deg,var(--accent2),var(--purple));border:none;border-radius:7px;color:#fff;font-size:13px;font-weight:600;cursor:pointer}
.login-box .error{color:var(--red);font-size:11px;margin-top:6px;display:none}
#app{display:none;flex-direction:column;height:100vh}#app.active{display:flex}
.header{display:flex;justify-content:space-between;padding:6px 14px;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0;align-items:center;height:38px}
.header-left{display:flex;align-items:center;gap:8px}
.header-left h1{font-size:14px;color:var(--text-bright);font-weight:700}
.header-left .brand{color:var(--accent2);font-weight:400;font-size:10px;margin-left:-6px}
.header-right{display:flex;align-items:center;gap:6px;flex-wrap:nowrap}
.stat-pill{display:flex;align-items:center;gap:3px;padding:3px 8px;background:var(--card);border:1px solid var(--border);border-radius:12px;font-size:10px;white-space:nowrap}
.stat-pill .dot{width:5px;height:5px;border-radius:50%}
.stat-pill .dot.green{background:var(--accent1)}.stat-pill .dot.blue{background:var(--accent2)}.stat-pill .dot.orange{background:var(--accent3)}.stat-pill .dot.red{background:var(--red)}
.stat-pill .val{color:var(--text-bright);font-weight:600}
.icon-btn{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:3px 7px;cursor:pointer;font-size:12px;color:var(--text);transition:all .2s}
.icon-btn:hover{background:var(--card-hover);border-color:var(--accent2)}
.icon-btn.active{background:var(--accent2-dim);border-color:var(--accent2);color:var(--accent2)}
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
canvas{flex:1;display:block}
.panel-overlay{position:fixed;top:38px;right:0;width:320px;max-height:calc(100vh - 38px);background:var(--panel);border-left:1px solid var(--border);z-index:100;overflow-y:auto;display:none;padding:12px}
.panel-overlay.visible{display:block}
.panel-overlay h3{font-size:13px;color:var(--text-bright);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between}
.panel-overlay h3 .close-btn{cursor:pointer;font-size:16px;color:var(--muted)}
.panel-overlay h3 .close-btn:hover{color:var(--text-bright)}
.alert-card{background:var(--card);border:2px solid var(--accent3);border-radius:8px;padding:8px 10px;margin-bottom:6px;font-size:10px;box-shadow:0 0 8px rgba(255,152,0,0.15)}
.alert-card-critical{border-color:var(--red);box-shadow:0 0 8px rgba(244,67,54,0.2)}
.alert-card .alert-title{color:var(--accent3);font-weight:600;margin-bottom:3px;font-size:11px}
.alert-card-critical .alert-title{color:var(--red)}
.alert-card .alert-detail{color:var(--text)}
.theme-option{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:6px;cursor:pointer;margin-bottom:4px;border:1px solid transparent}
.theme-option:hover{background:var(--card-hover)}
.theme-option.active{border-color:var(--accent2);background:var(--accent2-dim)}
.theme-swatch{width:20px;height:20px;border-radius:50%;border:2px solid var(--border)}
.security-link{display:block;padding:7px 10px;background:var(--card);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;color:var(--text);text-decoration:none;font-size:11px;transition:all .2s}
.security-link:hover{background:var(--card-hover);border-color:var(--accent2);color:var(--accent2)}
.dns-panel{position:fixed;top:38px;left:0;right:0;bottom:0;background:var(--panel);z-index:200;overflow-y:auto;display:none;padding:16px}
.dns-panel.visible{display:block}
.dns-panel h3{font-size:14px;color:var(--text-bright);margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
.dns-device-section{margin-bottom:16px;background:var(--card);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.dns-device-header{padding:8px 12px;background:var(--accent2-dim);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.dns-device-header:hover{background:var(--card-hover)}
.dns-device-header .dev-name{color:var(--text-bright);font-weight:600;font-size:12px}
.dns-device-header .dev-count{color:var(--accent2);font-size:10px}
.dns-domain-list{max-height:0;overflow:hidden;transition:max-height .3s}
.dns-domain-list.expanded{max-height:2000px}
.dns-domain-item{display:flex;justify-content:space-between;align-items:center;padding:4px 12px;border-bottom:1px solid var(--border);font-size:11px}
.dns-domain-item:last-child{border-bottom:none}
.dns-domain-item .domain{color:var(--text-bright);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dns-domain-item .count{color:var(--accent3);font-weight:600;min-width:30px;text-align:right}
.dns-domain-item .time{color:var(--muted);font-size:9px;min-width:50px;text-align:right;margin-left:8px}
.dns-filter{width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text-bright);font-size:12px;margin-bottom:12px;outline:none}
.dns-filter:focus{border-color:var(--accent2)}
.dns-stats{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.dns-stat-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px 12px;flex:1;min-width:100px;text-align:center}
.dns-stat-card .num{font-size:18px;font-weight:700;color:var(--accent2)}
.dns-stat-card .label{font-size:9px;color:var(--muted);margin-top:2px}
.bottom-panel{background:var(--panel);border-top:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column;min-height:120px;max-height:50vh}
.bottom-panel .drag-handle{height:6px;background:var(--border);cursor:ns-resize;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.bottom-panel .drag-handle::after{content:'';width:40px;height:2px;background:var(--muted);border-radius:1px}
.bottom-bar{display:flex;align-items:center;gap:8px;padding:4px 12px;border-bottom:1px solid var(--border);flex-shrink:0}
.bottom-bar input{flex:1;padding:4px 8px;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--text-bright);font-size:11px;outline:none}
.bottom-bar select{padding:4px 6px;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:10px}
.device-grid{flex:1;overflow-y:auto;padding:6px;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:4px}
.device-card{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:6px 8px;cursor:pointer;transition:all .2s;position:relative}
.device-card:hover{background:var(--card-hover);border-color:var(--accent2)}
.device-card .dc-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.device-card .dc-name{color:var(--text-bright);font-weight:600;font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:140px}
.device-card .dc-ip{color:var(--accent2);font-size:9px}
.device-card .dc-mid{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:3px}
.device-card .dc-badge{padding:1px 4px;border-radius:3px;font-size:8px;background:var(--accent2-dim);color:var(--accent2)}
.device-card .dc-badge.warn{background:rgba(255,152,0,0.15);color:var(--accent3)}
.device-card .dc-badge.ok{background:var(--accent-dim);color:var(--accent1)}
.device-card .dc-bw{display:flex;justify-content:space-between;font-size:9px}
.device-card .dc-bw .down{color:var(--accent1)}.device-card .dc-bw .up{color:var(--accent3)}
.device-card .dc-status{position:absolute;top:6px;right:8px;width:6px;height:6px;border-radius:50%}
.device-card .dc-status.online{background:var(--accent1);box-shadow:0 0 4px var(--accent1)}
.device-card .dc-status.offline{background:var(--red);opacity:.5}
.device-card .dc-spark{height:16px;margin-top:2px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:500;display:none;align-items:center;justify-content:center}
.modal-overlay.visible{display:flex}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:12px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto;padding:16px}
.modal h3{font-size:14px;color:var(--text-bright);margin-bottom:10px;display:flex;justify-content:space-between}
.modal .close-btn{cursor:pointer;font-size:18px;color:var(--muted)}
.modal .close-btn:hover{color:var(--text-bright)}
.modal-tabs{display:flex;gap:4px;margin-bottom:10px;border-bottom:1px solid var(--border);padding-bottom:6px}
.modal-tab{padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;color:var(--muted);transition:all .2s}
.modal-tab:hover{color:var(--text)}
.modal-tab.active{background:var(--accent2-dim);color:var(--accent2);font-weight:600}
.modal-content{font-size:11px}
.modal-content table{width:100%;border-collapse:collapse}
.modal-content th{text-align:left;padding:4px 6px;color:var(--muted);font-size:10px;border-bottom:1px solid var(--border)}
.modal-content td{padding:3px 6px;border-bottom:1px solid var(--border);color:var(--text)}
.btn-block{padding:4px 8px;border-radius:4px;border:1px solid var(--red);background:transparent;color:var(--red);font-size:10px;cursor:pointer}
.btn-block:hover{background:rgba(244,67,54,0.1)}
.btn-block.blocked{background:var(--red);color:#fff}
#clock{font-size:10px;color:var(--muted);font-family:monospace}
</style>
</head>
<body>
<div id="login-overlay">
<div class="login-box">
<h1>Netflow by Ealison</h1>
<p class="subtitle">OpenWrt Network Monitor v5.2</p>
<input type="password" id="login-pass" placeholder="Mot de passe root OpenWrt" autofocus>
<button onclick="doLogin()">Connexion</button>
<p class="error" id="login-error">Mot de passe incorrect</p>
</div>
</div>
<div id="app">
<div class="header">
<div class="header-left">
<h1>üåê Netflow</h1><span class="brand">by Ealison</span>
</div>
<div class="header-right">
<span id="clock"></span>
<div class="stat-pill"><div class="dot green"></div>WAN <span class="val" id="st-down">-</span></div>
<div class="stat-pill"><div class="dot orange"></div>UP <span class="val" id="st-up">-</span></div>
<div class="stat-pill"><div class="dot blue"></div>Devices <span class="val" id="st-dev">0</span></div>
<div class="stat-pill"><div class="dot red"></div>Alerts <span class="val" id="st-alert">0</span></div>
<button class="icon-btn" id="btn-dns" title="DNS History">üîç</button>
<button class="icon-btn" id="btn-alert" title="Alertes">üîî</button>
<button class="icon-btn" id="btn-security" title="S√©curit√© OpenWrt">üõ°Ô∏è</button>
<button class="icon-btn" id="btn-theme" title="Th√®me">üé®</button>
<button class="icon-btn" id="btn-fullscreen" title="Plein √©cran">‚õ∂</button>
</div>
</div>
<div class="main-area"><canvas id="canvas"></canvas></div>
<div id="alert-panel" class="panel-overlay">
<h3>üîî Alertes S√©curit√© <span class="close-btn" onclick="togglePanel('alert-panel')">&times;</span></h3>
<div id="alert-list"></div>
</div>
<div id="theme-panel" class="panel-overlay">
<h3>üé® Th√®me <span class="close-btn" onclick="togglePanel('theme-panel')">&times;</span></h3>
<div id="theme-list"></div>
</div>
<div id="security-panel" class="panel-overlay">
<h3>üõ°Ô∏è S√©curit√© OpenWrt <span class="close-btn" onclick="togglePanel('security-panel')">&times;</span></h3>
<a class="security-link" href="/cgi-bin/luci/admin/network/firewall" target="_blank">üî• Firewall - R√®gles</a>
<a class="security-link" href="/cgi-bin/luci/admin/network/firewall/rules" target="_blank">üìã Firewall - Traffic Rules</a>
<a class="security-link" href="/cgi-bin/luci/admin/network/firewall/forwards" target="_blank">üîÄ Port Forwarding</a>
<a class="security-link" href="/cgi-bin/luci/admin/network/dhcp" target="_blank">üì° DHCP / DNS</a>
<a class="security-link" href="/cgi-bin/luci/admin/network/wireless" target="_blank">üì∂ WiFi</a>
<a class="security-link" href="/cgi-bin/luci/admin/system/admin" target="_blank">üë§ Administration</a>
<a class="security-link" href="/cgi-bin/luci/admin/status/nftables" target="_blank">üß± NFTables</a>
<a class="security-link" href="/cgi-bin/luci/admin/network/routes" target="_blank">üó∫Ô∏è Routes</a>
<a class="security-link" href="/cgi-bin/luci/admin/status/logs" target="_blank">üìú System Log</a>
</div>
<div id="dns-panel" class="dns-panel">
<h3>üîç DNS History - Sites visit√©s par appareil <span class="close-btn" onclick="toggleDns()">&times;</span></h3>
<input class="dns-filter" id="dns-filter" placeholder="Filtrer par domaine ou IP...">
<div class="dns-stats" id="dns-stats"></div>
<div id="dns-content"></div>
</div>
<div class="bottom-panel" id="bottom-panel">
<div class="drag-handle" id="drag-handle"></div>
<div class="bottom-bar">
<input type="text" id="dev-search" placeholder="üîç Rechercher appareil...">
<select id="dev-sort" onchange="renderDevices()">
<option value="name">Nom</option><option value="ip">IP</option><option value="bw">Bande passante</option><option value="type">Interface</option><option value="status">Statut</option>
</select>
</div>
<div class="device-grid" id="device-grid"></div>
</div>
<div class="modal-overlay" id="modal-overlay">
<div class="modal" id="modal-content"></div>
</div>
</div>
<script>
let SID='',devices={},interfaces={},wanInfo={},alerts=[],dnsData={},sparkData={},globalSpark=[],connHistory={},customNames={},customTypes={},blockedDevs={},alertCooldown={};
const SENSITIVE_PORTS=[22,23,25,445,3389,5900,1433,3306,5432,8080,8443,9100];
const PORT_MAP={20:'FTP',21:'FTP',22:'SSH',23:'Telnet',25:'SMTP',53:'DNS',67:'DHCP',68:'DHCP',80:'HTTP',110:'POP3',123:'NTP',143:'IMAP',443:'HTTPS',445:'SMB',465:'SMTPS',514:'Syslog',587:'SMTP',636:'LDAPS',993:'IMAPS',995:'POP3S',1080:'SOCKS',1194:'OpenVPN',1433:'MSSQL',1883:'MQTT',3306:'MySQL',3389:'RDP',5060:'SIP',5222:'XMPP',5353:'mDNS',5432:'PostgreSQL',5900:'VNC',6379:'Redis',6881:'BitTorrent',8080:'HTTP-Alt',8443:'HTTPS-Alt',8883:'MQTTS',9100:'Print',9200:'Elastic',27017:'MongoDB',51820:'WireGuard'};
const SVC_CAT={Web:[80,443,8080,8443],Email:[25,110,143,465,587,993,995],DNS:[53,5353],File:[20,21,445,139],Remote:[22,23,3389,5900],Database:[1433,3306,5432,6379,9200,27017],IoT:[1883,5683,8883],VPN:[1194,51820,1723],Media:[554,1935,8554],Chat:[5222,5269]};

function doLogin(){
const p=document.getElementById('login-pass').value;
fetch('/ubus',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:1,method:'call',params:['00000000000000000000000000000000','session','login',{username:'root',password:p}]})})
.then(r=>r.json()).then(d=>{
if(d.result&&d.result[0]===0){SID=d.result[1].ubus_rpc_session;document.getElementById('login-overlay').classList.add('hidden');document.getElementById('app').classList.add('active');
try{customNames=JSON.parse(localStorage.getItem('nf_names')||'{}');customTypes=JSON.parse(localStorage.getItem('nf_types')||'{}');blockedDevs=JSON.parse(localStorage.getItem('nf_blocked')||'{}');}catch(e){}
startDashboard();}
else{document.getElementById('login-error').style.display='block';}
});
}
document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

function ubus(obj,method,params={}){
return fetch('/ubus',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:1,method:'call',params:[SID,obj,method,params]})}).then(r=>r.json()).then(d=>d.result?d.result[1]||d.result:null).catch(()=>null);
}

function togglePanel(id){
document.querySelectorAll('.panel-overlay').forEach(p=>{
if(p.id===id)p.classList.toggle('visible');
else p.classList.remove('visible');
});
document.querySelectorAll('.icon-btn').forEach(b=>b.classList.remove('active'));
const panel=document.getElementById(id);
if(panel&&panel.classList.contains('visible')){
const btnMap={'alert-panel':'btn-alert','theme-panel':'btn-theme','security-panel':'btn-security'};
const btn=document.getElementById(btnMap[id]);
if(btn)btn.classList.add('active');
}
}
function toggleDns(){
const p=document.getElementById('dns-panel');
p.classList.toggle('visible');
const btn=document.getElementById('btn-dns');
btn.classList.toggle('active',p.classList.contains('visible'));
if(p.classList.contains('visible'))fetchDnsLog();
}

document.getElementById('btn-alert').addEventListener('click',()=>togglePanel('alert-panel'));
document.getElementById('btn-theme').addEventListener('click',()=>togglePanel('theme-panel'));
document.getElementById('btn-security').addEventListener('click',()=>togglePanel('security-panel'));
document.getElementById('btn-dns').addEventListener('click',()=>toggleDns());
document.getElementById('btn-fullscreen').addEventListener('click',()=>{if(!document.fullscreenElement)document.documentElement.requestFullscreen();else document.exitFullscreen();});
document.getElementById('modal-overlay').addEventListener('click',e=>{if(e.target.id==='modal-overlay'){e.target.classList.remove('visible');}});
document.getElementById('dev-search').addEventListener('input',()=>renderDevices());
document.getElementById('dns-filter').addEventListener('input',()=>renderDnsPanel());

// DNS Log Fetching and Parsing
async function fetchDnsLog(){
try{
const r=await fetch('/cgi-bin/dnslog');
if(!r.ok)return;
const text=await r.text();
const lines=text.trim().split('\n').filter(l=>l.includes('query['));
dnsData={};
lines.forEach(line=>{
const m=line.match(/query\[(\w+)\]\s+(\S+)\s+from\s+(\S+)/);
if(!m)return;
const[,type,domain,ip]=m;
if(domain.endsWith('.in-addr.arpa'))return; // Skip reverse DNS
if(!dnsData[ip])dnsData[ip]={domains:{},total:0,types:{}};
if(!dnsData[ip].domains[domain])dnsData[ip].domains[domain]={count:0,type:type,last:''};
dnsData[ip].domains[domain].count++;
dnsData[ip].domains[domain].last=line.substring(0,24);
dnsData[ip].total++;
if(!dnsData[ip].types[type])dnsData[ip].types[type]=0;
dnsData[ip].types[type]++;
});
renderDnsPanel();
}catch(e){console.error('DNS fetch error:',e);}
}

function renderDnsPanel(){
const filter=(document.getElementById('dns-filter').value||'').toLowerCase();
const statsEl=document.getElementById('dns-stats');
const contentEl=document.getElementById('dns-content');
let totalQueries=0,totalDomains=new Set(),totalDevices=0;
Object.keys(dnsData).forEach(ip=>{
totalQueries+=dnsData[ip].total;
Object.keys(dnsData[ip].domains).forEach(d=>totalDomains.add(d));
totalDevices++;
});
statsEl.innerHTML=`
<div class="dns-stat-card"><div class="num">${totalDevices}</div><div class="label">Appareils</div></div>
<div class="dns-stat-card"><div class="num">${totalDomains.size}</div><div class="label">Domaines uniques</div></div>
<div class="dns-stat-card"><div class="num">${totalQueries}</div><div class="label">Requ√™tes DNS</div></div>
`;
let html='';
const sortedIps=Object.keys(dnsData).sort((a,b)=>dnsData[b].total-dnsData[a].total);
sortedIps.forEach(ip=>{
const dev=Object.values(devices).find(d=>d.ip===ip);
const name=dev?(customNames[dev.mac]||dev.hostname||dev.mac):ip;
const domains=Object.entries(dnsData[ip].domains)
.filter(([d])=>!filter||d.toLowerCase().includes(filter)||ip.includes(filter)||name.toLowerCase().includes(filter))
.sort((a,b)=>b[1].count-a[1].count);
if(domains.length===0&&filter)return;
html+=`<div class="dns-device-section">
<div class="dns-device-header" onclick="this.nextElementSibling.classList.toggle('expanded')">
<span class="dev-name">${name} (${ip})</span>
<span class="dev-count">${dnsData[ip].total} requ√™tes ‚Ä¢ ${Object.keys(dnsData[ip].domains).length} domaines</span>
</div>
<div class="dns-domain-list">`;
domains.slice(0,50).forEach(([domain,info])=>{
html+=`<div class="dns-domain-item">
<span class="domain" title="${domain}">${domain}</span>
<span class="count">${info.count}x</span>
<span class="time">${info.last.substring(11,19)||''}</span>
</div>`;
});
if(domains.length>50)html+=`<div class="dns-domain-item"><span class="domain" style="color:var(--muted)">... et ${domains.length-50} autres</span></div>`;
html+=`</div></div>`;
});
contentEl.innerHTML=html||'<p style="color:var(--muted);text-align:center;padding:20px">Aucune donn√©e DNS. Les requ√™tes appara√Ætront apr√®s quelques minutes.</p>';
}

// Theme setup
const themes=[
{name:'Cyber Dark',bg:'#060a14',panel:'rgba(14,28,50,0.95)',accent1:'#00e676',accent2:'#448aff'},
{name:'Matrix',bg:'#000a00',panel:'rgba(0,20,0,0.95)',accent1:'#00ff41',accent2:'#00c853'},
{name:'Midnight',bg:'#0a0a1a',panel:'rgba(15,15,35,0.95)',accent1:'#7c4dff',accent2:'#536dfe'},
{name:'Sunset',bg:'#1a0a0a',panel:'rgba(35,15,15,0.95)',accent1:'#ff6e40',accent2:'#ff3d00'},
{name:'Ocean',bg:'#001a1a',panel:'rgba(0,30,30,0.95)',accent1:'#00e5ff',accent2:'#0091ea'},
{name:'‚òÄÔ∏è Clair',light:true,bg:'#f0f2f5',panel:'rgba(255,255,255,0.97)',accent1:'#00a152',accent2:'#1565c0'}
];

function initThemes(){
const list=document.getElementById('theme-list');
list.innerHTML='';
themes.forEach((t,i)=>{
const opt=document.createElement('div');
opt.className='theme-option'+(i===0?' active':'');
opt.innerHTML=`<div class="theme-swatch" style="background:${t.bg};border-color:${t.accent2}"></div><span>${t.name}</span>`;
opt.onclick=()=>{applyTheme(t);list.querySelectorAll('.theme-option').forEach(o=>o.classList.remove('active'));opt.classList.add('active');};
list.appendChild(opt);
});
}

function applyTheme(t){
const r=document.documentElement.style;
if(t.light){document.body.classList.add('light');}else{document.body.classList.remove('light');
r.setProperty('--bg',t.bg);r.setProperty('--panel',t.panel);r.setProperty('--accent1',t.accent1);r.setProperty('--accent2',t.accent2);}
}

// Data fetching
async function fetchData(){
const[net,ct,board,wifi]=await Promise.all([
ubus('network.interface','dump'),
ubus('luci-rpc','getConntrackList'),
ubus('system','board'),
ubus('network.wireless','status')
]);
if(net&&net.interface){
interfaces={};
net.interface.forEach(iface=>{
interfaces[iface.interface]={up:iface.up,proto:iface.proto,device:iface.l3_device||iface.device,
ipv4:iface['ipv4-address']?iface['ipv4-address'].map(a=>a.address):[],
rx:iface.statistics?.rx_bytes||0,tx:iface.statistics?.tx_bytes||0};
if(iface.interface==='wan'){
wanInfo={up:iface.up,proto:iface.proto,ip:iface['ipv4-address']?.[0]?.address||'',
gw:iface.route?.find(r=>r.target==='0.0.0.0')?.nexthop||'',
rx:iface.statistics?.rx_bytes||0,tx:iface.statistics?.tx_bytes||0,
dns:iface['dns-server']||[],uptime:iface.uptime||0};
}
});
}
let connList=[];
if(ct){connList=Array.isArray(ct)?ct:(ct.result||[]);}
const devMap={};
const dhcp=await ubus('luci-rpc','getDHCPLeases');
if(dhcp){
const leases=Array.isArray(dhcp)?dhcp:(dhcp.dhcp_leases||dhcp.leases||[]);
leases.forEach(l=>{
const mac=l.macaddr?.toUpperCase()||'';
if(!mac)return;
devMap[mac]={mac,ip:l.ipaddr||'',hostname:l.hostname||'',iface:'lan',online:false,rx:0,tx:0,conns:[],prevRx:0,prevTx:0,bw_down:0,bw_up:0};
});
}
connList.forEach(c=>{
const src=c.src||'';const dst=c.dst||'';
const srcMac=Object.keys(devMap).find(m=>devMap[m].ip===src);
if(srcMac){
devMap[srcMac].online=true;
devMap[srcMac].conns.push({dst,dport:c.dport||0,sport:c.sport||0,proto:c.proto||'tcp',bytes:c.bytes||0});
devMap[srcMac].tx+=(c.bytes||0);
}
const dstMac=Object.keys(devMap).find(m=>devMap[m].ip===dst);
if(dstMac){devMap[dstMac].online=true;devMap[dstMac].rx+=(c.bytes||0);}
});
if(wifi){
Object.entries(wifi).forEach(([radio,info])=>{
if(info.interfaces){info.interfaces.forEach(iface=>{
if(iface.ifname&&iface.config){
const assocList=iface.assoclist||{};
Object.entries(assocList).forEach(([mac,sta])=>{
const um=mac.toUpperCase();
if(devMap[um]){
devMap[um].iface=iface.ifname;
devMap[um].signal=sta.signal||0;
devMap[um].noise=sta.noise||0;
devMap[um].online=true;
}
});
}});}
});
}
// Calculate bandwidth
Object.keys(devMap).forEach(mac=>{
const prev=devices[mac];
if(prev){
const dt=5;
devMap[mac].bw_down=Math.max(0,(devMap[mac].rx-prev.rx)/dt);
devMap[mac].bw_up=Math.max(0,(devMap[mac].tx-prev.tx)/dt);
}
if(!sparkData[mac])sparkData[mac]=[];
sparkData[mac].push({down:devMap[mac].bw_down,up:devMap[mac].bw_up,t:Date.now()});
if(sparkData[mac].length>60)sparkData[mac].shift();
});
devices=devMap;
const totalDown=Object.values(devices).reduce((s,d)=>s+d.bw_down,0);
const totalUp=Object.values(devices).reduce((s,d)=>s+d.bw_up,0);
globalSpark.push({down:totalDown,up:totalUp,t:Date.now()});
if(globalSpark.length>60)globalSpark.shift();
document.getElementById('st-down').textContent=fmtBw(totalDown);
document.getElementById('st-up').textContent=fmtBw(totalUp);
document.getElementById('st-dev').textContent=Object.values(devices).filter(d=>d.online).length;
checkAlerts();
renderDevices();
}

function fmtBw(bps){if(bps>1e6)return(bps/1e6).toFixed(1)+'M/s';if(bps>1e3)return(bps/1e3).toFixed(0)+'K/s';return bps.toFixed(0)+'B/s';}
function fmtBytes(b){if(b>1e9)return(b/1e9).toFixed(1)+'GB';if(b>1e6)return(b/1e6).toFixed(1)+'MB';if(b>1e3)return(b/1e3).toFixed(0)+'KB';return b+'B';}

// Alerts
function checkAlerts(){
const now=Date.now();
Object.values(devices).forEach(dev=>{
if(!dev.online)return;
const key=dev.mac;
if(alertCooldown[key]&&now-alertCooldown[key]<30000)return;
dev.conns.forEach(c=>{
const port=parseInt(c.dport);
if(SENSITIVE_PORTS.includes(port)){
addAlert('warn',`Port sensible ${port} (${PORT_MAP[port]||'?'})`,`${customNames[dev.mac]||dev.hostname||dev.ip} ‚Üí ${c.dst}:${port}`,key);
}
});
if(dev.bw_down>5e6||dev.bw_up>5e6){
addAlert('critical',`Trafic √©lev√©`,`${customNames[dev.mac]||dev.hostname||dev.ip}: ‚Üì${fmtBw(dev.bw_down)} ‚Üë${fmtBw(dev.bw_up)}`,key);
}
if(dev.conns.length>100){
addAlert('warn',`Connexions excessives (${dev.conns.length})`,`${customNames[dev.mac]||dev.hostname||dev.ip}`,key);
}
if(blockedDevs[dev.mac]&&dev.conns.length>0){
addAlert('critical',`Trafic malgr√© blocage!`,`${customNames[dev.mac]||dev.hostname||dev.ip} a ${dev.conns.length} connexions actives`,key);
}
});
document.getElementById('st-alert').textContent=alerts.length;
}
function addAlert(level,title,detail,devKey){
if(alertCooldown[devKey]&&Date.now()-alertCooldown[devKey]<30000)return;
alertCooldown[devKey]=Date.now();
const dup=alerts.find(a=>a.title===title&&a.detail===detail&&Date.now()-a.time<60000);
if(dup)return;
alerts.unshift({level,title,detail,time:Date.now()});
if(alerts.length>50)alerts.pop();
renderAlerts();
}
function renderAlerts(){
const list=document.getElementById('alert-list');
list.innerHTML=alerts.map(a=>`<div class="alert-card${a.level==='critical'?' alert-card-critical':''}">
<div class="alert-title">${a.level==='critical'?'üö®':'‚ö†Ô∏è'} ${a.title}</div>
<div class="alert-detail">${a.detail}</div>
<div style="font-size:9px;color:var(--muted);margin-top:2px">${new Date(a.time).toLocaleTimeString()}</div>
</div>`).join('')||'<p style="color:var(--muted);text-align:center;padding:20px">Aucune alerte</p>';
}

// Device rendering
function renderDevices(){
const grid=document.getElementById('device-grid');
const search=(document.getElementById('dev-search').value||'').toLowerCase();
const sort=document.getElementById('dev-sort').value;
let devList=Object.values(devices);
if(search)devList=devList.filter(d=>(customNames[d.mac]||d.hostname||d.mac).toLowerCase().includes(search)||d.ip.includes(search));
devList.sort((a,b)=>{
if(sort==='name')return(customNames[a.mac]||a.hostname||a.mac).localeCompare(customNames[b.mac]||b.hostname||b.mac);
if(sort==='ip')return(a.ip||'').localeCompare(b.ip||'',undefined,{numeric:true});
if(sort==='bw')return(b.bw_down+b.bw_up)-(a.bw_down+a.bw_up);
if(sort==='type')return(a.iface||'').localeCompare(b.iface||'');
if(sort==='status')return(b.online?1:0)-(a.online?1:0);
return 0;
});
grid.innerHTML=devList.map(d=>{
const name=customNames[d.mac]||d.hostname||d.mac;
const svcPorts=[...new Set(d.conns.map(c=>parseInt(c.dport)).filter(p=>PORT_MAP[p]))].slice(0,4);
const badges=svcPorts.map(p=>`<span class="dc-badge">${PORT_MAP[p]}</span>`).join('');
const ifBadge=`<span class="dc-badge${d.iface?.includes('ap')||d.iface?.includes('wlan')?' warn':' ok'}">${d.iface||'lan'}</span>`;
const sparkSvg=drawMiniSpark(sparkData[d.mac]||[]);
return `<div class="device-card" onclick="showDeviceModal('${d.mac}')">
<div class="dc-status ${d.online?'online':'offline'}"></div>
<div class="dc-top"><span class="dc-name" title="${name}">${name}</span><span class="dc-ip">${d.ip}</span></div>
<div class="dc-mid">${ifBadge}${badges}${blockedDevs[d.mac]?'<span class="dc-badge" style="background:rgba(244,67,54,0.2);color:var(--red)">BLOQU√â</span>':''}</div>
<div class="dc-bw"><span class="down">‚Üì${fmtBw(d.bw_down)}</span><span class="up">‚Üë${fmtBw(d.bw_up)}</span><span style="color:var(--muted)">${d.conns.length}cx</span></div>
<div class="dc-spark">${sparkSvg}</div>
</div>`;
}).join('');
}

function drawMiniSpark(data){
if(!data||data.length<2)return'';
const w=200,h=16,max=Math.max(...data.map(d=>Math.max(d.down,d.up)),1);
let pathD='',pathU='';
data.forEach((d,i)=>{const x=i/(data.length-1)*w;pathD+=`${i?'L':'M'}${x},${h-d.down/max*h}`;pathU+=`${i?'L':'M'}${x},${h-d.up/max*h}`;});
return `<svg viewBox="0 0 ${w} ${h}" style="width:100%;height:${h}px"><path d="${pathD}" fill="none" stroke="var(--accent1)" stroke-width="1" opacity="0.7"/><path d="${pathU}" fill="none" stroke="var(--accent3)" stroke-width="1" opacity="0.5"/></svg>`;
}

// Device Modal with DNS tab
function showDeviceModal(mac){
const d=devices[mac];if(!d)return;
const name=customNames[mac]||d.hostname||mac;
const devDns=dnsData[d.ip]||{domains:{},total:0,types:{}};
const dnsEntries=Object.entries(devDns.domains).sort((a,b)=>b[1].count-a[1].count);
const modal=document.getElementById('modal-content');
modal.innerHTML=`<h3>${name} <span class="close-btn" onclick="document.getElementById('modal-overlay').classList.remove('visible')">&times;</span></h3>
<div style="margin-bottom:8px;font-size:11px;color:var(--muted)">IP: ${d.ip} ‚Ä¢ MAC: ${mac} ‚Ä¢ Interface: ${d.iface||'lan'}${d.signal?' ‚Ä¢ Signal: '+d.signal+'dBm':''}</div>
<div class="modal-tabs">
<div class="modal-tab active" onclick="showModalTab(this,'tab-conn')">Connexions (${d.conns.length})</div>
<div class="modal-tab" onclick="showModalTab(this,'tab-dns')">DNS (${dnsEntries.length})</div>
<div class="modal-tab" onclick="showModalTab(this,'tab-actions')">Actions</div>
</div>
<div class="modal-content">
<div id="tab-conn">
<table><tr><th>Destination</th><th>Port</th><th>Service</th><th>Proto</th><th>Donn√©es</th></tr>
${d.conns.slice(0,50).map(c=>`<tr><td>${c.dst}</td><td>${c.dport}</td><td>${PORT_MAP[c.dport]||'-'}</td><td>${c.proto}</td><td>${fmtBytes(c.bytes)}</td></tr>`).join('')}
</table>
${d.conns.length>50?'<p style="color:var(--muted);margin-top:4px">... et '+(d.conns.length-50)+' autres</p>':''}
</div>
<div id="tab-dns" style="display:none">
${dnsEntries.length>0?`<table><tr><th>Domaine</th><th>Type</th><th>Requ√™tes</th><th>Derni√®re</th></tr>
${dnsEntries.slice(0,100).map(([domain,info])=>`<tr><td style="color:var(--text-bright)">${domain}</td><td>${info.type}</td><td style="color:var(--accent3);font-weight:600">${info.count}</td><td style="font-size:9px">${info.last.substring(11,19)||''}</td></tr>`).join('')}
</table>`:'<p style="color:var(--muted);text-align:center;padding:20px">Aucune donn√©e DNS pour cet appareil</p>'}
</div>
<div id="tab-actions" style="display:none">
<div style="display:flex;flex-direction:column;gap:8px;padding:8px">
<div style="display:flex;gap:8px;align-items:center">
<label style="color:var(--text);min-width:80px">Nom:</label>
<input id="edit-name" value="${customNames[mac]||''}" placeholder="${d.hostname||mac}" style="flex:1;padding:4px 8px;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--text-bright);font-size:11px">
<button onclick="customNames['${mac}']=document.getElementById('edit-name').value;localStorage.setItem('nf_names',JSON.stringify(customNames));renderDevices();" style="padding:4px 8px;background:var(--accent2-dim);border:1px solid var(--accent2);border-radius:4px;color:var(--accent2);font-size:10px;cursor:pointer">OK</button>
</div>
<div style="display:flex;gap:8px;align-items:center">
<label style="color:var(--text);min-width:80px">Type:</label>
<select id="edit-type" onchange="customTypes['${mac}']=this.value;localStorage.setItem('nf_types',JSON.stringify(customTypes));" style="flex:1;padding:4px 8px;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px">
<option value="">Auto</option><option value="pc"${customTypes[mac]==='pc'?' selected':''}>üíª PC</option><option value="phone"${customTypes[mac]==='phone'?' selected':''}>üì± T√©l√©phone</option>
<option value="tablet"${customTypes[mac]==='tablet'?' selected':''}>üì± Tablette</option><option value="tv"${customTypes[mac]==='tv'?' selected':''}>üì∫ TV</option>
<option value="iot"${customTypes[mac]==='iot'?' selected':''}>üîå IoT</option><option value="printer"${customTypes[mac]==='printer'?' selected':''}>üñ®Ô∏è Imprimante</option>
<option value="server"${customTypes[mac]==='server'?' selected':''}>üñ•Ô∏è Serveur</option><option value="camera"${customTypes[mac]==='camera'?' selected':''}>üì∑ Cam√©ra</option>
</select>
</div>
<button class="btn-block${blockedDevs[mac]?' blocked':''}" onclick="toggleBlock('${mac}','${d.ip}')">
${blockedDevs[mac]?'üîì D√©bloquer le trafic':'üîí Bloquer le trafic'}
</button>
</div>
</div>
</div>`;
document.getElementById('modal-overlay').classList.add('visible');
}

function showModalTab(el,tabId){
el.parentElement.querySelectorAll('.modal-tab').forEach(t=>t.classList.remove('active'));
el.classList.add('active');
const content=el.closest('.modal').querySelector('.modal-content');
content.querySelectorAll('[id^="tab-"]').forEach(t=>t.style.display='none');
document.getElementById(tabId).style.display='block';
}

async function toggleBlock(mac,ip){
if(blockedDevs[mac]){
await ubus('uci','delete',{config:'firewall',section:'nf_block_'+mac.replace(/:/g,'')});
await ubus('uci','commit',{config:'firewall'});
delete blockedDevs[mac];
}else{
await ubus('uci','add',{config:'firewall',type:'rule',name:'nf_block_'+mac.replace(/:/g,''),values:{src:'lan',src_mac:mac,dest:'wan',target:'REJECT',name:'Netflow Block '+mac}});
await ubus('uci','commit',{config:'firewall'});
blockedDevs[mac]=true;
}
localStorage.setItem('nf_blocked',JSON.stringify(blockedDevs));
showDeviceModal(mac);
}

// Canvas animation
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
let particles=[];
function resizeCanvas(){canvas.width=canvas.parentElement.clientWidth;canvas.height=canvas.parentElement.clientHeight;}
window.addEventListener('resize',resizeCanvas);

function drawTopology(){
const W=canvas.width,H=canvas.height;
ctx.clearRect(0,0,W,H);
const cx=W/2,nodeR=6;
// WAN node
const wanX=80,wanY=H/2;
ctx.fillStyle=wanInfo.up?'var(--accent1)':'var(--red)';
ctx.beginPath();ctx.arc(wanX,wanY,nodeR+2,0,Math.PI*2);ctx.fill();
ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--text-bright');
ctx.font='10px system-ui';ctx.textAlign='center';ctx.fillText('WAN',wanX,wanY-14);
ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--muted');
ctx.font='8px system-ui';ctx.fillText(wanInfo.ip||'',wanX,wanY+18);
// Router node
const rtrX=W*0.3,rtrY=H/2;
ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--accent2');
ctx.beginPath();ctx.arc(rtrX,rtrY,nodeR+4,0,Math.PI*2);ctx.fill();
ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--text-bright');
ctx.font='bold 10px system-ui';ctx.fillText('OpenWrt',rtrX,rtrY-18);
ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--muted');
ctx.font='8px system-ui';ctx.fillText('192.168.10.1',rtrX,rtrY+22);
// WAN-Router link
drawLink(wanX,wanY,rtrX,rtrY,wanInfo.up?getComputedStyle(document.body).getPropertyValue('--accent1'):'#333',2);
// Interfaces
const ifaceNames=Object.keys(interfaces).filter(n=>n!=='loopback'&&n!=='wan'&&n!=='wan6');
const ifaceX=W*0.55;
ifaceNames.forEach((name,i)=>{
const y=H*0.2+i*(H*0.6/(ifaceNames.length||1));
const iface=interfaces[name];
ctx.fillStyle=iface?.up?getComputedStyle(document.body).getPropertyValue('--accent2'):'#555';
ctx.beginPath();ctx.arc(ifaceX,y,nodeR,0,Math.PI*2);ctx.fill();
ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--text');
ctx.font='9px system-ui';ctx.textAlign='center';ctx.fillText(name,ifaceX,y-12);
drawLink(rtrX,rtrY,ifaceX,y,getComputedStyle(document.body).getPropertyValue('--accent2'),1);
// Devices connected to this interface
const devs=Object.values(devices).filter(d=>{
const iName=d.iface||'lan';
return iName===name||name==='lan';
});
const devX=W*0.78;
const devSpacing=Math.min(24,H*0.8/Math.max(devs.length,1));
const startY=y-devs.length*devSpacing/2;
devs.forEach((d,j)=>{
const dy=startY+j*devSpacing;
if(dy<10||dy>H-10)return;
const col=d.online?getComputedStyle(document.body).getPropertyValue('--accent1'):'#444';
ctx.fillStyle=col;
ctx.beginPath();ctx.arc(devX,dy,3,0,Math.PI*2);ctx.fill();
ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--text');
ctx.font='8px system-ui';ctx.textAlign='left';
const dname=(customNames[d.mac]||d.hostname||d.ip).substring(0,18);
ctx.fillText(dname,devX+8,dy+3);
const bw=d.bw_down+d.bw_up;
const lw=Math.max(0.5,Math.min(3,bw/1e5));
drawLink(ifaceX,y,devX,dy,col,lw);
// Particles
if(d.online&&Math.random()<0.1){
const speed=0.005+Math.random()*0.01;
if(d.bw_down>0)particles.push({x1:ifaceX,y1:y,x2:devX,y2:dy,t:0,speed,color:getComputedStyle(document.body).getPropertyValue('--accent1')});
if(d.bw_up>0)particles.push({x1:devX,y1:dy,x2:ifaceX,y2:y,t:0,speed,color:getComputedStyle(document.body).getPropertyValue('--accent3')});
}
});
});
// WAN particles
if(wanInfo.up&&Math.random()<0.15){
particles.push({x1:wanX,y1:wanY,x2:rtrX,y2:rtrY,t:0,speed:0.008+Math.random()*0.01,color:getComputedStyle(document.body).getPropertyValue('--accent1')});
particles.push({x1:rtrX,y1:rtrY,x2:wanX,y2:wanY,t:0,speed:0.006+Math.random()*0.008,color:getComputedStyle(document.body).getPropertyValue('--accent3')});
}
// Draw particles
particles.forEach(p=>{
p.t+=p.speed;
const px=p.x1+(p.x2-p.x1)*p.t;
const py=p.y1+(p.y2-p.y1)*p.t;
ctx.fillStyle=p.color;
ctx.globalAlpha=1-p.t;
ctx.beginPath();ctx.arc(px,py,2,0,Math.PI*2);ctx.fill();
ctx.globalAlpha=1;
});
particles=particles.filter(p=>p.t<1);
if(particles.length>200)particles=particles.slice(-150);
}

function drawLink(x1,y1,x2,y2,color,width){
ctx.strokeStyle=color;ctx.lineWidth=width;ctx.globalAlpha=0.3;
ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();
ctx.globalAlpha=1;
}

// Drag handle for bottom panel
(function(){
const handle=document.getElementById('drag-handle');
const panel=document.getElementById('bottom-panel');
let dragging=false,startY,startH;
handle.addEventListener('mousedown',e=>{dragging=true;startY=e.clientY;startH=panel.offsetHeight;e.preventDefault();});
window.addEventListener('mousemove',e=>{if(!dragging)return;const dh=startY-e.clientY;panel.style.height=Math.max(80,Math.min(window.innerHeight*0.6,startH+dh))+'px';resizeCanvas();});
window.addEventListener('mouseup',()=>{dragging=false;});
})();

// Clock
function updateClock(){document.getElementById('clock').textContent=new Date().toLocaleTimeString();}

// Main loop
function startDashboard(){
resizeCanvas();
initThemes();
renderAlerts();
fetchData();
fetchDnsLog();
setInterval(fetchData,5000);
setInterval(fetchDnsLog,30000);
setInterval(updateClock,1000);
updateClock();
function animate(){drawTopology();requestAnimationFrame(animate);}
animate();
}
</script>
</body>
</html>
